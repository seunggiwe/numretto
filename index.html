<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NUMLETTO â€” æ•°å­—ä¸¦ã¹å¯¾æˆ¦ã‚²ãƒ¼ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0d0d0d; --surface:#161616; --panel:#1e1e1e; --border:#2a2a2a;
    --accent:#e8d44d; --accent2:#e05c4b; --text:#e8e8e8; --muted:#555;
    --face-down:#1a2a3a; --face-down-border:#2a4a6a;
    --revealed:#f5f0e8; --revealed-text:#0d0d0d;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:'Roboto Mono',monospace;min-height:100vh;display:flex;flex-direction:column;}

  /* â”€â”€ HEADER â”€â”€ */
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;}
  .logo{font-family:'Bebas Neue',cursive;font-size:1.8rem;letter-spacing:4px;color:var(--accent);}
  .logo span{color:var(--accent2);}
  .status-bar{display:flex;gap:16px;align-items:center;font-size:0.7rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
  .turn-indicator{background:var(--accent);color:#000;padding:3px 10px;border-radius:2px;font-weight:600;font-size:0.7rem;}

  .game-wrap{display:flex;flex-direction:column;flex:1;}

  /* â”€â”€ PLAYER ZONES â”€â”€ */
  .player-zone{padding:14px 24px 12px;border-bottom:1px solid var(--border);transition:background 0.3s;}
  .player-zone.active-player{background:linear-gradient(90deg,rgba(232,212,77,0.06) 0%,transparent 70%);border-left:3px solid var(--accent);}
  .player-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap;}
  .player-name{font-family:'Bebas Neue',cursive;font-size:1.1rem;letter-spacing:3px;color:var(--muted);}
  .active-player .player-name{color:var(--accent);}
  .player-progress{font-size:0.62rem;color:var(--muted);}
  .progress-bar-wrap{height:3px;background:var(--border);border-radius:2px;width:100px;overflow:hidden;}
  .progress-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.4s;}
  .badge{display:inline-block;font-size:0.58rem;font-weight:700;padding:2px 7px;border-radius:2px;letter-spacing:1px;}
  .badge-yellow{background:var(--accent);color:#000;}
  .badge-red{background:var(--accent2);color:#fff;}
  .badge-muted{border:1px solid var(--border);color:var(--muted);}

  .tile-row{display:flex;flex-wrap:wrap;gap:4px;align-items:center;}

  /* â”€â”€ TILES â”€â”€ */
  .tile{
    width:48px;height:60px;border-radius:5px;
    display:flex;align-items:center;justify-content:center;
    font-weight:600;font-size:1rem;cursor:default;
    transition:transform 0.12s,box-shadow 0.12s,border-color 0.1s;
    user-select:none;border:2px solid transparent;letter-spacing:-0.5px;
    position:relative;
  }
  .tile.face-down{
    background:var(--face-down);border-color:var(--face-down-border);color:transparent;
    background-image:repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(255,255,255,0.02) 4px,rgba(255,255,255,0.02) 5px);
  }
  .tile.face-up{background:var(--revealed);border-color:#c8c0a8;color:var(--revealed-text);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
  .tile.selectable{cursor:pointer;border-color:#3a6a9a !important;}
  .tile.selectable:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(58,106,154,0.4);border-color:#5a9aca !important;}
  .tile.selected{border-color:var(--accent) !important;box-shadow:0 0 0 3px rgba(232,212,77,0.4) !important;transform:translateY(-6px) !important;}
  .tile.invalid-flash{animation:flash-red 0.4s ease;}
  @keyframes flash-red{0%,100%{border-color:var(--accent2);}50%{background:rgba(224,92,75,0.15);}}

  /* é€†ã•ã¾è¡¨ç¤º */
  .tile.flipped { transform: rotate(180deg) !important; }
  .tile.flipped:hover { transform: rotate(180deg) translateY(-4px) !important; }
  /* ç½®ã‘ãªã„ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰æ¨ã¦å ´ã‚¿ã‚¤ãƒ« */
  .tile.unplaceable { opacity:0.35; cursor:not-allowed !important; filter:grayscale(0.5); }
  .tile.unplaceable:hover { transform:none !important; box-shadow:none !important; border-color:#c8c0a8 !important; }
  /* æ‰‹æœ­ã‚¨ãƒªã‚¢å†…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
  .player-action-bar { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .btn-sm { font-family:'Roboto Mono',monospace; font-size:0.65rem; letter-spacing:0.5px; text-transform:uppercase;
    padding:5px 12px; border-radius:3px; border:1px solid var(--border); cursor:pointer;
    transition:all 0.15s; background:transparent; color:var(--text); }
  .btn-sm:hover:not(:disabled) { border-color:var(--accent); color:var(--accent); }
  .btn-sm:disabled { opacity:0.3; cursor:not-allowed; }
  .btn-sm.accent { border-color:var(--accent2); color:var(--accent2); }
  .btn-sm.accent:hover:not(:disabled) { background:rgba(224,92,75,0.1); }
  /* ã²ã£ãã‚Šè¿”ã™ãƒœã‚¿ãƒ³ï¼ˆãƒãƒŠãƒ¼å†…ï¼‰ */
  .flip-btn { font-family:'Roboto Mono',monospace; font-size:0.65rem; letter-spacing:0.5px; text-transform:uppercase;
    padding:5px 14px; border-radius:3px; border:1px solid rgba(232,212,77,0.4); cursor:pointer;
    transition:all 0.15s; background:rgba(232,212,77,0.08); color:var(--accent); }
  .flip-btn:hover { background:rgba(232,212,77,0.2); border-color:var(--accent); }

  /* Setup orange tiles */
  .tile.to-place{background:#241800;border-color:#7a4800;color:#e8b040;cursor:pointer;}
  .tile.to-place:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 6px 16px rgba(232,180,40,0.35);}
  .tile.to-place.src-selected{border-color:var(--accent) !important;box-shadow:0 0 0 3px rgba(232,212,77,0.5) !important;transform:translateY(-8px) !important;background:#342200;}

  /* Gap slot */
  .gap-slot{width:14px;height:60px;border-radius:4px;border:2px dashed transparent;cursor:default;display:flex;align-items:center;justify-content:center;transition:all 0.12s;flex-shrink:0;font-size:0.9rem;color:transparent;}
  .gap-slot.droppable{border-color:transparent;background:transparent;cursor:pointer;color:var(--accent);}
  .gap-slot.droppable:hover{color:#fff;transform:scale(1.3);}

  /* ã‚¿ã‚¤ãƒ«å·®ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡ */
  @keyframes tile-insert{
    0%  {transform:translateY(-28px) scale(0.85);opacity:0;}
    60% {transform:translateY(4px) scale(1.06);opacity:1;}
    100%{transform:translateY(0) scale(1);opacity:1;}
  }
  .tile.just-inserted{
    animation:tile-insert 0.28s cubic-bezier(0.22,1,0.36,1) forwards;
  }
  /* è£ã‚¿ã‚¤ãƒ«äº¤æ›ã‚¢ãƒ‹ãƒ¡ï¼ˆå‡ºã¦ã„ãå´ï¼‰ */
  @keyframes tile-out{
    0%  {transform:translateY(0) scale(1);opacity:1;}
    100%{transform:translateY(20px) scale(0.7);opacity:0;}
  }
  .tile.just-swapped-out{
    animation:tile-out 0.22s ease forwards;
  }
  /* è£ã‚¿ã‚¤ãƒ«äº¤æ›ã‚¢ãƒ‹ãƒ¡ï¼ˆå…¥ã£ã¦ãã‚‹å´ï¼‰ */
  @keyframes tile-in{
    0%  {transform:translateY(-20px) scale(0.7);opacity:0;}
    100%{transform:translateY(0) scale(1);opacity:1;}
  }
  .tile.just-swapped-in{
    animation:tile-in 0.25s cubic-bezier(0.22,1,0.36,1) forwards;
  }
  /* é€£ç•ªéš£æ¥ã‚¹ãƒ­ãƒƒãƒˆ â€” å·®ã—è¾¼ã¿ç¦æ­¢ */
  .gap-slot.blocked{
    width:8px;cursor:not-allowed;
    background:repeating-linear-gradient(45deg,rgba(224,92,75,0.12),rgba(224,92,75,0.12) 2px,transparent 2px,transparent 5px);
    border-color:rgba(224,92,75,0.25);
    color:transparent;
  }

  /* Setup panel */
  .setup-panel{margin-top:12px;padding-top:10px;border-top:1px solid var(--border);}
  .setup-panel-label{font-size:0.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
  .reveal-hand{display:flex;gap:8px;flex-wrap:wrap;}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CENTER ZONE â€” Pool spread + Discard
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .center-zone{
    background:var(--panel);
    border-top:1px solid var(--border);border-bottom:1px solid var(--border);
    padding:16px 24px;
    display:flex;flex-direction:column;gap:14px;
  }

  /* Pool spread row */
  .pool-section{}
  .pool-label-row{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
  .center-label{font-size:0.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);}
  .pool-count-badge{
    font-size:0.6rem;color:var(--muted);border:1px solid var(--border);
    padding:1px 7px;border-radius:10px;letter-spacing:1px;
  }
  .pool-grid{
    display:flex;flex-wrap:wrap;gap:4px;
    max-height:200px;overflow-y:auto;
    padding:4px 0;
  }
  /* Pool tiles: face-down but clickable */
  .tile.pool-tile{cursor:pointer;border-color:var(--face-down-border);}
  .tile.pool-tile:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(42,74,106,0.6);border-color:#4a8aba;}
  /* Pool tile that has been selected (flipping) */
  .tile.pool-tile.flipping{
    animation:flipCard 0.35s ease forwards;
    pointer-events:none;
  }
  @keyframes flipCard{
    0%  {transform:rotateY(0deg)   translateY(0);}
    50% {transform:rotateY(90deg)  translateY(-8px);}
    100%{transform:rotateY(0deg)   translateY(-8px);border-color:var(--accent);box-shadow:0 0 16px rgba(232,212,77,0.5);}
  }

  /* â”€â”€ DRAWN CARD BANNER â”€â”€ */
  .drawn-banner{
    display:flex;align-items:center;gap:16px;
    background:rgba(232,212,77,0.07);
    border:1px solid rgba(232,212,77,0.2);
    border-radius:6px;
    padding:10px 18px;
    margin-bottom:4px;
  }
  .drawn-banner.hidden{display:none;}
  .drawn-card-display{
    width:56px;height:70px;border-radius:6px;
    background:var(--revealed);border:2px solid var(--accent);
    color:var(--revealed-text);
    display:flex;align-items:center;justify-content:center;
    font-size:1.4rem;font-weight:700;letter-spacing:-1px;
    box-shadow:0 0 16px rgba(232,212,77,0.35);
    flex-shrink:0;
  }
  .drawn-banner-text{display:flex;flex-direction:column;gap:4px;}
  .drawn-banner-title{font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--accent);}
  .drawn-banner-sub{font-size:0.72rem;color:var(--text);}
  .drawn-banner-rev{font-size:0.62rem;color:var(--muted);}

  /* â”€â”€ DISCARD ZONE â”€â”€ */
  .discard-section{}
  .discard-scroll{display:flex;flex-wrap:wrap;gap:6px;max-height:180px;overflow-y:auto;padding:2px 0;}
  /* Discard tile with attribution */
  .discard-entry{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;}
  .discard-entry .tile{cursor:pointer;}
  .discard-entry .tile:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 6px 16px rgba(232,212,77,0.3);}
  .discard-who{font-size:0.52rem;color:var(--muted);letter-spacing:0.5px;max-width:48px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  /* NEW label on freshly discarded tile */
  .discard-entry .new-dot{
    position:absolute;top:-4px;right:-4px;
    width:10px;height:10px;border-radius:50%;
    background:var(--accent2);
    border:2px solid var(--panel);
    animation:blink 1s ease infinite;
  }
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}

  /* â”€â”€ ACTION PANEL â”€â”€ */
  .action-panel{padding:12px 24px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);background:var(--surface);min-height:54px;}
  .action-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);min-width:70px;}
  .btn{font-family:'Roboto Mono',monospace;font-size:0.7rem;letter-spacing:1px;text-transform:uppercase;padding:7px 14px;border-radius:3px;border:1px solid var(--border);cursor:pointer;transition:all 0.15s;background:transparent;color:var(--text);}
  .btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent);}
  .btn.primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600;}
  .btn.primary:hover:not(:disabled){background:#f0e060;}
  .btn:disabled{opacity:0.3;cursor:not-allowed;}
  .btn.danger{border-color:var(--accent2);color:var(--accent2);}
  .btn.danger:hover:not(:disabled){background:rgba(224,92,75,0.1);}

  .phase-hint{font-size:0.67rem;color:var(--accent);letter-spacing:0.4px;padding:8px 24px;background:rgba(232,212,77,0.04);border-bottom:1px solid rgba(232,212,77,0.07);min-height:32px;}

  /* â”€â”€ LOG (top-fixed, 4 lines) â”€â”€ */
  .log-wrap{
    padding:6px 24px;
    background:var(--surface);
    border-bottom:1px solid var(--border);
    overflow:hidden;
    flex-shrink:0;
  }
  .log-entry{font-size:0.63rem;color:var(--muted);padding:1px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .log-entry.highlight{color:var(--accent);}
  .log-entry.error{color:var(--accent2);}
  .log-entry .ts{color:#333;margin-right:8px;}

  /* â”€â”€ OVERLAYS â”€â”€ */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.87);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px);overflow-y:auto;}
  .overlay.hidden{display:none;}
  .overlay-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:40px 50px;text-align:center;max-width:480px;width:90%;}
  .overlay-card h1{font-family:'Bebas Neue',cursive;font-size:3.5rem;letter-spacing:6px;color:var(--accent);margin-bottom:8px;}
  .overlay-card p{color:var(--muted);font-size:0.8rem;line-height:1.8;margin-bottom:22px;}
  .overlay-card .subtitle{font-family:'Bebas Neue',cursive;font-size:1.1rem;letter-spacing:3px;color:var(--text);margin-bottom:18px;}
  .setup-options{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
  .setup-row{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .setup-row label{font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);}
  .setup-row select,.setup-row input{background:var(--panel);border:1px solid var(--border);color:var(--text);font-family:'Roboto Mono',monospace;font-size:0.7rem;padding:6px 10px;border-radius:3px;}
  .win-stats{display:flex;gap:28px;justify-content:center;margin-bottom:20px;}
  .win-stat .val{font-family:'Bebas Neue',cursive;font-size:2.5rem;color:var(--accent);line-height:1;}
  .win-stat .lbl{font-size:0.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-top:4px;}

  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

  /* â”€â”€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ â”€â”€ */
  .version-badge{
    font-family:'Roboto Mono',monospace;
    font-size:0.58rem;letter-spacing:1px;
    color:var(--muted);cursor:pointer;
    border:1px solid var(--border);
    border-radius:3px;padding:2px 7px;
    transition:all 0.15s;
    text-decoration:none;display:inline-block;
  }
  .version-badge:hover{border-color:var(--accent);color:var(--accent);}

  /* â”€â”€ ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
  #changelogOverlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.88);
    display:flex;align-items:center;justify-content:center;
    z-index:500;backdrop-filter:blur(4px);
    opacity:0;pointer-events:none;transition:opacity 0.18s;
  }
  #changelogOverlay.show{opacity:1;pointer-events:all;}
  #changelogCard{
    background:var(--surface);border:1px solid var(--border);
    border-radius:8px;padding:32px 36px;
    max-width:480px;width:92%;max-height:80vh;
    overflow-y:auto;
  }
  #changelogCard h2{
    font-family:'Bebas Neue',cursive;font-size:1.8rem;
    letter-spacing:4px;color:var(--accent);margin-bottom:20px;
  }
  .cl-version{margin-bottom:22px;}
  .cl-version-head{
    display:flex;align-items:baseline;gap:10px;margin-bottom:8px;
  }
  .cl-ver-num{
    font-family:'Bebas Neue',cursive;font-size:1.1rem;
    letter-spacing:2px;color:var(--text);
  }
  .cl-ver-date{font-size:0.58rem;color:var(--muted);letter-spacing:1px;}
  .cl-ver-current{
    font-size:0.55rem;background:var(--accent);color:#000;
    padding:1px 6px;border-radius:2px;font-weight:700;letter-spacing:1px;
  }
  .cl-items{list-style:none;display:flex;flex-direction:column;gap:5px;}
  .cl-items li{
    font-size:0.68rem;color:var(--muted);padding-left:14px;position:relative;line-height:1.6;
  }
  .cl-items li::before{content:'â€”';position:absolute;left:0;color:var(--border);}
  .cl-items li.highlight{color:var(--text);}
  .cl-items li.highlight::before{content:'âœ¦';color:var(--accent);}
  #changelogClose{
    width:100%;margin-top:20px;
    font-family:'Roboto Mono',monospace;font-size:0.68rem;
    letter-spacing:2px;text-transform:uppercase;
    padding:9px;border-radius:3px;
    border:1px solid var(--border);cursor:pointer;
    background:transparent;color:var(--muted);transition:all 0.15s;
  }
  #changelogClose:hover{border-color:var(--accent);color:var(--accent);}

  /* â”€â”€ ç½®ã‘ã‚‹ä½ç½®ãƒã‚¤ãƒ©ã‚¤ãƒˆ â”€â”€ */
  .tile.can-place{
    border-color:#3a8a5a !important;
    box-shadow:0 0 8px rgba(58,180,100,0.35) !important;
    cursor:pointer;
  }
  .tile.can-place:hover{
    transform:translateY(-4px) !important;
    box-shadow:0 6px 18px rgba(58,180,100,0.55) !important;
    border-color:#5adc80 !important;
  }
  .tile.cannot-place{
    opacity:0.3;
    filter:grayscale(0.6);
  }

  /* â”€â”€ é€£ç•ªé”æˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ â”€â”€ */
  @keyframes bonus-glow{
    0%  {box-shadow:0 0 0 0 rgba(232,212,77,0.9);transform:translateY(-2px);}
    40% {box-shadow:0 0 0 12px rgba(232,212,77,0);transform:translateY(-8px);}
    60% {box-shadow:0 0 0 20px rgba(232,212,77,0);transform:translateY(-4px);}
    100%{box-shadow:0 0 0 0 rgba(232,212,77,0);transform:translateY(0);}
  }
  .tile.bonus-flash{
    animation:bonus-glow 0.7s ease forwards !important;
    border-color:var(--accent) !important;
    background:#fff8dc !important;
    color:#000 !important;
    z-index:10;
  }

  /* â”€â”€ ã‚¿ãƒ¼ãƒ³ç§»è¡ŒãƒãƒŠãƒ¼ â”€â”€ */
  #turnBanner{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.7);
    background:rgba(13,13,13,0.93);border:2px solid var(--accent);
    border-radius:8px;padding:18px 48px;z-index:300;
    font-family:'Bebas Neue',cursive;font-size:2.2rem;letter-spacing:6px;
    color:var(--accent);text-align:center;pointer-events:none;
    opacity:0;transition:opacity 0.15s,transform 0.15s;
  }
  #turnBanner.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
  #turnBanner small{display:block;font-family:'Roboto Mono',monospace;font-size:0.6rem;letter-spacing:3px;color:var(--muted);margin-top:4px;}

  /* â”€â”€ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ â”€â”€ */
  #particles{position:fixed;inset:0;pointer-events:none;z-index:290;overflow:hidden;}
  .particle{
    position:absolute;width:6px;height:6px;border-radius:50%;
    animation:particle-fall linear forwards;
  }
  @keyframes particle-fall{
    0%  {opacity:1;transform:translate(0,0) scale(1);}
    100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0.2);}
  }

  /* â”€â”€ LOBBY â”€â”€ */
  .lobby-player{
    display:flex;align-items:center;gap:10px;
    padding:8px 12px;border-radius:4px;
    background:var(--panel);border:1px solid var(--border);
    font-size:0.75rem;
  }
  .lobby-player.is-me{border-color:var(--accent);}
  .lobby-player .lp-name{flex:1;letter-spacing:1px;}
  .lobby-player .lp-host{
    font-size:0.55rem;background:var(--accent);color:#000;
    padding:2px 6px;border-radius:2px;font-weight:700;letter-spacing:1px;
  }
  .lobby-player .lp-you{
    font-size:0.55rem;border:1px solid var(--accent);color:var(--accent);
    padding:2px 6px;border-radius:2px;letter-spacing:1px;
  }
</style>
</head>
<body>

<!-- TITLE: æ¥ç¶šç”»é¢ -->
<div class="overlay" id="titleOverlay">
  <div class="overlay-card" style="max-width:400px;">
    <h1>NUMLETTO</h1>
    <p style="margin-bottom:24px;">1ã€œ100ã®ã‚¿ã‚¤ãƒ«ã‚’æ˜‡é †ã«ä¸¦ã¹ã‚ã€‚<br>æˆ¦ç•¥ã¨é‹ãŒäº¤å·®ã™ã‚‹æ•°å­—ã®æ ¼é—˜æŠ€ã€‚</p>
    <div class="setup-options" style="gap:12px;">
      <div class="setup-row">
        <label>å å‰</label>
        <input type="text" id="myNameInput" placeholder="ã‚ãªãŸã®åå‰" maxlength="12"
          style="font-size:0.85rem;padding:10px 12px;"
          onkeydown="if(event.key==='Enter')connectAction()">
      </div>
      <div class="setup-row">
        <label>åˆè¨€è‘‰</label>
        <input type="text" id="roomIdInput" placeholder="ãƒ«ãƒ¼ãƒ åˆè¨€è‘‰"
          style="text-transform:uppercase;font-size:0.85rem;padding:10px 12px;"
          onkeydown="if(event.key==='Enter')connectAction()">
      </div>
    </div>
    <p style="font-size:0.6rem;color:var(--muted);margin:10px 0 16px;">åŒã˜åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ãŸäººãŒåŒã˜éƒ¨å±‹ã«é›†ã¾ã‚Šã¾ã™</p>
    <button class="btn primary" id="btnConnect" onclick="connectAction()"
      style="width:100%;padding:12px;font-size:0.8rem;letter-spacing:2px;">ENTER ROOM</button>
    <p id="connectError" style="font-size:0.65rem;color:var(--accent2);margin-top:8px;min-height:16px;"></p>
    <div style="text-align:center;margin-top:12px;">
      <span class="version-badge" onclick="openChangelog()">v0.0.0</span>
    </div>
  </div>
</div>

<!-- LOBBY: å¾…åˆå®¤ -->
<div class="overlay hidden" id="lobbyOverlay">
  <div class="overlay-card" style="max-width:400px;">
    <h1>NUMLETTO</h1>
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:6px;">
      <span class="subtitle" id="lobbyRoomLabel" style="margin-bottom:0;">ROOM: â€”</span>
    </div>
    <p style="color:var(--muted);font-size:0.68rem;margin-bottom:16px;">å‚åŠ è€…ãŒæƒã£ãŸã‚‰ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
    <div id="lobbyPlayerList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;min-height:60px;"></div>
    <button class="btn primary" id="btnStartGame" onclick="hostStartGame()"
      style="width:100%;padding:12px;font-size:0.8rem;letter-spacing:2px;display:none;">GAME START</button>
    <p id="lobbyWaitMsg" style="font-size:0.65rem;color:var(--muted);margin-top:4px;"></p>
    <button class="btn" onclick="leaveLobby()"
      style="width:100%;padding:8px;font-size:0.68rem;margin-top:10px;border-color:#444;color:#666;">â† é€€å‡ºã™ã‚‹</button>
  </div>
</div>

<!-- RESULT -->
<div class="overlay hidden" id="resultOverlay">
  <div class="overlay-card" style="max-width:540px;padding:28px 32px;">
    <div id="resultContent"></div>
  </div>
</div>

<!-- ã‚¿ãƒ¼ãƒ³ç§»è¡ŒãƒãƒŠãƒ¼ -->
<div id="turnBanner"><span id="turnBannerName">â€”</span><small>YOUR TURN</small></div>

<!-- ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚° -->
<div id="changelogOverlay" onclick="if(event.target===this)closeChangelog()">
  <div id="changelogCard">
    <h2>CHANGELOG</h2>
    <div id="changelogContent"></div>
    <button id="changelogClose" onclick="closeChangelog()">CLOSE</button>
  </div>
</div>
<!-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
<div id="particles"></div>

<header>
  <div class="logo"><span style="color:var(--accent)">NUM</span><span style="color:var(--accent2)">LETTO</span></div>
  <div class="status-bar">
    <span id="hdrTurn" class="turn-indicator">SETUP</span>
    <span id="hdrRound">â€”</span>
    <span id="hdrPool">POOL: â€”</span>
    <label style="display:flex;align-items:center;gap:6px;font-size:0.6rem;color:var(--muted);cursor:pointer;">
      <span id="volIcon" style="font-size:0.85rem;">ğŸ”Š</span>
      <input type="range" id="volSlider" min="0" max="1" step="0.05" value="0.7"
        oninput="setVolume(this.value)"
        style="width:64px;accent-color:var(--accent);cursor:pointer;">
    </label>
    <button class="btn" onclick="location.reload()" style="padding:3px 9px;font-size:0.62rem;">â†º NEW</button>
    <span class="version-badge" onclick="openChangelog()" id="hdrVersion">v0.0.0</span>
  </div>
</header>

<!-- LOG: 4 lines fixed under header -->
<div class="log-wrap" id="logWrap"></div>

<div class="game-wrap" id="gameWrap">

  <!-- CENTER ZONE (hidden during setup) -->
  <div class="center-zone" id="centerZone" style="display:none">

    <!-- â‘  å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ -->
    <div class="drawn-banner hidden" id="drawnBanner">
      <div class="drawn-card-display" id="drawnCardDisplay">â€”</div>
      <div class="drawn-banner-text">
        <div class="drawn-banner-title">âœ¦ å¼•ã„ãŸã‚¿ã‚¤ãƒ«</div>
        <div class="drawn-banner-sub" id="drawnBannerSub">â€”</div>
        <div class="drawn-banner-rev" id="drawnBannerRev"></div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
          <button class="flip-btn" id="btnFlipDrawn" onclick="flipDrawnTile()" style="display:none;">âŸ³ ã²ã£ãã‚Šè¿”ã™</button>
          <button class="flip-btn" id="btnCannotPlace" onclick="cannotPlace()" style="display:none;border-color:rgba(224,92,75,0.5);color:var(--accent2);background:rgba(224,92,75,0.06);">æ¨ã¦ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- â‘¡ å±±æœ­ï¼ˆå…¨å±•é–‹ï¼‰ -->
    <div class="pool-section">
      <div class="pool-label-row">
        <span class="center-label">å±± æœ­</span>
        <span class="pool-count-badge" id="poolCountBadge">â€” æš</span>
        <span style="font-size:0.58rem;color:var(--muted);">è£å‘ãã®ã‚¿ã‚¤ãƒ«ã‹ã‚‰1æšé¸ã‚“ã§å¼•ã</span>
      </div>
      <div class="pool-grid" id="poolGrid"></div>
    </div>

    <!-- â‘¢ æ¨ã¦å ´ -->
    <div class="discard-section">
      <div class="pool-label-row">
        <span class="center-label">æ¨ã¦å ´</span>
        <span style="font-size:0.58rem;color:var(--muted);">æ¨ã¦ã‚‰ã‚ŒãŸã‚¿ã‚¤ãƒ«ï¼ˆè£å‘ãï¼‰â€” ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ãã£ã¦å–å¾—</span>
      </div>
      <div class="discard-scroll" id="discardScroll"></div>
    </div>

  </div>

  <!-- ACTION PANEL: hint + ç½®ã‘ãªã„ãƒœã‚¿ãƒ³ã®ã¿ -->
  <div class="action-panel" id="actionPanel" style="display:none">
    <span class="action-label">ACTION</span>
    <span id="actionHint" style="font-size:0.67rem;color:var(--muted);"></span>
  </div>

  <div class="phase-hint" id="phaseHint" style="display:none"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONLINE: WebSocket (PartyKit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PARTYKIT_URL = 'https://numeretto-server.seunggiwe.partykit.dev';
let ws = null;
let myName = '';
let myConnId = null;
let amIHost = false;
let currentRoomId = '';
let intentionalClose = false; // æ„å›³çš„åˆ‡æ–­ãƒ•ãƒ©ã‚°
let reconnectTimer = null;
let heartbeatTimer = null;
let reconnectAttempt = 0; // ãƒãƒƒã‚¯ã‚ªãƒ•ç”¨ã‚«ã‚¦ãƒ³ã‚¿

// ã€Œæ¥ç¶šã™ã‚‹ã€ãƒœã‚¿ãƒ³
function connectAction(){
  const name = document.getElementById('myNameInput').value.trim();
  const room = document.getElementById('roomIdInput').value.trim().toUpperCase();
  const errEl = document.getElementById('connectError');
  if(!name){ errEl.textContent='åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  if(!room){ errEl.textContent='åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  errEl.textContent='';
  myName = name;
  currentRoomId = room;
  document.getElementById('btnConnect').disabled = true;
  document.getElementById('btnConnect').textContent = 'CONNECTINGâ€¦';
  connectToRoom(room);
}

// å¾…åˆå®¤ã‹ã‚‰é€€å‡º
function leaveLobby(){
  intentionalClose=true;
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
  if(reconnectTimer){ clearTimeout(reconnectTimer); reconnectTimer=null; }
  if(ws){ ws.close(); ws=null; }
  myName=''; currentRoomId=''; amIHost=false;
  document.getElementById('lobbyOverlay').classList.add('hidden');
  document.getElementById('titleOverlay').classList.remove('hidden');
  document.getElementById('btnConnect').disabled=false;
  document.getElementById('btnConnect').textContent='ENTER ROOM';
}

function connectToRoom(roomId) {
  intentionalClose = false;
  if(reconnectTimer){ clearTimeout(reconnectTimer); reconnectTimer=null; }
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
  if(ws){ intentionalClose=true; ws.close(); ws=null; }
  intentionalClose = false;
  ws = new WebSocket(`${PARTYKIT_URL}/party/${roomId}`);

  ws.onopen = () => {
    const isReconnect = !!G;
    ws.send(JSON.stringify({ type: 'join', name: myName, reconnect: isReconnect }));
    // Heartbeat: 5ç§’ã”ã¨ã«pingã§ã‚¢ã‚¤ãƒ‰ãƒ«åˆ‡æ–­é˜²æ­¢
    heartbeatTimer = setInterval(()=>{
      if(ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 5000);
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    // å¾…åˆå®¤æƒ…å ±
    if(msg.type === 'lobby'){
      // ã‚²ãƒ¼ãƒ ä¸­ã«å†æ¥ç¶šã—ã¦lobbyãŒè¿”ã£ã¦ããŸå ´åˆã¯resyncã‚’è¦æ±‚
      if(G && !msg.hasGame){
        // ã‚µãƒ¼ãƒãƒ¼å´ã®GãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã—ã¾ã£ãŸç¨€ãªã‚±ãƒ¼ã‚¹ â†’ ç”»é¢ã‚’å¾…åˆå®¤ã«æˆ»ã™
        showLobby(msg.players, roomId);
      } else if(G && msg.hasGame){
        // ã‚²ãƒ¼ãƒ ç¶™ç¶šä¸­ â†’ ã‚µãƒ¼ãƒãƒ¼ã«resyncè¦æ±‚
        ws.send(JSON.stringify({ type: 'resync' }));
      } else {
        showLobby(msg.players, roomId);
      }
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹ / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åŒæœŸ
    if(msg.type === 'sync'){
      if(ws) ws._attempt = 0; reconnectAttempt = 0; // å†æ¥ç¶šæˆåŠŸã§ãƒãƒƒã‚¯ã‚ªãƒ•ãƒªã‚»ãƒƒãƒˆ
      const prevAct = act;
      const prevPlayer = G ? G.currentPlayer : -1;
      G = msg.G;
      const inSetup = G.playerSetups && G.playerSetups.some(s=>!s.done);
      setupPhase = inSetup ? true : null;
      const newAct = G.act || null;

      // ä»–äººã®æ“ä½œã«ã‚ˆã‚‹SEåˆ¤å®šï¼ˆè‡ªåˆ†ã®æ“ä½œã¯æ—¢ã«é³´ã‚‰ã—ã¦ã„ã‚‹ï¼‰
      const isOtherPlayer = myName && G.players[G.currentPlayer] && G.players[G.currentPlayer].name !== myName;
      if(isOtherPlayer){
        if(!prevAct && newAct && newAct.phase==='awaitSwap') playSound('draw');
        else if(prevAct && !newAct && prevPlayer===G.currentPlayer) playSound('place');
        else if(prevAct && !newAct && prevPlayer!==G.currentPlayer) playSound('place');
        else if(!prevAct && !newAct && prevPlayer !== G.currentPlayer) {/* ã‚¿ãƒ¼ãƒ³å¤‰åŒ– */}
      }

      act = newAct;

      // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹SEï¼ˆã‚¿ãƒ¼ãƒ³ãŒè‡ªåˆ†ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸç¬é–“ï¼‰
      const myPi = myName ? G.players.findIndex(p=>p.name===myName) : -1;
      if(myPi>=0 && !inSetup && !G.gameOver){
        if(prevPlayer !== G.currentPlayer && G.currentPlayer === myPi){
          playSound('myturn');
          showTurnBanner(G.players[myPi].name);
        }
      }

      document.getElementById('titleOverlay').classList.add('hidden');
      document.getElementById('lobbyOverlay').classList.add('hidden');
      document.getElementById('centerZone').style.display = inSetup ? 'none' : '';
      document.getElementById('actionPanel').style.display = inSetup ? 'none' : '';
      document.getElementById('phaseHint').style.display = '';
      document.getElementById('hdrPool').textContent = `ROOM: ${currentRoomId}`;
      // ãƒªã‚¶ãƒ«ãƒˆåŒæœŸï¼šG.resultãŒã‚ã‚Œã°å…¨å“¡ã«ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã‚’è¡¨ç¤º
      if(G.result){
        openResult();
      } else {
        document.getElementById('resultOverlay').classList.add('hidden');
      }
      render();
    }

    // ãƒªã‚»ãƒƒãƒˆ
    if(msg.type === 'reset'){
      G = null; setupPhase = null; act = null;
      document.getElementById('lobbyOverlay').classList.remove('hidden');
    }
  };

  ws.onerror = () => {
    // onerrorã¯å¸¸ã«oncloseã®ç›´å‰ã«ç™ºç«ã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
    // å‡¦ç†ã¯oncloseã«ä¸€å…ƒåŒ–ã™ã‚‹
  };
  ws.onclose = (e) => {
    if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
    if(intentionalClose){ intentionalClose=false; return; }

    if(!myName || !currentRoomId){
      // æ¥ç¶šå‰ã®ã‚¨ãƒ©ãƒ¼ï¼ˆåˆè¨€è‘‰å…¥åŠ›ç”»é¢ï¼‰
      const errEl = document.getElementById('connectError');
      if(errEl) errEl.textContent = 'æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      document.getElementById('btnConnect').disabled = false;
      document.getElementById('btnConnect').textContent = 'ENTER ROOM';
      return;
    }

    // ã‚²ãƒ¼ãƒ ä¸­/å¾…åˆå®¤ä¸­ â†’ è‡ªå‹•å†æ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãï¼‰
    reconnectAttempt++;
    let delay = reconnectAttempt > 3 ? 8000 : reconnectAttempt > 1 ? 4000 : 2000;

    log(`æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚${delay/1000}ç§’å¾Œã«å†æ¥ç¶šâ€¦ (${reconnectAttempt}å›ç›®)`, 'error');
    reconnectTimer = setTimeout(()=>{
      connectToRoom(currentRoomId);
    }, delay);
  };
  return ws;
}

function showLobby(players, roomId){
  // ã‚¿ã‚¤ãƒˆãƒ«â†’å¾…åˆå®¤ã¸
  document.getElementById('titleOverlay').classList.add('hidden');
  document.getElementById('lobbyOverlay').classList.remove('hidden');
  document.getElementById('lobbyRoomLabel').textContent = `â€” åˆè¨€è‘‰: ${roomId} â€”`;

  // è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆã‹ï¼ˆplayersé…åˆ—ã®å…ˆé ­ãŒãƒ›ã‚¹ãƒˆï¼‰
  amIHost = players.length > 0 && players[0].isHost && players[0].name === myName;

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæç”»
  const list = document.getElementById('lobbyPlayerList');
  list.innerHTML = '';
  players.forEach(p => {
    const isMe = p.name === myName;
    const div = document.createElement('div');
    div.className = `lobby-player${isMe?' is-me':''}`;
    div.innerHTML = `
      <span class="lp-name">${p.name}</span>
      ${p.isHost ? '<span class="lp-host">HOST</span>' : ''}
      ${isMe ? '<span class="lp-you">YOU</span>' : ''}`;
    list.appendChild(div);
  });

  // ãƒ›ã‚¹ãƒˆã«ã ã‘ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  const btnStart = document.getElementById('btnStartGame');
  const waitMsg = document.getElementById('lobbyWaitMsg');
  if(amIHost){
    btnStart.style.display = '';
    btnStart.textContent = `ã‚²ãƒ¼ãƒ é–‹å§‹ (${players.length}äºº) â†’`;
    btnStart.disabled = players.length < 2;
    waitMsg.style.display = 'none';
  } else {
    btnStart.style.display = 'none';
    waitMsg.style.display = '';
  }
}

// ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ é–‹å§‹
function hostStartGame(){
  if(!amIHost || !ws) return;

  // å¾…åˆå®¤ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰åå‰ã‚’å–å¾—ã—ã¦Gç”Ÿæˆï¼ˆé †ç•ªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
  const items = document.getElementById('lobbyPlayerList').querySelectorAll('.lp-name');
  const names = shuffle([...items].map(el => el.textContent.trim()));
  const count = names.length;

  const nums = shuffle([...Array(100)].map((_,i)=>i+1));
  let idx = 0;
  const HAND_BLIND = getHandBlind(count);
  const HAND_REVEAL = getHandReveal(count);
  const players = [];
  for(let p = 0; p < count; p++){
    const hand = nums.slice(idx, idx+HAND_BLIND).map(n=>({tile:makeTile(n),revealed:false}));
    idx += HAND_BLIND;
    const revealTiles = nums.slice(idx, idx+HAND_REVEAL).map(makeTile);
    idx += HAND_REVEAL;
    revealTiles.sort((a,b)=>a.num-b.num);
    players.push({name:names[p],hand,revealTiles,revealTilesTotal:revealTiles.length,turns:0,progressHistory:[[0,0]]});
  }
  // playerSetups: å…¨å“¡åŒæ™‚ã«æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€²ã‚ã‚‹
  const playerSetups = players.map(()=>({
    currentRevealIdx:0, selectedInHand:false, useRev:false, done:false
  }));
  act = null;
  G = {
    players, currentPlayer:0,
    pool:nums.slice(idx).map(makeTile),
    discard:[], round:1, gameOver:false,
    handSize:HAND_BLIND+HAND_REVEAL,
    playerSetups,  // å…¨å“¡åˆ†ã®æº–å‚™çŠ¶æ…‹
  };
  act = null;

  ws.send(JSON.stringify({ type: 'start', G }));
}

function syncToServer(type='action'){
  if(ws && ws.readyState === WebSocket.OPEN){
    // actã‚’Gã«åŸ‹ã‚è¾¼ã‚“ã§ã‹ã‚‰é€ä¿¡
    G.act = act || null;
    ws.send(JSON.stringify({type, G}));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND ENGINE (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC = null; // åˆå›æ“ä½œæ™‚ã«åˆæœŸåŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®Autoplay Policyå¯¾ç­–ï¼‰
let masterVolume = 0.7;
function ensureAC(){
  if(!AC){try{AC=new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  if(AC&&AC.state==='suspended') AC.resume();
}

function setVolume(v){
  masterVolume = parseFloat(v);
  const icon = document.getElementById('volIcon');
  if(icon) icon.textContent = masterVolume === 0 ? 'ğŸ”‡' : masterVolume < 0.4 ? 'ğŸ”‰' : 'ğŸ”Š';
}

function playSound(type){
  ensureAC();
  if(!AC) return;
  const t = AC.currentTime;

  const sounds = {
    draw: ()=>{
      // ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹éŸ³: ãƒã‚¤ã‚ºãƒãƒ¼ã‚¹ãƒˆ + çŸ­ã„ãƒ”ãƒƒãƒä¸Šæ˜‡
      const buf = AC.createBuffer(1, AC.sampleRate*0.08, AC.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2);
      const src = AC.createBufferSource();
      src.buffer = buf;
      const g = AC.createGain(); g.gain.setValueAtTime(0.18*masterVolume,t);
      src.connect(g); g.connect(AC.destination); src.start(t);
      // é«˜ã‚ã®ãƒ”ãƒƒãƒ
      const osc = AC.createOscillator();
      const og = AC.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(800,t); osc.frequency.linearRampToValueAtTime(1200,t+0.06);
      og.gain.setValueAtTime(0.12*masterVolume,t); og.gain.linearRampToValueAtTime(0,t+0.08);
      osc.connect(og); og.connect(AC.destination); osc.start(t); osc.stop(t+0.08);
    },
    place: ()=>{
      // ã‚¿ã‚¤ãƒ«ã‚’ç½®ãéŸ³: ã‚³ãƒ„ãƒƒã¨ã„ã†æ‰“æ’ƒéŸ³
      const osc = AC.createOscillator();
      const g = AC.createGain();
      osc.type='triangle'; osc.frequency.setValueAtTime(300,t); osc.frequency.exponentialRampToValueAtTime(80,t+0.12);
      g.gain.setValueAtTime(0.25*masterVolume,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
      osc.connect(g); g.connect(AC.destination); osc.start(t); osc.stop(t+0.13);
    },
    bonus: ()=>{
      // é€£ç•ªãƒœãƒ¼ãƒŠã‚¹: ä¸Šæ˜‡ã‚¢ãƒ«ãƒšã‚¸ã‚ª
      [523,659,784,1047].forEach((freq,i)=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sine'; osc.frequency.value=freq;
        const st=t+i*0.08;
        g.gain.setValueAtTime(0,st); g.gain.linearRampToValueAtTime(0.18*masterVolume,st+0.02);
        g.gain.linearRampToValueAtTime(0,st+0.1);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.12);
      });
    },
    discard: ()=>{
      // æ¨ã¦ã‚‹: ä½ã‚ã®ã‚·ãƒ¥ãƒƒã¨ã„ã†éŸ³
      const buf = AC.createBuffer(1, AC.sampleRate*0.1, AC.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5)*0.5;
      const src=AC.createBufferSource(); src.buffer=buf;
      const g=AC.createGain(); g.gain.setValueAtTime(0.12*masterVolume,t);
      const filt=AC.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=600;
      src.connect(filt); filt.connect(g); g.connect(AC.destination); src.start(t);
    },
    error: ()=>{
      // ã‚¨ãƒ©ãƒ¼: ä½ã„ãƒ–ã‚¶ãƒ¼2å›
      [0,0.12].forEach(delay=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sawtooth'; osc.frequency.value=120;
        const st=t+delay;
        g.gain.setValueAtTime(0.15*masterVolume,st); g.gain.linearRampToValueAtTime(0,st+0.08);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.09);
      });
    },
    win: ()=>{
      // å‹åˆ©: ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
      const melody=[523,523,523,659,523,659,784];
      const times=[0,0.18,0.36,0.54,0.72,0.82,0.92];
      melody.forEach((freq,i)=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='square'; osc.frequency.value=freq;
        const st=t+times[i];
        g.gain.setValueAtTime(0,st); g.gain.linearRampToValueAtTime(0.15*masterVolume,st+0.02);
        g.gain.linearRampToValueAtTime(0,st+0.15);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.16);
      });
    },
    myturn: ()=>{
      // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹: çŸ­ã„ä¸Šæ˜‡2éŸ³
      [[523,0],[784,0.1]].forEach(([freq,delay])=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sine'; osc.frequency.value=freq;
        const st=t+delay;
        g.gain.setValueAtTime(0,st); g.gain.linearRampToValueAtTime(0.2*masterVolume,st+0.015);
        g.gain.linearRampToValueAtTime(0,st+0.1);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.11);
      });
    },
  };
  if(sounds[type]) sounds[type]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äººæ•°åˆ¥é…å¸ƒæšæ•°
function getHandBlind(count)  { return count <= 4 ? 17 : count === 5 ? 14 : 11; }
function getHandReveal(count) { return count <= 4 ? 5 : 4; }
function getHandSize(count)   { return getHandBlind(count) + getHandReveal(count); }

let G          = null;
let setupPhase = null;
let act        = null;
let insertAnim = null; // {pi, hi} å·®ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡å¯¾è±¡
let swapAnim   = null; // {pi, hi} ã‚¹ãƒ¯ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡å¯¾è±¡

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRev(n) {
  // 1ã®ä½ãŒ0 â†’ é€†ã•ã«ã™ã‚‹ã¨å…ˆé ­0ã«ãªã‚‹ãŸã‚ç„¡åŠ¹
  if(n % 10 === 0) return null;
  const map={'0':'0','1':'1','6':'9','8':'8','9':'6'};
  const s=String(n);
  for(const c of s) if(!(c in map)) return null;
  const r=parseInt(s.split('').reverse().map(c=>map[c]).join(''));
  return r!==n?r:null;
}
function makeTile(n){return{num:n,rev:calcRev(n)};}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function ts(){const n=new Date();return`${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;}
function log(msg,cls=''){
  const lw=document.getElementById('logWrap');if(!lw)return;
  const d=document.createElement('div');d.className=`log-entry ${cls}`;
  d.innerHTML=`<span class="ts">${ts()}</span>${msg}`;
  // prepend so newest is at top
  lw.insertBefore(d,lw.firstChild);
  while(lw.children.length>4)lw.removeChild(lw.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME START (ãƒ›ã‚¹ãƒˆã®ã¿ hostStartGame() ã§å®Ÿè¡Œ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MASTER RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const inSetup=G&&G.playerSetups&&G.playerSetups.some(s=>!s.done);
  if(inSetup){setupPhase=true;renderSetup();}else{setupPhase=null;renderGame();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSetup(){
  document.getElementById('centerZone').style.display='none';
  document.getElementById('actionPanel').style.display='none';
  document.getElementById('phaseHint').style.display='';
  clearPlayerZones();

  // è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
  const myPi = myName ? G.players.findIndex(p=>p.name===myName) : 0;

  G.players.forEach((player,pi)=>{
    const sp = G.playerSetups[pi];
    const isMe = pi===myPi;
    const isDone = sp.done;
    const div=document.createElement('div');
    div.className=`player-zone${isMe?' active-player':''}`;

    let badge;
    if(isDone) badge=`<span class="badge badge-yellow">é…ç½®å®Œäº† âœ“</span>`;
    else if(isMe) badge=`<span class="badge badge-red">é…ç½®ä¸­ â€” ${sp.currentRevealIdx+1}æšç›® / ${player.revealTilesTotal}æš</span>`;
    else badge=`<span class="badge badge-muted">é…ç½®ä¸­â€¦</span>`;

    div.innerHTML=`
      <div class="player-header"><span class="player-name">${player.name}</span>${badge}</div>
      <div class="tile-row" id="tileRow${pi}"></div>
      ${isMe&&!isDone?`<div class="setup-panel">
        <div class="setup-panel-label">ä»Šé…ç½®ã™ã‚‹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ â†’ â†“ã‚¹ãƒ­ãƒƒãƒˆã«å·®ã—è¾¼ã‚€ï¼‰ï¼š</div>
        <div class="reveal-hand" id="revealHand${pi}"></div>
      </div>`:''}`;
    insertPlayerZone(div);

    // æ‰‹æœ­è¡¨ç¤ºï¼ˆgap slotã¤ãï¼‰
    const tileRow=div.querySelector(`#tileRow${pi}`);
    const showG=isMe&&!isDone&&sp.selectedInHand;
    for(let i=0;i<=player.hand.length;i++){
      const g=document.createElement('div');
      g.className=`gap-slot${showG?' droppable':''}`;
      g.textContent=showG?'â†“':'';
      if(showG){const gi=i;g.onclick=()=>insertRevealTile(pi,gi);}
      tileRow.appendChild(g);
      if(i<player.hand.length){
        const h=player.hand[i];
        const el=document.createElement('div');
        el.className=`tile ${h.revealed?'face-up':'face-down'}`;
        el.textContent=h.revealed?h.tile.num:'';
        if(insertAnim && insertAnim.pi===pi && insertAnim.hi===i){
          el.classList.add('just-inserted');
          insertAnim=null;
        }
        tileRow.appendChild(el);
      }
    }

    // è‡ªåˆ†ã®æ“ä½œãƒ‘ãƒãƒ«
    if(isMe&&!isDone){
      const curTile=player.revealTiles[sp.currentRevealIdx];
      const rh=div.querySelector(`#revealHand${pi}`);
      const useRev=sp.useRev===true;
      const displayNum=useRev&&curTile.rev?curTile.rev:curTile.num;
      const el=document.createElement('div');
      el.className=`tile face-up to-place${sp.selectedInHand?' src-selected':''}`;
      el.textContent=displayNum;
      el.title=curTile.rev?`é€†ã•ã§ä½¿ç”¨: ${curTile.rev}`:'';
      el.onclick=()=>{ ensureAC(); sp.selectedInHand=!sp.selectedInHand; syncToServer(); render(); };
      rh.appendChild(el);
      if(curTile.rev){
        const fb=document.createElement('button');
        fb.className='flip-btn';fb.style.marginLeft='8px';
        fb.textContent=useRev?`âŸ³ æ­£å‘ã (${curTile.num})`:`âŸ³ ã²ã£ãã‚Šè¿”ã™ (â†’${curTile.rev})`;
        fb.onclick=(e)=>{e.stopPropagation();ensureAC();sp.useRev=!sp.useRev;syncToServer();render();};
        rh.appendChild(fb);
      }
    }
  });

  const myPl=G.players[myPi];
  const mySp=G.playerSetups[myPi];
  const ph=document.getElementById('phaseHint');
  if(mySp.done){
    ph.textContent='âœ… ã‚ãªãŸã®é…ç½®ã¯å®Œäº†ã€‚ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦';
  }else{
    const cur=myPl.revealTiles[mySp.currentRevealIdx];
    ph.textContent=mySp.selectedInHand
      ?`ğŸ“Œ [${mySp.useRev&&cur.rev?cur.rev:cur.num}] ã‚’é¸æŠä¸­ã€‚â†“ ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å·®ã—è¾¼ã‚“ã§ãã ã•ã„ã€‚`
      :`ğŸ“Œ ã‚ªãƒ¬ãƒ³ã‚¸ã®ã‚¿ã‚¤ãƒ« [${cur.num}] ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚`;
  }
  const doneCount=G.playerSetups.filter(s=>s.done).length;
  document.getElementById('hdrTurn').textContent='SETUP';
  document.getElementById('hdrRound').textContent=`æº–å‚™å®Œäº† ${doneCount}/${G.players.length}äºº`;
  document.getElementById('hdrPool').textContent=`POOL: ${G.pool.length}`;
}

function insertRevealTile(pi, gapIdx){
  if(!G||!G.playerSetups)return;
  const sp=G.playerSetups[pi];
  if(!sp||!sp.selectedInHand||sp.done)return;
  if(myName && G.players[pi].name !== myName)return;

  const player=G.players[pi];
  const rawTile=player.revealTiles[sp.currentRevealIdx];
  const useRev=sp.useRev===true&&rawTile.rev!=null;
  const tile=useRev?{num:rawTile.rev,rev:rawTile.num}:rawTile;

  // â”€â”€ æ˜‡é †ãƒã‚§ãƒƒã‚¯: gapã®å·¦å³ã®è¡¨ã‚¿ã‚¤ãƒ«ã¨å¤§å°æ¯”è¼ƒ â”€â”€
  const hand=player.hand;
  let L=-Infinity, R=Infinity;
  for(let i=gapIdx-1;i>=0;i--){if(hand[i].revealed){L=hand[i].tile.num;break;}}
  for(let i=gapIdx;i<hand.length;i++){if(hand[i].revealed){R=hand[i].tile.num;break;}}
  if(tile.num<=L||tile.num>=R){
    playSound('error');
    log(`[${tile.num}] ã¯ã“ã“ã«ç½®ã‘ã¾ã›ã‚“ï¼ˆæ˜‡é †: ${L===- Infinity?'â€”':L} < ? < ${R===Infinity?'â€”':R}ï¼‰`,'error');
    return;
  }

  player.hand.splice(gapIdx,0,{tile,revealed:true});
  sp.selectedInHand=false;
  sp.useRev=false;
  insertAnim={pi, hi:gapIdx};
  playSound('place');
  log(`${player.name}: [${tile.num}] ã‚’ä½ç½® ${gapIdx+1} ã«æŒ¿å…¥ã€‚`);
  sp.currentRevealIdx++;
  if(sp.currentRevealIdx>=player.revealTilesTotal){
    delete player.revealTiles;
    sp.done=true;
    log(`${player.name} ã®é…ç½®å®Œäº†ï¼`,'highlight');
  }

  // å…¨å“¡å®Œäº†ãƒã‚§ãƒƒã‚¯
  if(G.playerSetups.every(s=>s.done)){
    delete G.playerSetups;
    setupPhase=null;
    G.currentPlayer=0;G.round=1;
    document.getElementById('actionPanel').style.display='';
    document.getElementById('centerZone').style.display='';
    log('å…¨å“¡ã®é…ç½®å®Œäº†ï¼ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼','highlight');
    syncToServer();
    render();return;
  }
  syncToServer();
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN GAME RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(){
  const cp=G.currentPlayer;
  document.getElementById('centerZone').style.display='';
  clearPlayerZones();

  // Player zones
  G.players.forEach((player,pi)=>{
    const isActive=pi===cp&&!G.gameOver;
    const div=document.createElement('div');
    div.className=`player-zone${isActive?' active-player':''}`;
    const revealed=player.hand.filter(h=>h.revealed).length;
    const blindCount=player.hand.filter(h=>!h.revealed).length;
    const pct=(revealed/G.handSize*100).toFixed(0);
    // è£ã‚¿ã‚¤ãƒ«ç§»å‹•å¯èƒ½æ¡ä»¶: è£ã‚¿ã‚¤ãƒ«>=1æš ã‹ã¤ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¾…æ©Ÿä¸­ã§ãªã„
    const isMyTurn=isActive&&(!myName||G.players[pi].name===myName);
    const canMoveBlind=isMyTurn&&!act&&!G.gameOver&&blindCount>=1;
    const canPass=isMyTurn&&!act&&!G.gameOver;
    div.innerHTML=`
      <div class="player-header">
        <span class="player-name">${player.name}</span>
        ${isActive?`<span class="badge badge-yellow">YOUR TURN</span>`:''}
        <span class="player-progress">${revealed}/${G.handSize}</span>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="tile-row" id="tileRow${pi}"></div>
      ${isActive?(()=>{
        const isMovePhase=act&&(act.phase==='awaitMoveBlind'||act.phase==='awaitMoveInsert');
        if(isMovePhase){
          return `<div class="player-action-bar">
            <button class="btn-sm accent" onclick="cancelAction()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>`;
        }
        return `<div class="player-action-bar">
          <button class="btn-sm" onclick="startMoveBlind()" ${canMoveBlind?'':'disabled'}>è£ã‚¿ã‚¤ãƒ«ç§»å‹•</button>
          <button class="btn-sm" onclick="passAction()" ${canPass?'':'disabled'}>ãƒ‘ã‚¹</button>
        </div>`;
      })():''}`;
    insertPlayerZone(div);

    const tileRow=div.querySelector(`#tileRow${pi}`);
    const showInsertGaps=isActive&&act&&act.phase==='awaitMoveInsert';
    const movingIdx=act&&act.selectedHandIdx;

    // Build hand display â€” with gap slots interleaved when in insert mode
    if(showInsertGaps){
      // Render hand WITHOUT the moving tile (it's been logically lifted out)
      const handWithout=player.hand.filter((_,i)=>i!==movingIdx);
      for(let gi=0;gi<=handWithout.length;gi++){
        // Gap slot
        const gapBlocked=isGapBlockedForInsert(handWithout,gi);
        const g=document.createElement('div');
        g.className=`gap-slot${gapBlocked?' blocked':' droppable'}`;
        g.textContent=gapBlocked?'':'â†“';
        g.title=gapBlocked?'é€£ç•ªã®é–“ã«ã¯å·®ã—è¾¼ã‚ã¾ã›ã‚“':'ã“ã“ã«å·®ã—è¾¼ã‚€';
        if(!gapBlocked){const gi2=gi;g.onclick=()=>doMoveInsert(gi2);}
        tileRow.appendChild(g);
        // Tile
        if(gi<handWithout.length){
          const h=handWithout[gi];
          const el=document.createElement('div');
          el.className=`tile ${h.revealed?'face-up':'face-down'}`;
          el.textContent=h.revealed?h.tile.num:'';
          if(h.revealed&&h.tile.rev)el.title=`é€†ã•:${h.tile.rev}`;
          tileRow.appendChild(el);
        }
      }
    } else {
      player.hand.forEach((h,hi)=>{
        const canSelect=isActive&&!h.revealed&&act&&
          (act.phase==='awaitSwap'||act.phase==='awaitMoveBlind');
        const isSel=act&&act.selectedHandIdx===hi&&act.playerIdx===pi;
        const el=document.createElement('div');
        el.className=`tile ${h.revealed?'face-up':'face-down'}`;
        if(canSelect&&!h.revealed)el.classList.add('selectable');
        if(isSel)el.classList.add('selected');
        // ç½®ã‘ã‚‹ä½ç½®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆawaitSwapæ™‚ãƒ»è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ï¼‰
        if(isActive&&act&&act.phase==='awaitSwap'&&!h.revealed){
          const drawn=act.drawnTile;
          const fits=canFit(player.hand,hi,drawn.num)||(drawn.rev&&canFit(player.hand,hi,drawn.rev));
          if(fits) el.classList.add('can-place');
          else el.classList.add('cannot-place');
        }
        el.textContent=h.revealed?h.tile.num:'';
        if(h.revealed&&h.tile.rev)el.title=`é€†ã•:${h.tile.rev}`;
        if(canSelect&&!h.revealed)el.onclick=()=>clickHandTile(pi,hi);
        // ã‚¹ãƒ¯ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ï¼ˆè£ã‚¿ã‚¤ãƒ«äº¤æ›ã§è¡¨ã«ãªã£ãŸã‚¿ã‚¤ãƒ«ï¼‰
        if(swapAnim && swapAnim.pi===pi && swapAnim.hi===hi){
          el.classList.add('just-swapped-in');
          swapAnim=null;
        }
        // å·®ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡ï¼ˆè£ã‚¿ã‚¤ãƒ«ç§»å‹•ï¼‰
        if(insertAnim && insertAnim.pi===pi && insertAnim.hi===hi){
          el.classList.add('just-inserted');
          insertAnim=null;
        }
        tileRow.appendChild(el);
      });
    }
  });

  // â”€â”€ å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ â”€â”€
  const banner=document.getElementById('drawnBanner');
  const flipBtn=document.getElementById('btnFlipDrawn');
  const discardBtn=document.getElementById('btnCannotPlace');
  if(act&&act.drawnTile&&act.tileFlipped){
    const t=act.drawnTile;
    const isFlipped=act.useRev===true;
    banner.classList.remove('hidden');
    const disp=document.getElementById('drawnCardDisplay');
    // ã²ã£ãã‚Šè¿”ã— = revå€¤ã‚’æ•°å­—ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆCSSå›è»¢ãªã—ï¼‰
    disp.textContent=isFlipped&&t.rev?t.rev:t.num;
    disp.style.transform='';
    document.getElementById('drawnBannerSub').textContent=
      `${G.players[G.currentPlayer].name} ãŒå¼•ã„ãŸ â€” è£ã‚¿ã‚¤ãƒ«ã¨äº¤æ›ã—ã¦ãã ã•ã„`;
    document.getElementById('drawnBannerRev').textContent=
      t.rev?`é€†ã•ã§ä½¿ç”¨: ${t.rev}ï¼ˆç¾åœ¨: ${isFlipped?'é€†ã•':'æ­£å‘ã'}ï¼‰`:'';
    if(t.rev){flipBtn.style.display='';flipBtn.textContent=isFlipped?`âŸ³ æ­£å‘ã (${t.num})`:`âŸ³ ã²ã£ãã‚Šè¿”ã™ (â†’${t.rev})`;}
    else{flipBtn.style.display='none';}
    discardBtn.style.display='';
  }else{
    banner.classList.add('hidden');
    if(flipBtn)flipBtn.style.display='none';
    if(discardBtn)discardBtn.style.display='none';
  }

  // â”€â”€ å±±æœ­ã‚°ãƒªãƒƒãƒ‰ â”€â”€
  const poolGrid=document.getElementById('poolGrid');
  const poolCountBadge=document.getElementById('poolCountBadge');
  poolGrid.innerHTML='';
  poolCountBadge.textContent=`${G.pool.length} æš`;
  const isMyTurnNow=!myName||G.players[G.currentPlayer].name===myName;
  const canDraw=isMyTurnNow&&!act&&!G.gameOver;
  G.pool.forEach((tile,pi2)=>{
    const el=document.createElement('div');
    el.className=`tile face-down${canDraw?' pool-tile':''}`;
    // Show index subtly for dev (remove in prod):
    // el.dataset.idx=pi2;
    if(canDraw)el.onclick=()=>flipPoolTile(pi2,el);
    poolGrid.appendChild(el);
  });

  // â”€â”€ æ¨ã¦å ´ â”€â”€ è£å‘ãï¼ˆfaceUpã®ã¿è¡¨å‘ãï¼‰ã€ã‚¯ãƒªãƒƒã‚¯ã§å–å¾—
  const discardScroll=document.getElementById('discardScroll');
  discardScroll.innerHTML='';
  // Show newest first (reverse)
  [...G.discard].reverse().forEach((entry,di)=>{
    const realIdx=G.discard.length-1-di;
    const wrapper=document.createElement('div');
    wrapper.className='discard-entry';
    const canTake=isMyTurnNow&&!act&&!G.gameOver;
    const tileEl=document.createElement('div');
    const showFace=entry.faceUp===true;
    // è¡¨å‘ãã‚¿ã‚¤ãƒ«ãŒæ‰‹æœ­ã«ç½®ã‘ã‚‹ã‹ç¢ºèª
    let placeable=true;
    if(showFace&&canTake){
      const hand=G.players[G.currentPlayer].hand;
      const blindIdxList=hand.map((h,i)=>h.revealed?-1:i).filter(i=>i>=0);
      placeable=blindIdxList.some(hi=>{
        const t=entry.tile;
        return canFit(hand,hi,t.num)||(t.rev&&canFit(hand,hi,t.rev));
      });
    }
    const unplaceable=showFace&&canTake&&!placeable;
    tileEl.className=`tile ${showFace?'face-up':'face-down'}${canTake&&!unplaceable?' pool-tile':''}${unplaceable?' unplaceable':''}`;
    tileEl.textContent=showFace?entry.tile.num:'';
    if(showFace&&entry.tile.rev)tileEl.title=`é€†ã•:${entry.tile.rev}`;
    if(entry.isNew){
      const dot=document.createElement('div');dot.className='new-dot';
      tileEl.appendChild(dot);
    }
    if(canTake&&!unplaceable)tileEl.onclick=()=>takeDiscard(realIdx);
    const who=document.createElement('div');who.className='discard-who';
    // è£å‘ãã¯èª°ãŒæ¨ã¦ãŸã‹è¡¨ç¤ºï¼ˆæ•°å­—ã¯ä¼ã›ã‚‹ï¼‰
    who.textContent=entry.discardedBy||'ï¼Ÿ';
    wrapper.appendChild(tileEl);
    wrapper.appendChild(who);
    discardScroll.appendChild(wrapper);
  });

  // â”€â”€ Action panel â”€â”€
  document.getElementById('actionPanel').style.display='';
  const hint=document.getElementById('actionHint');
  const ph=document.getElementById('phaseHint');
  ph.style.display='';

  if(!G.gameOver){
    const name=G.players[cp].name;
    if(!act){
      hint.textContent=`${name} ã®ã‚¿ãƒ¼ãƒ³ï¼šå±±æœ­ã‹ã‚‰å¼•ã / æ¨ã¦å ´ã‹ã‚‰å–ã‚‹ / æ‰‹æœ­ã®è£ã‚¿ã‚¤ãƒ«ç§»å‹• / ãƒ‘ã‚¹`;
      ph.textContent='';
    }else if(act.phase==='awaitPoolSelect'){
      hint.textContent='å±±æœ­ã®ã‚¿ã‚¤ãƒ«ã‚’1æšã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ãã£ã¦ãã ã•ã„';
      ph.textContent='ğŸ’¡ ã©ã®ã‚¿ã‚¤ãƒ«ã‚‚ä¸­èº«ã¯åŒã˜ç¢ºç‡ã€‚ç›´æ„Ÿã§é¸ã¼ã†ï¼';
    }else if(act.phase==='awaitSwap'){
      const useNum=act.useRev&&act.drawnTile.rev?act.drawnTile.rev:act.drawnTile.num;
      hint.textContent=`[${useNum}] ã¨ã—ã¦ä½¿ç”¨ â€” ç½®ãè£ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯`;
      ph.textContent=act.drawnTile.rev
        ?`ğŸ’¡ ã²ã£ãã‚Šè¿”ã™ãƒœã‚¿ãƒ³ã§å‘ãã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚ç½®ã‘ãªã‘ã‚Œã°ã€Œæ¨ã¦ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„`
        :`ğŸ’¡ ç½®ã‘ãªã„å ´åˆã¯å¼•ã„ãŸã‚¿ã‚¤ãƒ«æ¨ªã®ã€Œæ¨ã¦ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„`;
    }else if(act.phase==='awaitMoveBlind'){
      hint.textContent='ç§»å‹•ã™ã‚‹è£ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯';
      ph.textContent='ğŸ’¡ è£ã‚¿ã‚¤ãƒ«ã‚’åˆ¥ã®ä½ç½®ã«å·®ã—è¾¼ã¿ã¾ã™ã€‚é€£ç•ªã®é–“ã«ã¯å…¥ã‚Œã‚‰ã‚Œã¾ã›ã‚“ã€‚';
    }else if(act.phase==='awaitMoveInsert'){
      hint.textContent='å·®ã—è¾¼ã‚€ä½ç½®ã® â†“ ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆèµ¤ãƒãƒƒãƒã¯é€£ç•ªéš£æ¥ã®ãŸã‚NGï¼‰';
      ph.textContent='';
    }
  }else{
    hint.textContent='ã‚²ãƒ¼ãƒ çµ‚äº†';ph.textContent='';
  }

  document.getElementById('hdrTurn').textContent=G.gameOver?'GAME OVER':G.players[cp].name;
  document.getElementById('hdrRound').textContent=`ROUND ${G.round}`;
  document.getElementById('hdrPool').textContent=`POOL: ${G.pool.length+G.discard.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IN-GAME ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â“ª å¼•ã„ãŸã‚¿ã‚¤ãƒ«ã‚’ã²ã£ãã‚Šè¿”ã™ï¼ˆé€†ã•/æ­£å‘ãåˆ‡ã‚Šæ›¿ãˆï¼‰
function flipDrawnTile(){
  if(!act||act.phase!=='awaitSwap'||!act.drawnTile.rev)return;
  act.useRev=!act.useRev;
  render();
}

// â“ª ãƒ‘ã‚¹ï¼ˆã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
function passAction(){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  playSound('discard');
  log(`${G.players[G.currentPlayer].name}: ãƒ‘ã‚¹ã—ãŸã€‚`);
  nextTurn();syncToServer();render();
}

// â‘  å±±æœ­ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚ãã‚Šã‚¢ãƒ‹ãƒ¡ â†’ awaitSwap
function flipPoolTile(poolIdx, el){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  el.classList.add('flipping');
  act={phase:'awaitPoolSelect',drawnTile:null,playerIdx:G.currentPlayer,fromDiscard:false,tileFlipped:false};
  // ã‚¢ãƒ‹ãƒ¡å®Œäº†å¾Œã«ã‚¿ã‚¤ãƒ«ã‚’ã‚ãã£ã¦awaitSwapã¸
  setTimeout(()=>{
    const tile=G.pool.splice(poolIdx,1)[0];
    act={phase:'awaitSwap',drawnTile:tile,playerIdx:G.currentPlayer,fromDiscard:false,tileFlipped:true};
    G.discard.forEach(e=>e.isNew=false);
    playSound('draw');
    log(`${G.players[G.currentPlayer].name} ãŒå±±æœ­ã‹ã‚‰ [${tile.num}${tile.rev?'/'+tile.rev:''}] ã‚’ã‚ãã£ãŸï¼`,'highlight');
    syncToServer(); // G.act=awaitSwap ã‚’å…¨å“¡ã«é…ä¿¡
    render();
  },380);
}

// â‘¡ æ¨ã¦å ´ã‹ã‚‰å–å¾—ï¼ˆè£å‘ãã‚¿ã‚¤ãƒ«ã‚’ã‚ãã£ã¦æ‰‹ã«å…¥ã‚Œã‚‹ï¼‰
function takeDiscard(di){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  const entry=G.discard.splice(di,1)[0];
  G.discard.forEach(e=>e.isNew=false);
  // tile is now revealed to current player
  act={phase:'awaitSwap',drawnTile:entry.tile,playerIdx:G.currentPlayer,fromDiscard:true,tileFlipped:true};
  playSound('draw');
  log(`${G.players[G.currentPlayer].name} ãŒæ¨ã¦å ´ã‹ã‚‰ï¼ˆ${entry.discardedBy} ã®æ¨ã¦ãŸã‚¿ã‚¤ãƒ«ï¼‰[${entry.tile.num}] ã‚’å–ã£ãŸï¼`,'highlight');
  syncToServer();
  render();
}

// â‘¢ æ‰‹æœ­ã®è£ã‚¿ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯
function clickHandTile(pi,hi){
  if(!G||!act||setupPhase||pi!==G.currentPlayer)return;
  if(myName && G.players[pi].name !== myName)return;
  const player=G.players[G.currentPlayer];

  if(act.phase==='awaitSwap'){
    if(player.hand[hi].revealed){log('è¡¨å‘ãã®ã‚¿ã‚¤ãƒ«ã¨ã¯äº¤æ›ã§ãã¾ã›ã‚“ï¼','error');flashTile(pi,hi);return;}
    const drawn=act.drawnTile.num,rev=act.drawnTile.rev;
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸ã‚“ã å‘ãï¼ˆuseRevãƒ•ãƒ©ã‚°ï¼‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°è‡ªå‹•é¸æŠ
    let useNum;
    if(act.useRev&&rev){
      useNum=rev;
    } else {
      useNum=drawn;
      if(rev&&!canFit(player.hand,hi,drawn)&&canFit(player.hand,hi,rev))useNum=rev;
    }
    if(!canFit(player.hand,hi,useNum)){
      // é€†ã•å‘ãã‚‚è©¦ã™
      const altNum=act.useRev?drawn:rev;
      if(altNum&&canFit(player.hand,hi,altNum)){useNum=altNum;}
      else{playSound('error');log(`[${useNum}] ã¯ ${neighborStr(player.hand,hi)} ã®é–“ã«ç½®ã‘ã¾ã›ã‚“ï¼`,'error');flashTile(pi,hi);return;}
    }
    const removed=player.hand.splice(hi,1,{tile:{num:useNum,rev:null},revealed:true})[0];
    swapAnim={pi, hi};
    // äº¤æ›ã§å‡ºãŸè£ã‚¿ã‚¤ãƒ«ã¯è£å‘ãã§æ¨ã¦å ´ã¸
    G.discard.forEach(e=>e.isNew=false);
    playSound('discard');
    G.discard.push({tile:removed.tile,discardedBy:player.name,faceUp:false,isNew:true});
    const bonus=isConsecutive(player.hand,hi);
    log(`${player.name}: [${useNum}] ã‚’é…ç½®ã€‚`,bonus?'highlight':'');
    act=null;G.act=null;player.turns++;
    // é”æˆé€²æ—ã‚’è¨˜éŒ²ï¼ˆ[ã‚¿ãƒ¼ãƒ³æ•°, é”æˆæšæ•°]ï¼‰
    const revealedNow=player.hand.filter(h=>h.revealed).length;
    if(!player.progressHistory) player.progressHistory=[[0,0]];
    player.progressHistory.push([player.turns, revealedNow]);
    checkWin(G.currentPlayer);
    if(!G.gameOver){
      if(bonus){
        playSound('bonus');
        log(`ğŸ‰ é€£ç•ªï¼${player.name} ãŒã‚‚ã†1å›ï¼`,'highlight');
        bonusEffect(pi,hi);
      } else {
        playSound('place');
        nextTurn();
      }
    }
    syncToServer();
    render();

  }else if(act.phase==='awaitMoveBlind'){
    if(player.hand[hi].revealed){log('è¡¨å‘ãã‚¿ã‚¤ãƒ«ã¯ç§»å‹•ã§ãã¾ã›ã‚“ï¼','error');return;}
    act.phase='awaitMoveInsert';act.selectedHandIdx=hi;
    log(`ä½ç½® ${hi+1} ã®è£ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã€‚å·®ã—è¾¼ã‚€å ´æ‰€ã® â†“ ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚`);render();
  }
}

function cannotPlace(){
  if(!act||act.phase!=='awaitSwap')return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  G.discard.forEach(e=>e.isNew=false);
  // ç½®ã‘ãªã‹ã£ãŸã‚¿ã‚¤ãƒ«ã¯è¡¨å‘ãã§æ¨ã¦å ´ã¸ï¼ˆå…¨å“¡ã«æ•°å­—ãŒåˆ†ã‹ã‚‹ï¼‰
  G.discard.push({tile:act.drawnTile,discardedBy:G.players[G.currentPlayer].name,faceUp:true,isNew:true});
  playSound('discard');
  log(`${G.players[G.currentPlayer].name}: [${act.drawnTile.num}] ã¯ç½®ã‘ãš â†’ è¡¨å‘ãã§æ¨ã¦å ´ã¸ã€‚`,'error');
  act=null;G.act=null;nextTurn();syncToServer();render();
}

function startMoveBlind(){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  const cp=G.currentPlayer;
  const blindCount=G.players[cp].hand.filter(h=>!h.revealed).length;
  if(blindCount<1){log('ç§»å‹•ã§ãã‚‹è£ã‚¿ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚','error');return;}
  act={phase:'awaitMoveBlind',playerIdx:cp};
  log(`${G.players[cp].name}: è£ã‚¿ã‚¤ãƒ«ç§»å‹•ã‚’é¸æŠã€‚`);render();
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã‚¿ã‚¤ãƒ«æœªã‚ãã‚Šæ“ä½œ(ç§»å‹•ç³»)ã®ã¿
function cancelAction(){
  if(!act)return;
  if(act.phase==='awaitMoveBlind'||act.phase==='awaitMoveInsert'){
    log('è£ã‚¿ã‚¤ãƒ«ç§»å‹•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã€‚ã‚¿ãƒ¼ãƒ³ç¶™ç¶šã€‚');
    act=null;G.act=null;syncToServer();render();
  }
  // awaitSwap(ã‚ãã‚Šæ¸ˆã¿)ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸å¯
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVE-INSERT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// handWithout = hand array with the moving tile removed
// gi = gap index (0 = before first tile, N = after last tile)
// Blocked if the two revealed tiles immediately flanking this gap are consecutive
function isGapBlockedForInsert(handWithout, gi){
  // Blocked ONLY when the two PHYSICALLY ADJACENT tiles on each side are
  // both revealed AND consecutive (a blind tile in between breaks adjacency)
  const left  = gi > 0                    ? handWithout[gi-1] : null;
  const right = gi < handWithout.length   ? handWithout[gi]   : null;
  if(left && right && left.revealed && right.revealed){
    if(Math.abs(right.tile.num - left.tile.num) === 1) return true;
  }
  return false;
}

// Perform the actual insert: remove tile from originalIdx, splice into new gap position
function doMoveInsert(gapIdx){
  if(!act||act.phase!=='awaitMoveInsert')return;
  const player=G.players[G.currentPlayer];
  const from=act.selectedHandIdx;
  const movedTile=player.hand.splice(from,1)[0]; // remove tile
  // gapIdx was computed on handWithout (hand without the moving tile)
  // after removal, direct splice at gapIdx is correct
  player.hand.splice(gapIdx,0,movedTile);
  const newPos=gapIdx+1;
  insertAnim={pi:G.currentPlayer, hi:gapIdx};
  log(`${player.name}: è£ã‚¿ã‚¤ãƒ«ã‚’ä½ç½®${from+1}ã‹ã‚‰ä½ç½®${newPos}ã¸å·®ã—è¾¼ã‚“ã ã€‚`);
  act=null;G.act=null;nextTurn();syncToServer();render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIC HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function canFit(hand,hi,num){
  let L=-Infinity,R=Infinity;
  for(let i=hi-1;i>=0;i--)if(hand[i].revealed){L=hand[i].tile.num;break;}
  for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){R=hand[i].tile.num;break;}
  return num>L&&num<R;
}
function neighborStr(hand,hi){
  let L='â€”',R='â€”';
  for(let i=hi-1;i>=0;i--)if(hand[i].revealed){L=hand[i].tile.num;break;}
  for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){R=hand[i].tile.num;break;}
  return`${L} ã¨ ${R}`;
}
function isConsecutive(hand,hi){
  const cur=hand[hi].tile.num;
  for(let i=hi-1;i>=0;i--)if(hand[i].revealed){if(Math.abs(hand[i].tile.num-cur)===1)return true;break;}
  for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){if(Math.abs(hand[i].tile.num-cur)===1)return true;break;}
  return false;
}
function nextTurn(){
  G.currentPlayer=(G.currentPlayer+1)%G.players.length;
  if(G.currentPlayer===0)G.round++;
}
function checkWin(pi){
  const pl=G.players[pi];
  if(!pl.hand.every(h=>h.revealed))return;
  for(let i=1;i<pl.hand.length;i++)if(pl.hand[i].tile.num<=pl.hand[i-1].tile.num)return;
  G.gameOver=true;G.winner=pi;
  playSound('win');
  log(`ğŸ† ${pl.name} ãŒå…¨ã‚¿ã‚¤ãƒ«ã‚’æ˜‡é †ã«ï¼COMPLETEï¼`,'highlight');
  showWin(pi);
}
function showWin(pi){
  // G.result ã‚’ç”Ÿæˆï¼ˆå…¨å“¡ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
  G.result = {
    winnerIdx: pi,
    players: G.players.map(p=>({
      name: p.name,
      turns: p.turns,
      revealed: p.hand.filter(h=>h.revealed).length,
      handSize: G.handSize,
      progressHistory: p.progressHistory || [[0,0]],
    })),
    votes: {}, // {playerName: 'rematch'|'leave'}
  };
  syncToServer();
  openResult();
}

function openResult(){
  if(!G||!G.result) return;
  const r = G.result;
  const winner = r.players[r.winnerIdx];
  const myVote = r.votes[myName] || null;

  // â”€â”€ ã‚°ãƒ©ãƒ•æç”» â”€â”€
  const W=460, H=200, PAD={top:20,right:20,bottom:36,left:36};
  const gw=W-PAD.left-PAD.right, gh=H-PAD.top-PAD.bottom;
  const maxTurns = Math.max(...r.players.map(p=>p.turns), 1);
  const maxRevealed = Math.max(...r.players.map(p=>p.handSize), 1);
  const colors = ['#e8d44d','#e05c4b','#5ab4e0','#7de87a','#e0a05c','#c05ae0'];

  const toX = t => PAD.left + (t/maxTurns)*gw;
  const toY = v => PAD.top + gh - (v/maxRevealed)*gh;

  // è»¸
  let svgLines = `<line x1="${PAD.left}" y1="${PAD.top}" x2="${PAD.left}" y2="${PAD.top+gh}" stroke="#333" stroke-width="1"/>`;
  svgLines += `<line x1="${PAD.left}" y1="${PAD.top+gh}" x2="${PAD.left+gw}" y2="${PAD.top+gh}" stroke="#333" stroke-width="1"/>`;
  // Yè»¸ã‚°ãƒªãƒƒãƒ‰
  [0,0.25,0.5,0.75,1].forEach(f=>{
    const y=toY(f*maxRevealed);
    svgLines += `<line x1="${PAD.left}" y1="${y}" x2="${PAD.left+gw}" y2="${y}" stroke="#222" stroke-width="1" stroke-dasharray="3,3"/>`;
    svgLines += `<text x="${PAD.left-4}" y="${y+4}" text-anchor="end" fill="#444" font-size="9">${Math.round(f*maxRevealed)}</text>`;
  });
  // Xè»¸ãƒ©ãƒ™ãƒ«
  svgLines += `<text x="${PAD.left}" y="${H-4}" fill="#444" font-size="9">0</text>`;
  svgLines += `<text x="${PAD.left+gw}" y="${H-4}" text-anchor="end" fill="#444" font-size="9">${maxTurns}</text>`;
  svgLines += `<text x="${W/2}" y="${H}" text-anchor="middle" fill="#444" font-size="9">TURNS</text>`;
  svgLines += `<text x="8" y="${H/2}" text-anchor="middle" fill="#444" font-size="9" transform="rotate(-90,8,${H/2})">REVEALED</text>`;

  // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ˜ã‚Œç·š
  let svgPaths = '';
  r.players.forEach((p,i)=>{
    const hist = p.progressHistory.length>1 ? p.progressHistory : [[0,0],[p.turns,p.revealed]];
    const pts = hist.map(([t,v])=>`${toX(t)},${toY(v)}`).join(' ');
    const col = colors[i%colors.length];
    svgPaths += `<polyline points="${pts}" fill="none" stroke="${col}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" opacity="0.9"/>`;
    // çµ‚ç‚¹ãƒ‰ãƒƒãƒˆ
    const last = hist[hist.length-1];
    svgPaths += `<circle cx="${toX(last[0])}" cy="${toY(last[1])}" r="4" fill="${col}"/>`;
    // å‹è€…ã¯æ˜Ÿãƒãƒ¼ã‚¯
    if(i===r.winnerIdx){
      svgPaths += `<text x="${toX(last[0])+6}" y="${toY(last[1])-4}" fill="${col}" font-size="10">â˜…</text>`;
    }
  });

  // å‡¡ä¾‹
  let legend = r.players.map((p,i)=>`
    <div style="display:flex;align-items:center;gap:6px;font-size:0.62rem;color:#aaa;">
      <span style="width:14px;height:3px;background:${colors[i%colors.length]};border-radius:2px;display:inline-block;flex-shrink:0;"></span>
      <span style="${i===r.winnerIdx?'color:#e8d44d;font-weight:700;':''}">${p.name}${i===r.winnerIdx?' â˜…':''}</span>
      <span style="color:#555;margin-left:auto;">${p.turns}T Â· ${p.revealed}/${p.handSize}</span>
    </div>`).join('');

  // æŠ•ç¥¨çŠ¶æ³
  const totalPlayers = r.players.length;
  const voteCount = Object.keys(r.votes).length;
  const rematchCount = Object.values(r.votes).filter(v=>v==='rematch').length;
  let voteStatus = r.players.map(p=>{
    const v = r.votes[p.name];
    const icon = v==='rematch'?'ğŸ”':v==='leave'?'ğŸšª':'â€¦';
    return `<span style="font-size:0.65rem;color:${v?'#aaa':'#444'};margin-right:10px;">${icon} ${p.name}</span>`;
  }).join('');

  document.getElementById('resultContent').innerHTML = `
    <div style="font-family:'Bebas Neue',cursive;font-size:2.2rem;letter-spacing:5px;color:#e8d44d;margin-bottom:4px;">COMPLETE!</div>
    <div style="font-size:0.8rem;color:#aaa;margin-bottom:20px;letter-spacing:2px;">â€” ${winner.name} WINS â€”</div>

    <svg viewBox="0 0 ${W} ${H}" style="width:100%;border:1px solid #1e1e1e;border-radius:4px;background:#0a0a0a;display:block;margin-bottom:10px;">
      ${svgLines}${svgPaths}
    </svg>
    <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:20px;">${legend}</div>

    <div style="border-top:1px solid #1e1e1e;padding-top:16px;">
      ${myVote ? `
        <div style="font-size:0.65rem;color:#555;text-align:center;margin-bottom:12px;">æŠ•ç¥¨æ¸ˆã¿: ${myVote==='rematch'?'ğŸ” å†æˆ¦':'ğŸšª é€€å‡º'}</div>
      ` : `
        <div style="font-size:0.62rem;color:#555;text-align:center;margin-bottom:10px;letter-spacing:1px;">VOTE</div>
        <div style="display:flex;gap:8px;">
          <button class="btn primary" onclick="voteResult('rematch')" style="flex:1;padding:11px;font-size:0.75rem;letter-spacing:2px;">ğŸ” å†æˆ¦</button>
          <button class="btn" onclick="voteResult('leave')" style="flex:1;padding:11px;font-size:0.72rem;border-color:#444;color:#666;">ğŸšª é€€å‡º</button>
        </div>
      `}
      <div style="margin-top:10px;font-size:0.6rem;color:#444;text-align:center;">${voteCount}/${totalPlayers} æŠ•ç¥¨æ¸ˆã¿${rematchCount>0?' Â· å†æˆ¦ '+rematchCount+'ç¥¨':''}</div>
      <div style="margin-top:4px;">${voteStatus}</div>
    </div>
  `;

  document.getElementById('resultOverlay').classList.remove('hidden');
  // å‹åˆ©ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  setTimeout(()=>spawnParticles(window.innerWidth/2, window.innerHeight/3, 40),300);
  setTimeout(()=>spawnParticles(window.innerWidth/3, window.innerHeight/2, 25),600);
  setTimeout(()=>spawnParticles(window.innerWidth*2/3, window.innerHeight/2, 25),800);
}

function voteResult(vote){
  if(!G||!G.result) return;
  G.result.votes[myName] = vote;
  syncToServer();
  openResult(); // æŠ•ç¥¨çŠ¶æ³ã‚’å†æç”»
  // å…¨å“¡å†æˆ¦ãªã‚‰ãƒ›ã‚¹ãƒˆãŒè‡ªå‹•rematch
  const r = G.result;
  const allVoted = r.players.every(p=>r.votes[p.name]);
  const allRematch = r.players.every(p=>r.votes[p.name]==='rematch');
  if(allVoted && allRematch && amIHost){
    setTimeout(()=>rematch(), 600);
  } else if(allVoted && !allRematch){
    // é€€å‡ºè€…ãŒã„ã‚‹å ´åˆã¯ãƒ­ãƒ“ãƒ¼ã¸
    if(r.votes[myName]==='leave'){
      setTimeout(()=>{ location.reload(); }, 600);
    }
  }
}

// ãƒªãƒãƒƒãƒï¼šåŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ›ã‚¹ãƒˆãŒå³å†æˆ¦
function rematch(){
  if(!amIHost||!ws)return;
  // åå‰ãƒªã‚¹ãƒˆã‚’ä¿æŒã—ãŸã¾ã¾hostStartGameã‚’å†å®Ÿè¡Œ
  const names=shuffle(G.players.map(p=>p.name)); // ãƒªãƒãƒƒãƒã‚‚é †ç•ªã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const count=names.length;
  const nums=shuffle([...Array(100)].map((_,i)=>i+1));
  let idx=0;
  const HAND_BLIND=getHandBlind(count);
  const HAND_REVEAL=getHandReveal(count);
  const players=[];
  for(let p=0;p<count;p++){
    const hand=nums.slice(idx,idx+HAND_BLIND).map(n=>({tile:makeTile(n),revealed:false}));
    idx+=HAND_BLIND;
    const revealTiles=nums.slice(idx,idx+HAND_REVEAL).map(makeTile);
    idx+=HAND_REVEAL;
    revealTiles.sort((a,b)=>a.num-b.num);
    players.push({name:names[p],hand,revealTiles,revealTilesTotal:revealTiles.length,turns:0,progressHistory:[[0,0]]});
  }
  const playerSetups=players.map(()=>({currentRevealIdx:0,selectedInHand:false,useRev:false,done:false}));
  act=null;
  G={players,currentPlayer:0,pool:nums.slice(idx).map(makeTile),discard:[],round:1,gameOver:false,handSize:HAND_BLIND+HAND_REVEAL,playerSetups};
  document.getElementById('resultOverlay').classList.add('hidden');
  ws.send(JSON.stringify({type:'start',G}));
}
function flashTile(pi,hi){
  const row=document.getElementById(`tileRow${pi}`);if(!row)return;
  const el=row.children[hi];if(!el)return;
  el.classList.add('invalid-flash');
  setTimeout(()=>el.classList.remove('invalid-flash'),400);
}

// é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚¿ã‚¤ãƒ«ç™ºå…‰ + ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
function bonusEffect(pi, hi){
  const row=document.getElementById(`tileRow${pi}`);
  if(!row)return;
  // æ‰‹æœ­ã«gapSlotãŒæ··ã˜ã‚‹ã®ã§realIndexã‚’ç®—å‡º
  const tiles=[...row.children].filter(el=>el.classList.contains('tile'));
  const el=tiles[hi];
  if(!el)return;
  el.classList.add('bonus-flash');
  setTimeout(()=>el.classList.remove('bonus-flash'),800);
  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  const rect=el.getBoundingClientRect();
  spawnParticles(rect.left+rect.width/2, rect.top+rect.height/2, 18);
}

function spawnParticles(x, y, count){
  const container=document.getElementById('particles');
  const colors=['#e8d44d','#f0e060','#fff8a0','#e8b040','#ffffff'];
  for(let i=0;i<count;i++){
    const p=document.createElement('div');
    p.className='particle';
    const angle=Math.random()*Math.PI*2;
    const dist=60+Math.random()*80;
    const dx=Math.cos(angle)*dist;
    const dy=Math.sin(angle)*dist - 40;
    const dur=0.4+Math.random()*0.5;
    p.style.cssText=`left:${x}px;top:${y}px;background:${colors[i%colors.length]};
      --dx:${dx}px;--dy:${dy}px;animation-duration:${dur}s;
      width:${4+Math.random()*5}px;height:${4+Math.random()*5}px;`;
    container.appendChild(p);
    setTimeout(()=>p.remove(), dur*1000+100);
  }
}

// ã‚¿ãƒ¼ãƒ³ç§»è¡ŒãƒãƒŠãƒ¼è¡¨ç¤º
let turnBannerTimer=null;
function showTurnBanner(name){
  const banner=document.getElementById('turnBanner');
  const nameEl=document.getElementById('turnBannerName');
  if(!banner||!nameEl)return;
  nameEl.textContent=name;
  banner.classList.add('show');
  if(turnBannerTimer)clearTimeout(turnBannerTimer);
  turnBannerTimer=setTimeout(()=>banner.classList.remove('show'),1400);
}

// â”€â”€ DOM HELPERS â”€â”€
function clearPlayerZones(){
  [...document.getElementById('gameWrap').querySelectorAll('.player-zone')].forEach(el=>el.remove());
}
function insertPlayerZone(div){
  const gw=document.getElementById('gameWrap');
  gw.insertBefore(div,document.getElementById('centerZone'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VERSION & CHANGELOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CURRENT_VERSION = 'v1.8.0';

const CHANGELOG = [
  {
    version: 'v1.8.0',
    date: '2026-02-27',
    items: [
      { text: 'ãƒªã‚¶ãƒ«ãƒˆç”»é¢ï¼šé€²æ—ã‚°ãƒ©ãƒ•ãƒ»å…¨å“¡æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ ', highlight: true },
      { text: 'å†æˆ¦/é€€å‡ºã®æŠ•ç¥¨ãŒå…¨å“¡ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ' },
      { text: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ—¥ä»˜ã‚’ YYYY-MM-DD å½¢å¼ã«å¤‰æ›´' },
    ]
  },
  {
    version: 'v1.7.0',
    date: '2026-02-27',
    items: [
      { text: 'ã‚¿ã‚¤ãƒ«å·®ã—è¾¼ã¿ãƒ»äº¤æ›ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ', highlight: true },
      { text: 'ãƒ­ã‚´é…è‰²å¤‰æ›´ï¼ˆNUMé»„ / LETTOèµ¤ï¼‰', highlight: true },
      { text: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é †ã‚’ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«', highlight: true },
      { text: 'é”æˆç‡ï¼ˆ%ï¼‰è¡¨ç¤ºã‚’å‰Šé™¤ã€æšæ•°ã®ã¿ã«æ•´ç†' },
    ]
  },
  {
    version: 'v1.6.0',
    date: '2026-02-26',
    items: [
      { text: 'ç½®ã‘ã‚‹ä½ç½®ã‚’ã‚°ãƒªãƒ¼ãƒ³ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º', highlight: true },
      { text: 'é€£ç•ªé”æˆæ™‚ã«ç™ºå…‰ï¼‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ', highlight: true },
      { text: 'ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ãƒãƒŠãƒ¼æ¼”å‡ºè¿½åŠ ', highlight: true },
      { text: 'ãƒªãƒãƒƒãƒæ©Ÿèƒ½ï¼ˆåŒãƒ¡ãƒ³ãƒãƒ¼ã§å³å†æˆ¦ï¼‰', highlight: true },
      { text: 'å‹åˆ©æ™‚ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ¼”å‡º' },
    ]
  },
  {
    version: 'v1.5.0',
    date: '2026-02-26',
    items: [
      { text: 'ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œSEã‚’å…¨å“¡ã«é…ä¿¡', highlight: true },
      { text: 'è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å°‚ç”¨SEè¿½åŠ ', highlight: true },
      { text: 'WebSocketè‡ªå‹•å†æ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãï¼‰', highlight: true },
      { text: 'Heartbeat pingã§ã‚¢ã‚¤ãƒ‰ãƒ«åˆ‡æ–­é˜²æ­¢' },
      { text: 'å†æ¥ç¶šå¾Œã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹è‡ªå‹•å¾©å…ƒï¼ˆresyncï¼‰' },
    ]
  },
  {
    version: 'v1.4.0',
    date: '2026-02-25',
    items: [
      { text: 'æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã‚’å…¨å“¡åŒæ™‚é€²è¡Œã«å¤‰æ›´', highlight: true },
      { text: 'æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã®æ˜‡é †ãƒã‚§ãƒƒã‚¯ä¿®æ­£' },
      { text: 'SEå…¨èˆ¬: masterVolumeã§éŸ³é‡èª¿æ•´å¯¾å¿œ' },
      { text: 'ä»–äººã®ã‚¿ãƒ¼ãƒ³ã§ã®æ“ä½œã‚’è¡¨ç¤ºãƒ¬ãƒ™ãƒ«ã§ç„¡åŠ¹åŒ–' },
    ]
  },
  {
    version: 'v1.3.0',
    date: '2026-02-25',
    items: [
      { text: 'WebAudio SEã‚¨ãƒ³ã‚¸ãƒ³è¿½åŠ ï¼ˆå¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰', highlight: true },
      { text: 'ã‚ãã‚‹ãƒ»é…ç½®ãƒ»é€£ç•ªãƒ»æ¨ã¦ã‚‹ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»å‹åˆ©ã®SE' },
      { text: 'ä»–äººã®ã‚¿ã‚¤ãƒ«æ“ä½œé˜²æ­¢ã‚¬ãƒ¼ãƒ‰' },
    ]
  },
  {
    version: 'v1.2.0',
    date: '2026-02-24',
    items: [
      { text: 'G.actã‚’ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§åŒæœŸï¼ˆã‚ãã‚ŠçŠ¶æ…‹ãŒå…¨å“¡ã«è¦‹ãˆã‚‹ï¼‰', highlight: true },
      { text: 'WebSocketã‚¨ãƒ©ãƒ¼/ã‚¯ãƒ­ãƒ¼ã‚ºãƒãƒ³ãƒ‰ãƒ©æ•´ç†' },
    ]
  },
  {
    version: 'v1.1.0',
    date: '2026-02-24',
    items: [
      { text: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å°‚ç”¨ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒ–ï¼ˆPartyKitï¼‰', highlight: true },
      { text: 'ãƒ­ãƒ“ãƒ¼/å¾…åˆå®¤ã‚·ã‚¹ãƒ†ãƒ ', highlight: true },
      { text: 'ãƒ›ã‚¹ãƒˆåˆ¶å¾¡ã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ é–‹å§‹' },
      { text: 'NUMERETTO â†’ NUMLETTO ã«æ”¹å' },
    ]
  },
  {
    version: 'v1.0.0',
    date: '2026-02-23',
    items: [
      { text: 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ãƒƒãƒˆã‚·ãƒ¼ãƒˆç‰ˆãƒªãƒªãƒ¼ã‚¹', highlight: true },
      { text: '2ã€œ6äººå¯¾å¿œã€è£ã‚¿ã‚¤ãƒ«ãƒ»é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ãƒ»æ‰‹ç•ªäº¤ä»£' },
      { text: 'åè»¢ã‚¿ã‚¤ãƒ«(1/6/8/9)ã€ç›²ç›®ã‚¹ãƒ¯ãƒƒãƒ—ã€æ¨ã¦å ´ã‚·ã‚¹ãƒ†ãƒ ' },
    ]
  },
];

function openChangelog(){
  const content = document.getElementById('changelogContent');
  content.innerHTML = CHANGELOG.map((v,i) => `
    <div class="cl-version">
      <div class="cl-version-head">
        <span class="cl-ver-num">${v.version}</span>
        <span class="cl-ver-date">${v.date}</span>
        ${i===0 ? '<span class="cl-ver-current">CURRENT</span>' : ''}
      </div>
      <ul class="cl-items">
        ${v.items.map(item =>
          `<li class="${item.highlight?'highlight':''}">${item.text}</li>`
        ).join('')}
      </ul>
    </div>
  `).join('');
  document.getElementById('changelogOverlay').classList.add('show');
}

function closeChangelog(){
  document.getElementById('changelogOverlay').classList.remove('show');
}

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æ›´æ–°
function initVersion(){
  document.querySelectorAll('.version-badge, #hdrVersion').forEach(el => {
    el.textContent = CURRENT_VERSION;
  });
}

initVersion();
</script>
</body>
</html>
