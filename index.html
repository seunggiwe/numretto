<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NUMLETTO â€” æ•°å­—ä¸¦ã¹å¯¾æˆ¦ã‚²ãƒ¼ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0d0d0d; --surface:#161616; --panel:#1e1e1e; --border:#2a2a2a;
    --accent:#e8d44d; --accent2:#e05c4b; --text:#e8e8e8; --muted:#555;
    --face-down:#1a2a3a; --face-down-border:#2a4a6a;
    --revealed:#f5f0e8; --revealed-text:#0d0d0d;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:'Roboto Mono',monospace;min-height:100vh;display:flex;flex-direction:column;}

  /* â”€â”€ HEADER â”€â”€ */
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;}
  .logo{font-family:'Bebas Neue',cursive;font-size:1.8rem;letter-spacing:4px;color:var(--accent);}
  .logo span{color:var(--accent2);}
  .status-bar{display:flex;gap:16px;align-items:center;font-size:0.7rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
  .turn-indicator{background:var(--accent);color:#000;padding:3px 10px;border-radius:2px;font-weight:600;font-size:0.7rem;}

  .game-wrap{display:flex;flex-direction:column;flex:1;}

  /* â”€â”€ PLAYER ZONES â”€â”€ */
  .player-zone{padding:14px 24px 12px 14px;border-bottom:1px solid var(--border);transition:background 0.3s;display:flex;align-items:flex-start;gap:0;}
  .player-zone.active-player{background:linear-gradient(90deg,rgba(232,212,77,0.06) 0%,transparent 70%);border-left:3px solid var(--accent);}
  .turn-arrow{
    width:28px;flex-shrink:0;display:flex;align-items:center;justify-content:center;
    font-size:1.2rem;color:var(--muted);padding-top:2px;user-select:none;
    transition:color 0.3s;
  }
  .turn-arrow.active{color:var(--accent);}
  .player-zone-inner{flex:1;min-width:0;}
  /* ã©ã‚“ãã‚Šãƒã‚¤ãƒ©ã‚¤ãƒˆ: é¸æŠå‰ã®æ‹¡å¤§ */
  @keyframes donguri-select-pop{
    0%  {transform:scale(1);}
    40% {transform:scale(1.35) translateY(-8px);filter:brightness(1.8);}
    70% {transform:scale(1.3) translateY(-8px);}
    100%{transform:scale(1.3) translateY(-8px);}
  }
  .tile.donguri-selected{
    animation:donguri-select-pop 0.3s cubic-bezier(0.22,1,0.36,1) forwards !important;
    border-color:#f0a030 !important;
    box-shadow:0 0 24px 8px rgba(240,160,48,0.8) !important;
    z-index:60;position:relative;
  }
  .player-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap;}
  .player-name{font-family:'Bebas Neue',cursive;font-size:1.1rem;letter-spacing:3px;color:var(--muted);}
  .active-player .player-name{color:var(--accent);}
  .player-progress{font-size:0.62rem;color:var(--muted);}
  .progress-bar-wrap{height:3px;background:var(--border);border-radius:2px;width:100px;overflow:hidden;}
  .progress-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.4s;}
  .badge{display:inline-block;font-size:0.58rem;font-weight:700;padding:2px 7px;border-radius:2px;letter-spacing:1px;}
  .badge-yellow{background:var(--accent);color:#000;}
  .badge-red{background:var(--accent2);color:#fff;}
  .badge-muted{border:1px solid var(--border);color:var(--muted);}

  .tile-row{display:flex;flex-wrap:wrap;gap:4px;align-items:center;}

  /* â”€â”€ TILES â”€â”€ */
  .tile{
    width:48px;height:60px;border-radius:5px;
    display:flex;align-items:center;justify-content:center;
    font-weight:600;font-size:1rem;cursor:default;
    transition:transform 0.12s,box-shadow 0.12s,border-color 0.1s;
    user-select:none;border:2px solid transparent;letter-spacing:-0.5px;
    position:relative;
  }
  .tile.face-down{
    background:var(--face-down);border-color:var(--face-down-border);color:transparent;
    background-image:repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(255,255,255,0.02) 4px,rgba(255,255,255,0.02) 5px);
  }
  .tile.face-up.wild-tile{
    background:linear-gradient(135deg,#2a2000,#1a1400);
    border-color:#ffd700 !important;
    color:#ffd700 !important;
    box-shadow:0 0 12px rgba(255,215,0,0.5) !important;
    font-size:1.3rem !important;
    text-shadow:0 0 8px rgba(255,215,0,0.8);
  }
  @keyframes wild-pulse{
    0%,100%{box-shadow:0 0 8px rgba(255,215,0,0.4);}
    50%{box-shadow:0 0 20px 4px rgba(255,215,0,0.7);}
  }
  .tile.face-up.wild-tile{animation:wild-pulse 1.8s ease infinite;}
  /* awaitWildPlace: gap-slotãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .gap-slot.wild-drop{
    border-color:#ffd700 !important;
    background:rgba(255,215,0,0.15) !important;
    cursor:pointer !important;
  }
  .tile.face-up{background:var(--revealed);border-color:#c8c0a8;color:var(--revealed-text);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
  .tile.selectable{cursor:pointer;border-color:#3a6a9a !important;}
  .tile.selectable:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(58,106,154,0.4);border-color:#5a9aca !important;}
  .tile.selected{border-color:var(--accent) !important;box-shadow:0 0 0 3px rgba(232,212,77,0.4) !important;transform:translateY(-6px) !important;}
  .tile.invalid-flash{animation:flash-red 0.4s ease;}
  @keyframes flash-red{0%,100%{border-color:var(--accent2);}50%{background:rgba(224,92,75,0.15);}}

  /* é€†ã•ã¾è¡¨ç¤º */
  .tile.flipped { transform: rotate(180deg) !important; }
  .tile.flipped:hover { transform: rotate(180deg) translateY(-4px) !important; }
  /* ç½®ã‘ãªã„ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰æ¨ã¦å ´ã‚¿ã‚¤ãƒ« */
  .tile.unplaceable { opacity:0.35; cursor:not-allowed !important; filter:grayscale(0.5); }
  .tile.unplaceable:hover { transform:none !important; box-shadow:none !important; border-color:#c8c0a8 !important; }
  /* æ‰‹æœ­ã‚¨ãƒªã‚¢å†…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
  .player-action-bar { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .btn-sm { font-family:'Roboto Mono',monospace; font-size:0.65rem; letter-spacing:0.5px; text-transform:uppercase;
    padding:5px 12px; border-radius:3px; border:1px solid var(--border); cursor:pointer;
    transition:all 0.15s; background:transparent; color:var(--text); }
  .btn-sm:hover:not(:disabled) { border-color:var(--accent); color:var(--accent); }
  .btn-sm:disabled { opacity:0.3; cursor:not-allowed; }
  .btn-sm.accent { border-color:var(--accent2); color:var(--accent2); }
  .btn-sm.accent:hover:not(:disabled) { background:rgba(224,92,75,0.1); }
  /* ã²ã£ãã‚Šè¿”ã™ãƒœã‚¿ãƒ³ï¼ˆãƒãƒŠãƒ¼å†…ï¼‰ */
  .flip-btn { font-family:'Roboto Mono',monospace; font-size:0.65rem; letter-spacing:0.5px; text-transform:uppercase;
    padding:5px 14px; border-radius:3px; border:1px solid rgba(232,212,77,0.4); cursor:pointer;
    transition:all 0.15s; background:rgba(232,212,77,0.08); color:var(--accent); }
  .flip-btn:hover { background:rgba(232,212,77,0.2); border-color:var(--accent); }

  /* Setup orange tiles */
  .tile.to-place{background:#241800;border-color:#7a4800;color:#e8b040;cursor:pointer;}
  .tile.to-place:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 6px 16px rgba(232,180,40,0.35);}
  .tile.to-place.src-selected{border-color:var(--accent) !important;box-shadow:0 0 0 3px rgba(232,212,77,0.5) !important;transform:translateY(-8px) !important;background:#342200;}

  /* Gap slot */
  .gap-slot{width:14px;height:60px;border-radius:4px;border:2px dashed transparent;cursor:default;display:flex;align-items:center;justify-content:center;transition:all 0.12s;flex-shrink:0;font-size:0.9rem;color:transparent;}
  .gap-slot.droppable{border-color:transparent;background:transparent;cursor:pointer;color:var(--accent);}
  .gap-slot.droppable:hover{color:#fff;transform:scale(1.3);}

  /* ã‚¿ã‚¤ãƒ«å·®ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡ */
  @keyframes tile-insert{
    0%  {transform:translateY(-28px) scale(0.85);opacity:0;}
    60% {transform:translateY(4px) scale(1.06);opacity:1;}
    100%{transform:translateY(0) scale(1);opacity:1;}
  }
  .tile.just-inserted{
    animation:tile-insert 0.28s cubic-bezier(0.22,1,0.36,1) forwards;
  }
  /* è£ã‚¿ã‚¤ãƒ«äº¤æ›ã‚¢ãƒ‹ãƒ¡ï¼ˆå‡ºã¦ã„ãå´ï¼‰ */
  @keyframes tile-out{
    0%  {transform:translateY(0) scale(1);opacity:1;}
    100%{transform:translateY(20px) scale(0.7);opacity:0;}
  }
  .tile.just-swapped-out{
    animation:tile-out 0.22s ease forwards;
  }
  /* è£ã‚¿ã‚¤ãƒ«äº¤æ›ã‚¢ãƒ‹ãƒ¡ï¼ˆå…¥ã£ã¦ãã‚‹å´ï¼‰ */
  @keyframes tile-in{
    0%  {transform:translateY(-20px) scale(0.7);opacity:0;}
    100%{transform:translateY(0) scale(1);opacity:1;}
  }
  .tile.just-swapped-in{
    animation:tile-in 0.25s cubic-bezier(0.22,1,0.36,1) forwards;
  }
  /* â”€â”€ åŠ¹æœã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
  #effectCardModal{
    position:fixed;inset:0;background:rgba(0,0,0,0.88);
    display:flex;align-items:center;justify-content:center;
    z-index:400;backdrop-filter:blur(8px);
    opacity:0;pointer-events:none;transition:opacity 0.25s;
  }
  #effectCardModal.show{opacity:1;pointer-events:all;}

  /* å˜ä½“ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—çµæœãƒ»è¦³æˆ¦è€…ç”¨ï¼‰ */
  #effectCardInner{
    background:var(--surface);border:2px solid var(--accent);
    border-radius:12px;padding:32px 36px;max-width:400px;width:92%;
    text-align:center;
  }
  #effectCardInner .ec-name{
    font-family:'Bebas Neue',cursive;font-size:2.4rem;letter-spacing:4px;
    color:var(--text);margin-bottom:12px;line-height:1.1;
  }
  #effectCardInner .ec-desc{
    font-size:0.72rem;color:#888;line-height:1.8;margin-bottom:22px;
    min-height:40px;white-space:pre-line;
  }
  #effectCardInner .ec-buttons{display:flex;gap:8px;flex-direction:column;}
  .ec-use-btn{
    font-family:'Roboto Mono',monospace;font-size:0.75rem;letter-spacing:2px;
    padding:12px;border-radius:4px;
    border:1px solid var(--accent);background:rgba(232,212,77,0.1);
    color:var(--accent);cursor:pointer;transition:all 0.15s;
  }
  .ec-use-btn:hover{background:rgba(232,212,77,0.25);}
  @keyframes ec-reveal{
    0%  {transform:rotateY(90deg) scale(0.8);opacity:0;}
    60% {transform:rotateY(-8deg) scale(1.04);opacity:1;}
    100%{transform:rotateY(0deg) scale(1);opacity:1;}
  }
  #effectCardInner.reveal{animation:ec-reveal 0.45s cubic-bezier(0.22,1,0.36,1) forwards;}

  /* 2æšé¸æŠãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  #ecChoiceWrap{
    display:flex;align-items:stretch;gap:0;
    max-width:700px;width:96%;
  }
  .ec-card-choice{
    flex:1;background:var(--surface);
    padding:32px 28px;text-align:center;
    cursor:pointer;
    transition:background 0.15s,transform 0.15s,box-shadow 0.15s;
    position:relative;
    border:2px solid var(--border);
  }
  .ec-card-choice:first-child{border-radius:12px 0 0 12px;}
  .ec-card-choice:last-child{border-radius:0 12px 12px 0;}
  .ec-card-choice:hover{
    background:var(--panel);
    transform:translateY(-6px) scale(1.02);
    z-index:2;
  }
  .ec-card-choice .ec-card-label{
    font-size:0.55rem;letter-spacing:3px;color:var(--muted);
    margin-bottom:14px;text-transform:uppercase;
  }
  .ec-card-choice .ec-card-name{
    font-family:'Bebas Neue',cursive;font-size:1.9rem;letter-spacing:3px;
    line-height:1.1;margin-bottom:14px;
  }
  .ec-card-choice .ec-card-divider{
    width:40px;height:2px;margin:0 auto 14px;border-radius:2px;
  }
  .ec-card-choice .ec-card-desc{
    font-size:0.65rem;color:#777;line-height:1.85;white-space:pre-line;
  }
  .ec-card-choice .ec-card-select{
    margin-top:22px;font-size:0.6rem;letter-spacing:2px;
    color:var(--muted);text-transform:uppercase;
    transition:color 0.15s;
  }
  .ec-card-choice:hover .ec-card-select{color:var(--text);}

  /* ä¸Šéƒ¨ãƒ©ãƒ™ãƒ« */
  #ecChoiceLabel{
    text-align:center;font-size:0.58rem;letter-spacing:3px;
    color:var(--accent);margin-bottom:16px;text-transform:uppercase;
  }
  @keyframes ec-choice-in{
    0%  {opacity:0;transform:translateY(24px);}
    100%{opacity:1;transform:translateY(0);}
  }
  #ecChoiceWrap .ec-card-choice{
    animation:ec-choice-in 0.35s cubic-bezier(0.22,1,0.36,1) both;
  }
  #ecChoiceWrap .ec-card-choice:nth-child(3){animation-delay:0.08s;}
  /* é¸æŠã‚¢ãƒ‹ãƒ¡ */
  @keyframes ec-selected{
    0%  {transform:translateY(0) scale(1);}
    25% {transform:translateY(-18px) scale(1.06);}
    60% {transform:translateY(-14px) scale(1.08);box-shadow:0 24px 60px rgba(0,0,0,0.6);}
    100%{transform:translateY(-14px) scale(1.08);opacity:1;}
  }
  @keyframes ec-rejected{
    0%  {transform:translateY(0) scale(1);opacity:1;}
    30% {transform:translateY(6px) scale(0.97);opacity:0.5;}
    100%{transform:translateY(12px) scale(0.94);opacity:0;filter:blur(2px);}
  }
  @keyframes ec-modal-fadeout{
    0%  {opacity:1;}
    60% {opacity:1;}
    100%{opacity:0;}
  }
  .ec-card-choice.selected{
    animation:ec-selected 0.5s cubic-bezier(0.22,1,0.36,1) forwards !important;
    z-index:10;
  }
  .ec-card-choice.rejected{
    animation:ec-rejected 0.45s cubic-bezier(0.4,0,1,1) forwards !important;
    pointer-events:none;
  }
  #effectCardModal.closing{
    animation:ec-modal-fadeout 0.7s ease forwards;
    pointer-events:none;
  }

  /* ä¸€ã‹å…«ã‹: ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—æ¼”å‡º */
  @keyframes coin-spin{
    0%  {transform:rotateY(0deg);}
    100%{transform:rotateY(1800deg);}
  }
  #coinFlipDisplay{
    width:80px;height:80px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-size:2rem;margin:0 auto 16px;
    border:3px solid var(--accent);
    background:var(--panel);
  }
  #coinFlipDisplay.spinning{
    animation:coin-spin 1.2s cubic-bezier(0.22,1,0.36,1) forwards;
  }
  /* ä¸€ã‹å…«ã‹: å±±æœ­/æ¨ã¦å ´ã‚¿ã‚¤ãƒ«é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .tile.ikka-target{
    border-color:#ffd700 !important;
    box-shadow:0 0 14px rgba(255,215,0,0.8) !important;
    cursor:pointer !important;
    animation:ikka-pulse 0.6s ease infinite;
  }
  @keyframes ikka-pulse{
    0%,100%{box-shadow:0 0 8px 2px rgba(255,215,0,0.6);}
    50%{box-shadow:0 0 22px 6px rgba(255,215,0,0.3);}
  }

  /* ã©ã‚“ãã‚Šã“ã‚ã“ã‚: å¯¾è±¡ã‚¿ã‚¤ãƒ«é¸æŠ */
  .tile.donguri-target{
    border-color:#f0a030 !important;
    box-shadow:0 0 12px rgba(240,160,48,0.7) !important;
    cursor:crosshair !important;
    animation:donguri-pulse 0.7s ease infinite;
  }
  @keyframes donguri-pulse{
    0%,100%{box-shadow:0 0 6px 2px rgba(240,160,48,0.5);}
    50%{box-shadow:0 0 20px 6px rgba(240,160,48,0.25);}
  }
  /* ã©ã‚“ãã‚Šã“ã‚ã“ã‚ç™ºå‹•: è£è¿”ã—ã‚¢ãƒ‹ãƒ¡ */
  @keyframes donguri-flip{
    0%  {transform:rotateY(0deg) scale(1);}
    20% {transform:rotateY(90deg) scale(1.3) translateY(-20px);filter:brightness(2);}
    50% {transform:rotateY(180deg) scale(1.4) translateY(-28px);filter:brightness(2.5) hue-rotate(30deg);}
    80% {transform:rotateY(270deg) scale(1.2) translateY(-16px);filter:brightness(1.5);}
    100%{transform:rotateY(360deg) scale(1) translateY(0);filter:brightness(1);}
  }
  @keyframes donguri-glow{
    0%,100%{box-shadow:0 0 0px rgba(240,160,48,0);}
    40%{box-shadow:0 0 40px 16px rgba(240,160,48,0.7);}
  }
  .tile.donguri-flipping{
    animation:donguri-flip 0.9s cubic-bezier(0.22,1,0.36,1) forwards,
              donguri-glow 0.9s ease forwards !important;
    z-index:50;
  }
  /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¹ãƒ­ãƒƒãƒˆå¼ï¼‰ */
  #rouletteModal{
    position:fixed;inset:0;background:rgba(0,0,0,0.88);
    display:flex;align-items:center;justify-content:center;
    z-index:410;backdrop-filter:blur(8px);
    opacity:0;pointer-events:none;transition:opacity 0.25s;
  }
  #rouletteModal.show{opacity:1;pointer-events:all;}
  #rouletteInner{
    background:var(--surface);border:2px solid #ff8c00;
    border-radius:12px;padding:28px 36px;max-width:380px;width:92%;
    text-align:center;
  }
  #rouletteTitle{
    font-family:'Bebas Neue',cursive;font-size:1.5rem;letter-spacing:4px;
    color:#ff8c00;margin-bottom:18px;
  }
  /* ã‚¹ãƒ­ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
  #rouletteWindow{
    overflow:hidden;height:72px;
    border:2px solid #ff8c00;border-radius:6px;
    background:var(--bg);margin:0 auto 8px;
    position:relative;
  }
  /* ä¸Šä¸‹ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¯ */
  #rouletteWindow::before,#rouletteWindow::after{
    content:'';position:absolute;left:0;right:0;height:20px;z-index:2;pointer-events:none;
  }
  #rouletteWindow::before{top:0;background:linear-gradient(to bottom,var(--bg),transparent);}
  #rouletteWindow::after{bottom:0;background:linear-gradient(to top,var(--bg),transparent);}
  /* ä¸­å¤®ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ©ã‚¤ãƒ³ */
  #rouletteLine{
    position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);
    height:2px;background:#ff8c00;z-index:3;opacity:0.6;
  }
  #rouletteTrack{
    display:flex;flex-direction:column;
    transition:transform 0s;
  }
  .roulette-item{
    height:72px;display:flex;align-items:center;justify-content:center;
    font-family:'Bebas Neue',cursive;font-size:2.2rem;letter-spacing:4px;
    color:var(--text);flex-shrink:0;
  }
  .roulette-item.winner{color:#ff8c00;}
  #rouletteResult{
    font-size:0.65rem;color:#888;letter-spacing:2px;min-height:20px;margin-top:8px;
  }

  /* ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ */
  .lf-player-btn{
    font-family:'Roboto Mono',monospace;font-size:0.68rem;letter-spacing:1px;
    padding:9px 16px;border-radius:4px;border:1px solid #e070f0;
    background:rgba(224,112,240,0.08);color:#e070f0;cursor:pointer;
    transition:all 0.15s;width:100%;margin-bottom:6px;
  }
  .lf-player-btn:hover{background:rgba(224,112,240,0.22);}

  /* è¬åœ‹é©šå¤©æŒãƒœã‚¿ãƒ³ */
  .btn-sm.mankoku{
    border-color:#c040e0;color:#c040e0;
    background:rgba(192,64,224,0.06);
    letter-spacing:0.3px;
    animation:mankoku-pulse 1.4s ease infinite;
  }
  .btn-sm.mankoku:hover:not(:disabled){
    background:rgba(192,64,224,0.18);border-color:#d870f8;color:#d870f8;
  }
  @keyframes mankoku-pulse{
    0%,100%{box-shadow:0 0 0 0 rgba(192,64,224,0.4);}
    50%{box-shadow:0 0 8px 2px rgba(192,64,224,0.2);}
  }
  /* è¬åœ‹é©šå¤©æŒ: å¯¾è±¡ã‚¿ã‚¤ãƒ«é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .tile.mankoku-target{
    border-color:#c040e0 !important;
    box-shadow:0 0 10px rgba(192,64,224,0.6) !important;
    cursor:crosshair !important;
    animation:mankoku-target-pulse 0.8s ease infinite;
  }
  @keyframes mankoku-target-pulse{
    0%,100%{box-shadow:0 0 6px 1px rgba(192,64,224,0.5);}
    50%{box-shadow:0 0 18px 4px rgba(192,64,224,0.3);}
  }
  /* è¬åœ‹é©šå¤©æŒç™ºå‹•ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  @keyframes mankoku-hit{
    0%  {filter:brightness(1) saturate(1);}
    20% {filter:brightness(2.5) saturate(0) hue-rotate(270deg);}
    60% {filter:brightness(1.5) saturate(2) hue-rotate(180deg);}
    100%{filter:brightness(1) saturate(1);}
  }
  .tile.mankoku-hit{
    animation:mankoku-hit 0.6s ease forwards !important;
  }
  /* é€£ç•ªéš£æ¥ã‚¹ãƒ­ãƒƒãƒˆ â€” å·®ã—è¾¼ã¿ç¦æ­¢ */
  .gap-slot.blocked{
    width:8px;cursor:not-allowed;
    background:repeating-linear-gradient(45deg,rgba(224,92,75,0.12),rgba(224,92,75,0.12) 2px,transparent 2px,transparent 5px);
    border-color:rgba(224,92,75,0.25);
    color:transparent;
  }

  /* Setup panel */
  .setup-panel{margin-top:12px;padding-top:10px;border-top:1px solid var(--border);}
  .setup-panel-label{font-size:0.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
  .reveal-hand{display:flex;gap:8px;flex-wrap:wrap;}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CENTER ZONE â€” Pool spread + Discard
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .center-zone{
    background:var(--panel);
    border-top:1px solid var(--border);border-bottom:1px solid var(--border);
    padding:16px 24px;
    display:flex;flex-direction:column;gap:14px;
  }

  /* Pool spread row */
  .pool-section{}
  .pool-label-row{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
  .center-label{font-size:0.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);}
  .pool-count-badge{
    font-size:0.6rem;color:var(--muted);border:1px solid var(--border);
    padding:1px 7px;border-radius:10px;letter-spacing:1px;
  }
  .pool-grid{
    display:flex;flex-wrap:wrap;gap:4px;
    max-height:200px;overflow-y:auto;
    padding:4px 0;
  }
  /* Pool tiles: face-down but clickable */
  .tile.pool-tile{cursor:pointer;border-color:var(--face-down-border);}
  .tile.pool-tile:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(42,74,106,0.6);border-color:#4a8aba;}
  /* Pool tile that has been selected (flipping) */
  .tile.pool-tile.flipping{
    animation:flipCard 0.35s ease forwards;
    pointer-events:none;
  }
  @keyframes flipCard{
    0%  {transform:rotateY(0deg)   translateY(0);}
    50% {transform:rotateY(90deg)  translateY(-8px);}
    100%{transform:rotateY(0deg)   translateY(-8px);border-color:var(--accent);box-shadow:0 0 16px rgba(232,212,77,0.5);}
  }

  /* â”€â”€ DRAWN CARD BANNER â”€â”€ */
  .drawn-banner{
    display:flex;align-items:center;gap:16px;
    background:rgba(232,212,77,0.07);
    border:1px solid rgba(232,212,77,0.2);
    border-radius:6px;
    padding:10px 18px;
    margin-bottom:4px;
  }
  .drawn-banner.hidden{display:none;}
  .drawn-card-display{
    width:56px;height:70px;border-radius:6px;
    background:var(--revealed);border:2px solid var(--accent);
    color:var(--revealed-text);
    display:flex;align-items:center;justify-content:center;
    font-size:1.4rem;font-weight:700;letter-spacing:-1px;
    box-shadow:0 0 16px rgba(232,212,77,0.35);
    flex-shrink:0;
  }
  .drawn-banner-text{display:flex;flex-direction:column;gap:4px;}
  .drawn-banner-title{font-size:0.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--accent);}
  .drawn-banner-sub{font-size:0.72rem;color:var(--text);}
  .drawn-banner-rev{font-size:0.62rem;color:var(--muted);}

  /* â”€â”€ DISCARD ZONE â”€â”€ */
  .discard-section{}
  .discard-scroll{display:flex;flex-wrap:wrap;gap:6px;max-height:180px;overflow-y:auto;padding:2px 0;}
  /* Discard tile with attribution */
  .discard-entry{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;}
  .discard-entry .tile{cursor:pointer;}
  .discard-entry .tile:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 6px 16px rgba(232,212,77,0.3);}
  .discard-who{font-size:0.52rem;color:var(--muted);letter-spacing:0.5px;max-width:48px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  /* NEW label on freshly discarded tile */
  .discard-entry .new-dot{
    position:absolute;top:-4px;right:-4px;
    width:10px;height:10px;border-radius:50%;
    background:var(--accent2);
    border:2px solid var(--panel);
    animation:blink 1s ease infinite;
  }
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}

  /* â”€â”€ ACTION PANEL â”€â”€ */
  .action-panel{padding:12px 24px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);background:var(--surface);min-height:54px;}
  .action-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);min-width:70px;}
  .btn{font-family:'Roboto Mono',monospace;font-size:0.7rem;letter-spacing:1px;text-transform:uppercase;padding:7px 14px;border-radius:3px;border:1px solid var(--border);cursor:pointer;transition:all 0.15s;background:transparent;color:var(--text);}
  .btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent);}
  .btn.primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600;}
  .btn.primary:hover:not(:disabled){background:#f0e060;}
  .btn:disabled{opacity:0.3;cursor:not-allowed;}
  .btn.danger{border-color:var(--accent2);color:var(--accent2);}
  .btn.danger:hover:not(:disabled){background:rgba(224,92,75,0.1);}

  .phase-hint{font-size:0.67rem;color:var(--accent);letter-spacing:0.4px;padding:8px 24px;background:rgba(232,212,77,0.04);border-bottom:1px solid rgba(232,212,77,0.07);min-height:32px;}

  /* â”€â”€ LOG (top-fixed, 4 lines) â”€â”€ */
  .log-wrap{
    padding:6px 24px;
    background:var(--surface);
    border-bottom:1px solid var(--border);
    overflow:hidden;
    flex-shrink:0;
  }
  .log-entry{font-size:0.63rem;color:var(--muted);padding:1px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .log-entry.highlight{color:var(--accent);}
  .log-entry.error{color:var(--accent2);}
  .log-entry .ts{color:#333;margin-right:8px;}

  /* â”€â”€ OVERLAYS â”€â”€ */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.87);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px);overflow-y:auto;}
  .overlay.hidden{display:none;}
  .overlay-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:40px 50px;text-align:center;max-width:480px;width:90%;}
  .overlay-card h1{font-family:'Bebas Neue',cursive;font-size:3.5rem;letter-spacing:6px;color:var(--accent);margin-bottom:8px;}
  .overlay-card p{color:var(--muted);font-size:0.8rem;line-height:1.8;margin-bottom:22px;}
  .overlay-card .subtitle{font-family:'Bebas Neue',cursive;font-size:1.1rem;letter-spacing:3px;color:var(--text);margin-bottom:18px;}
  .setup-options{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
  .setup-row{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .setup-row label{font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);}
  .setup-row select,.setup-row input{background:var(--panel);border:1px solid var(--border);color:var(--text);font-family:'Roboto Mono',monospace;font-size:0.7rem;padding:6px 10px;border-radius:3px;}
  .win-stats{display:flex;gap:28px;justify-content:center;margin-bottom:20px;}
  .win-stat .val{font-family:'Bebas Neue',cursive;font-size:2.5rem;color:var(--accent);line-height:1;}
  .win-stat .lbl{font-size:0.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-top:4px;}

  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

  /* â”€â”€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ â”€â”€ */
  .version-badge{
    font-family:'Roboto Mono',monospace;
    font-size:0.58rem;letter-spacing:1px;
    color:var(--muted);cursor:pointer;
    border:1px solid var(--border);
    border-radius:3px;padding:2px 7px;
    transition:all 0.15s;
    text-decoration:none;display:inline-block;
  }
  .version-badge:hover{border-color:var(--accent);color:var(--accent);}

  /* â”€â”€ ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
  #changelogOverlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.88);
    display:flex;align-items:center;justify-content:center;
    z-index:500;backdrop-filter:blur(4px);
    opacity:0;pointer-events:none;transition:opacity 0.18s;
  }
  #changelogOverlay.show{opacity:1;pointer-events:all;}
  #changelogCard{
    background:var(--surface);border:1px solid var(--border);
    border-radius:8px;padding:32px 36px;
    max-width:480px;width:92%;max-height:80vh;
    overflow-y:auto;
  }
  #changelogCard h2{
    font-family:'Bebas Neue',cursive;font-size:1.8rem;
    letter-spacing:4px;color:var(--accent);margin-bottom:20px;
  }
  .cl-version{margin-bottom:22px;}
  .cl-version-head{
    display:flex;align-items:baseline;gap:10px;margin-bottom:8px;
  }
  .cl-ver-num{
    font-family:'Bebas Neue',cursive;font-size:1.1rem;
    letter-spacing:2px;color:var(--text);
  }
  .cl-ver-date{font-size:0.58rem;color:var(--muted);letter-spacing:1px;}
  .cl-ver-current{
    font-size:0.55rem;background:var(--accent);color:#000;
    padding:1px 6px;border-radius:2px;font-weight:700;letter-spacing:1px;
  }
  .cl-items{list-style:none;display:flex;flex-direction:column;gap:5px;}
  .cl-items li{
    font-size:0.68rem;color:var(--muted);padding-left:14px;position:relative;line-height:1.6;
  }
  .cl-items li::before{content:'â€”';position:absolute;left:0;color:var(--border);}
  .cl-items li.highlight{color:var(--text);}
  .cl-items li.highlight::before{content:'âœ¦';color:var(--accent);}
  #changelogClose{
    width:100%;margin-top:20px;
    font-family:'Roboto Mono',monospace;font-size:0.68rem;
    letter-spacing:2px;text-transform:uppercase;
    padding:9px;border-radius:3px;
    border:1px solid var(--border);cursor:pointer;
    background:transparent;color:var(--muted);transition:all 0.15s;
  }
  #changelogClose:hover{border-color:var(--accent);color:var(--accent);}

  /* â”€â”€ ç½®ã‘ã‚‹ä½ç½®ãƒã‚¤ãƒ©ã‚¤ãƒˆ â”€â”€ */
  .tile.can-place{
    border-color:#3a8a5a !important;
    box-shadow:0 0 8px rgba(58,180,100,0.35) !important;
    cursor:pointer;
  }
  .tile.can-place:hover{
    transform:translateY(-4px) !important;
    box-shadow:0 6px 18px rgba(58,180,100,0.55) !important;
    border-color:#5adc80 !important;
  }
  .tile.cannot-place{
    opacity:0.3;
    filter:grayscale(0.6);
  }

  /* â”€â”€ é€£ç•ªé”æˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ â”€â”€ */
  @keyframes bonus-glow{
    0%  {box-shadow:0 0 0 0 rgba(232,212,77,0.9);transform:translateY(-2px);}
    40% {box-shadow:0 0 0 12px rgba(232,212,77,0);transform:translateY(-8px);}
    60% {box-shadow:0 0 0 20px rgba(232,212,77,0);transform:translateY(-4px);}
    100%{box-shadow:0 0 0 0 rgba(232,212,77,0);transform:translateY(0);}
  }
  .tile.bonus-flash{
    animation:bonus-glow 0.7s ease forwards !important;
    border-color:var(--accent) !important;
    background:#fff8dc !important;
    color:#000 !important;
    z-index:10;
  }

  /* â”€â”€ ã‚¿ãƒ¼ãƒ³ç§»è¡ŒãƒãƒŠãƒ¼ â”€â”€ */
  #turnBanner{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.7);
    background:rgba(13,13,13,0.93);border:2px solid var(--accent);
    border-radius:8px;padding:18px 48px;z-index:300;
    font-family:'Bebas Neue',cursive;font-size:2.2rem;letter-spacing:6px;
    color:var(--accent);text-align:center;pointer-events:none;
    opacity:0;transition:opacity 0.15s,transform 0.15s;
  }
  #turnBanner.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
  #turnBanner small{display:block;font-family:'Roboto Mono',monospace;font-size:0.6rem;letter-spacing:3px;color:var(--muted);margin-top:4px;}

  /* â”€â”€ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ â”€â”€ */
  #particles{position:fixed;inset:0;pointer-events:none;z-index:290;overflow:hidden;}
  .particle{
    position:absolute;width:6px;height:6px;border-radius:50%;
    animation:particle-fall linear forwards;
  }
  @keyframes particle-fall{
    0%  {opacity:1;transform:translate(0,0) scale(1);}
    100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0.2);}
  }

  /* â”€â”€ LOBBY â”€â”€ */
  .lobby-player{
    display:flex;align-items:center;gap:10px;
    padding:8px 12px;border-radius:4px;
    background:var(--panel);border:1px solid var(--border);
    font-size:0.75rem;
  }
  .lobby-player.is-me{border-color:var(--accent);}
  .lobby-player .lp-name{flex:1;letter-spacing:1px;}
  .lobby-player .lp-host{
    font-size:0.55rem;background:var(--accent);color:#000;
    padding:2px 6px;border-radius:2px;font-weight:700;letter-spacing:1px;
  }
  .lobby-player .lp-you{
    font-size:0.55rem;border:1px solid var(--accent);color:var(--accent);
    padding:2px 6px;border-radius:2px;letter-spacing:1px;
  }
</style>
</head>
<body>

<!-- TITLE: æ¥ç¶šç”»é¢ -->
<div class="overlay" id="titleOverlay">
  <div class="overlay-card" style="max-width:400px;">
    <h1>NUMLETTO</h1>
    <p style="margin-bottom:24px;">1ã€œ100ã®ã‚¿ã‚¤ãƒ«ã‚’æ˜‡é †ã«ä¸¦ã¹ã‚ã€‚<br>æˆ¦ç•¥ã¨é‹ãŒäº¤å·®ã™ã‚‹æ•°å­—ã®æ ¼é—˜æŠ€ã€‚</p>
    <div class="setup-options" style="gap:12px;">
      <div class="setup-row">
        <label>å å‰</label>
        <input type="text" id="myNameInput" placeholder="ã‚ãªãŸã®åå‰" maxlength="12"
          style="font-size:0.85rem;padding:10px 12px;"
          onkeydown="if(event.key==='Enter')connectAction()">
      </div>
      <div class="setup-row">
        <label>åˆè¨€è‘‰</label>
        <input type="text" id="roomIdInput" placeholder="ãƒ«ãƒ¼ãƒ åˆè¨€è‘‰"
          style="text-transform:uppercase;font-size:0.85rem;padding:10px 12px;"
          onkeydown="if(event.key==='Enter')connectAction()">
      </div>
    </div>
    <p style="font-size:0.6rem;color:var(--muted);margin:10px 0 16px;">åŒã˜åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ãŸäººãŒåŒã˜éƒ¨å±‹ã«é›†ã¾ã‚Šã¾ã™</p>
    <button class="btn primary" id="btnConnect" onclick="connectAction()"
      style="width:100%;padding:12px;font-size:0.8rem;letter-spacing:2px;">ENTER ROOM</button>
    <p id="connectError" style="font-size:0.65rem;color:var(--accent2);margin-top:8px;min-height:16px;"></p>
    <div style="text-align:center;margin-top:12px;">
      <span class="version-badge" onclick="openChangelog()">beta 2.0.8</span>
    </div>
  </div>
</div>

<!-- LOBBY: å¾…åˆå®¤ -->
<div class="overlay hidden" id="lobbyOverlay">
  <div class="overlay-card" style="max-width:400px;">
    <h1>NUMLETTO</h1>
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:6px;">
      <span class="subtitle" id="lobbyRoomLabel" style="margin-bottom:0;">ROOM: â€”</span>
    </div>
    <p style="color:var(--muted);font-size:0.68rem;margin-bottom:16px;">å‚åŠ è€…ãŒæƒã£ãŸã‚‰ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
    <div id="lobbyPlayerList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;min-height:60px;"></div>
    <button class="btn primary" id="btnStartGame" onclick="hostStartGame()"
      style="width:100%;padding:12px;font-size:0.8rem;letter-spacing:2px;display:none;">GAME START</button>
    <p id="lobbyWaitMsg" style="font-size:0.65rem;color:var(--muted);margin-top:4px;"></p>
    <button class="btn" onclick="leaveLobby()"
      style="width:100%;padding:8px;font-size:0.68rem;margin-top:10px;border-color:#444;color:#666;">â† é€€å‡ºã™ã‚‹</button>
  </div>
</div>

<!-- RESULT -->
<div class="overlay hidden" id="resultOverlay">
  <div class="overlay-card" style="max-width:540px;padding:28px 32px;">
    <div id="resultContent"></div>
  </div>
</div>

<!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©ï¼‰ -->
<div id="rouletteModal">
  <div id="rouletteInner">
    <div id="rouletteTitle">ğŸ˜ˆ ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©</div>
    <div id="rouletteWindow">
      <div id="rouletteLine"></div>
      <div id="rouletteTrack"></div>
    </div>
    <div id="rouletteResult"></div>
  </div>
</div>

<!-- åŠ¹æœã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="effectCardModal">
  <!-- å˜ä½“è¡¨ç¤ºï¼ˆã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ç­‰ï¼‰ -->
  <div id="effectCardInner" style="display:none;">
    <div class="ec-name" id="ecName">â€”</div>
    <div class="ec-desc" id="ecDesc">â€”</div>
    <div class="ec-buttons" id="ecButtons"></div>
  </div>
  <!-- 2æšé¸æŠè¡¨ç¤º -->
  <div id="ecChoiceContainer" style="display:none;width:96%;max-width:720px;">
    <div id="ecChoiceLabel">âœ¦ EFFECT CARD â€” ã©ã¡ã‚‰ã‚’ç™ºå‹•ã—ã¾ã™ã‹ï¼Ÿ âœ¦</div>
    <div id="ecChoiceWrap"></div>
  </div>
</div>

<!-- ã‚¿ãƒ¼ãƒ³ç§»è¡ŒãƒãƒŠãƒ¼ -->
<div id="turnBanner"><span id="turnBannerName">â€”</span><small>YOUR TURN</small></div>

<!-- ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚° -->
<div id="changelogOverlay" onclick="if(event.target===this)closeChangelog()">
  <div id="changelogCard">
    <h2>CHANGELOG</h2>
    <div id="changelogContent"></div>
    <button id="changelogClose" onclick="closeChangelog()">CLOSE</button>
  </div>
</div>
<!-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
<div id="particles"></div>

<header>
  <div class="logo"><span style="color:var(--accent)">NUM</span><span style="color:var(--accent2)">LETTO</span></div>
  <div class="status-bar">
    <span id="hdrTurn" class="turn-indicator">SETUP</span>
    <span id="hdrRound">â€”</span>
    <span id="hdrDir" style="font-size:0.58rem;color:var(--muted);letter-spacing:1px;" title="ã‚¿ãƒ¼ãƒ³æ–¹å‘"></span>
    <span id="hdrPool">POOL: â€”</span>
    <label style="display:flex;align-items:center;gap:6px;font-size:0.6rem;color:var(--muted);cursor:pointer;">
      <span id="volIcon" style="font-size:0.85rem;">ğŸ”Š</span>
      <input type="range" id="volSlider" min="0" max="1" step="0.05" value="0.7"
        oninput="setVolume(this.value)"
        style="width:64px;accent-color:var(--accent);cursor:pointer;">
    </label>
    <button class="btn" onclick="location.reload()" style="padding:3px 9px;font-size:0.62rem;">â†º NEW</button>
    <span class="version-badge" onclick="openChangelog()" id="hdrVersion">beta 2.0.8</span>
  </div>
</header>

<!-- LOG: 4 lines fixed under header -->
<div class="log-wrap" id="logWrap"></div>

<div class="game-wrap" id="gameWrap">

  <!-- CENTER ZONE (hidden during setup) -->
  <div class="center-zone" id="centerZone" style="display:none">

    <!-- â‘  å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ -->
    <div class="drawn-banner hidden" id="drawnBanner">
      <div class="drawn-card-display" id="drawnCardDisplay">â€”</div>
      <div class="drawn-banner-text">
        <div class="drawn-banner-title">âœ¦ å¼•ã„ãŸã‚¿ã‚¤ãƒ«</div>
        <div class="drawn-banner-sub" id="drawnBannerSub">â€”</div>
        <div class="drawn-banner-rev" id="drawnBannerRev"></div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
          <button class="flip-btn" id="btnFlipDrawn" onclick="flipDrawnTile()" style="display:none;">âŸ³ ã²ã£ãã‚Šè¿”ã™</button>
          <button class="flip-btn" id="btnCannotPlace" onclick="cannotPlace()" style="display:none;border-color:rgba(224,92,75,0.5);color:var(--accent2);background:rgba(224,92,75,0.06);">æ¨ã¦ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- â‘¡ å±±æœ­ï¼ˆå…¨å±•é–‹ï¼‰ -->
    <div class="pool-section">
      <div class="pool-label-row">
        <span class="center-label">å±± æœ­</span>
        <span class="pool-count-badge" id="poolCountBadge">â€” æš</span>
        <span style="font-size:0.58rem;color:var(--muted);">è£å‘ãã®ã‚¿ã‚¤ãƒ«ã‹ã‚‰1æšé¸ã‚“ã§å¼•ã</span>
      </div>
      <div class="pool-grid" id="poolGrid"></div>
    </div>

    <!-- â‘¢ æ¨ã¦å ´ -->
    <div class="discard-section">
      <div class="pool-label-row">
        <span class="center-label">æ¨ã¦å ´</span>
        <span style="font-size:0.58rem;color:var(--muted);">æ¨ã¦ã‚‰ã‚ŒãŸã‚¿ã‚¤ãƒ«ï¼ˆè£å‘ãï¼‰â€” ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ãã£ã¦å–å¾—</span>
      </div>
      <div class="discard-scroll" id="discardScroll"></div>
    </div>

  </div>

  <!-- ACTION PANEL: hint + ç½®ã‘ãªã„ãƒœã‚¿ãƒ³ã®ã¿ -->
  <div class="action-panel" id="actionPanel" style="display:none">
    <span class="action-label">ACTION</span>
    <span id="actionHint" style="font-size:0.67rem;color:var(--muted);"></span>
  </div>

  <div class="phase-hint" id="phaseHint" style="display:none"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONLINE: WebSocket (PartyKit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PARTYKIT_URL = 'https://numeretto-server.seunggiwe.partykit.dev';
let ws = null;
let myName = '';
let myConnId = null;
let amIHost = false;
let currentRoomId = '';
let intentionalClose = false; // æ„å›³çš„åˆ‡æ–­ãƒ•ãƒ©ã‚°
let reconnectTimer = null;
let heartbeatTimer = null;
let reconnectAttempt = 0; // ãƒãƒƒã‚¯ã‚ªãƒ•ç”¨ã‚«ã‚¦ãƒ³ã‚¿

// ã€Œæ¥ç¶šã™ã‚‹ã€ãƒœã‚¿ãƒ³
function connectAction(){
  const name = document.getElementById('myNameInput').value.trim();
  const room = document.getElementById('roomIdInput').value.trim().toUpperCase();
  const errEl = document.getElementById('connectError');
  if(!name){ errEl.textContent='åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  if(!room){ errEl.textContent='åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  errEl.textContent='';
  myName = name;
  currentRoomId = room;
  document.getElementById('btnConnect').disabled = true;
  document.getElementById('btnConnect').textContent = 'CONNECTINGâ€¦';
  connectToRoom(room);
}

// å¾…åˆå®¤ã‹ã‚‰é€€å‡º
function leaveLobby(){
  intentionalClose=true;
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
  if(reconnectTimer){ clearTimeout(reconnectTimer); reconnectTimer=null; }
  if(ws){ ws.close(); ws=null; }
  myName=''; currentRoomId=''; amIHost=false;
  document.getElementById('lobbyOverlay').classList.add('hidden');
  document.getElementById('titleOverlay').classList.remove('hidden');
  document.getElementById('btnConnect').disabled=false;
  document.getElementById('btnConnect').textContent='ENTER ROOM';
}

function connectToRoom(roomId) {
  intentionalClose = false;
  if(reconnectTimer){ clearTimeout(reconnectTimer); reconnectTimer=null; }
  if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
  if(ws){ intentionalClose=true; ws.close(); ws=null; }
  intentionalClose = false;
  ws = new WebSocket(`${PARTYKIT_URL}/party/${roomId}`);

  ws.onopen = () => {
    const isReconnect = !!G;
    ws.send(JSON.stringify({ type: 'join', name: myName, reconnect: isReconnect }));
    // Heartbeat: 5ç§’ã”ã¨ã«pingã§ã‚¢ã‚¤ãƒ‰ãƒ«åˆ‡æ–­é˜²æ­¢
    heartbeatTimer = setInterval(()=>{
      if(ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 5000);
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    // å¾…åˆå®¤æƒ…å ±
    if(msg.type === 'lobby'){
      // ã‚²ãƒ¼ãƒ ä¸­ã«å†æ¥ç¶šã—ã¦lobbyãŒè¿”ã£ã¦ããŸå ´åˆã¯resyncã‚’è¦æ±‚
      if(G && !msg.hasGame){
        // ã‚µãƒ¼ãƒãƒ¼å´ã®GãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã—ã¾ã£ãŸç¨€ãªã‚±ãƒ¼ã‚¹ â†’ ç”»é¢ã‚’å¾…åˆå®¤ã«æˆ»ã™
        showLobby(msg.players, roomId);
      } else if(G && msg.hasGame){
        // ã‚²ãƒ¼ãƒ ç¶™ç¶šä¸­ â†’ ã‚µãƒ¼ãƒãƒ¼ã«resyncè¦æ±‚
        ws.send(JSON.stringify({ type: 'resync' }));
      } else {
        showLobby(msg.players, roomId);
      }
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹ / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åŒæœŸ
    if(msg.type === 'sync'){
      if(ws) ws._attempt = 0; reconnectAttempt = 0; // å†æ¥ç¶šæˆåŠŸã§ãƒãƒƒã‚¯ã‚ªãƒ•ãƒªã‚»ãƒƒãƒˆ
      const prevAct = act;
      const prevPlayer = G ? G.currentPlayer : -1;
      G = msg.G;
      const inSetup = G.playerSetups && G.playerSetups.some(s=>!s.done);
      setupPhase = inSetup ? true : null;
      const newAct = G.act || null;

      // ä»–äººã®æ“ä½œã«ã‚ˆã‚‹SEåˆ¤å®šï¼ˆè‡ªåˆ†ã®æ“ä½œã¯æ—¢ã«é³´ã‚‰ã—ã¦ã„ã‚‹ï¼‰
      const isOtherPlayer = myName && G.players[G.currentPlayer] && G.players[G.currentPlayer].name !== myName;
      if(isOtherPlayer){
        if(!prevAct && newAct && newAct.phase==='awaitSwap') playSound('draw');
        else if(prevAct && !newAct && prevPlayer===G.currentPlayer) playSound('place');
        else if(prevAct && !newAct && prevPlayer!==G.currentPlayer) playSound('place');
        else if(!prevAct && !newAct && prevPlayer !== G.currentPlayer) {/* ã‚¿ãƒ¼ãƒ³å¤‰åŒ– */}
      }

      act = newAct;

      // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹SEï¼ˆã‚¿ãƒ¼ãƒ³ãŒè‡ªåˆ†ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸç¬é–“ï¼‰
      const myPi = myName ? G.players.findIndex(p=>p.name===myName) : -1;
      if(myPi>=0 && !inSetup && !G.gameOver){
        if(prevPlayer !== G.currentPlayer && G.currentPlayer === myPi){
          playSound('myturn');
          showTurnBanner(G.players[myPi].name);
        }
      }

      document.getElementById('titleOverlay').classList.add('hidden');
      document.getElementById('lobbyOverlay').classList.add('hidden');
      document.getElementById('centerZone').style.display = inSetup ? 'none' : '';
      document.getElementById('actionPanel').style.display = inSetup ? 'none' : '';
      document.getElementById('phaseHint').style.display = '';
      document.getElementById('hdrPool').textContent = `ROOM: ${currentRoomId}`;
      // ãƒªã‚¶ãƒ«ãƒˆåŒæœŸï¼šG.resultãŒã‚ã‚Œã°å…¨å“¡ã«ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã‚’è¡¨ç¤º
      if(G.result){
        openResult();
      } else {
        document.getElementById('resultOverlay').classList.add('hidden');
      }
      // awaitCoinFlip: å…¨å“¡ã«ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ã‚’è¡¨ç¤º
      if(G.act&&G.act.phase==='awaitCoinFlip'&&G.act.coinResult){
        const isMe = !myName||G.players[G.currentPlayer].name===myName;
        if(!isMe){
          const modal=document.getElementById('effectCardModal');
          if(!modal.classList.contains('show')){
            showCoinFlip(G.act.coinResult==='heads');
          }
        }
      } else if(!G.act||G.act.phase!=='awaitCoinFlip'){
        // ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº† â†’ è¦³æˆ¦è€…ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const isMe = !myName||(G.players[G.currentPlayer]&&G.players[G.currentPlayer].name===myName);
        if(!isMe){
          const modal=document.getElementById('effectCardModal');
          if(modal.classList.contains('show')&&document.getElementById('coinFlipDisplay')){
            closeEffectCardModal();
          }
        }
      }
      checkEffectCardSync();
      render();
    }

    // ãƒªã‚»ãƒƒãƒˆ
    if(msg.type === 'reset'){
      G = null; setupPhase = null; act = null;
      document.getElementById('lobbyOverlay').classList.remove('hidden');
    }
  };

  ws.onerror = () => {
    // onerrorã¯å¸¸ã«oncloseã®ç›´å‰ã«ç™ºç«ã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
    // å‡¦ç†ã¯oncloseã«ä¸€å…ƒåŒ–ã™ã‚‹
  };
  ws.onclose = (e) => {
    if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
    if(intentionalClose){ intentionalClose=false; return; }

    if(!myName || !currentRoomId){
      // æ¥ç¶šå‰ã®ã‚¨ãƒ©ãƒ¼ï¼ˆåˆè¨€è‘‰å…¥åŠ›ç”»é¢ï¼‰
      const errEl = document.getElementById('connectError');
      if(errEl) errEl.textContent = 'æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      document.getElementById('btnConnect').disabled = false;
      document.getElementById('btnConnect').textContent = 'ENTER ROOM';
      return;
    }

    // ã‚²ãƒ¼ãƒ ä¸­/å¾…åˆå®¤ä¸­ â†’ è‡ªå‹•å†æ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãï¼‰
    reconnectAttempt++;
    let delay = reconnectAttempt > 3 ? 8000 : reconnectAttempt > 1 ? 4000 : 2000;

    log(`æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚${delay/1000}ç§’å¾Œã«å†æ¥ç¶šâ€¦ (${reconnectAttempt}å›ç›®)`, 'error');
    reconnectTimer = setTimeout(()=>{
      connectToRoom(currentRoomId);
    }, delay);
  };
  return ws;
}

function showLobby(players, roomId){
  // ã‚¿ã‚¤ãƒˆãƒ«â†’å¾…åˆå®¤ã¸
  document.getElementById('titleOverlay').classList.add('hidden');
  document.getElementById('lobbyOverlay').classList.remove('hidden');
  document.getElementById('lobbyRoomLabel').textContent = `â€” åˆè¨€è‘‰: ${roomId} â€”`;

  // è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆã‹ï¼ˆplayersé…åˆ—ã®å…ˆé ­ãŒãƒ›ã‚¹ãƒˆï¼‰
  amIHost = players.length > 0 && players[0].isHost && players[0].name === myName;

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæç”»
  const list = document.getElementById('lobbyPlayerList');
  list.innerHTML = '';
  players.forEach(p => {
    const isMe = p.name === myName;
    const div = document.createElement('div');
    div.className = `lobby-player${isMe?' is-me':''}`;
    div.innerHTML = `
      <span class="lp-name">${p.name}</span>
      ${p.isHost ? '<span class="lp-host">HOST</span>' : ''}
      ${isMe ? '<span class="lp-you">YOU</span>' : ''}`;
    list.appendChild(div);
  });

  // ãƒ›ã‚¹ãƒˆã«ã ã‘ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  const btnStart = document.getElementById('btnStartGame');
  const waitMsg = document.getElementById('lobbyWaitMsg');
  if(amIHost){
    btnStart.style.display = '';
    btnStart.textContent = `ã‚²ãƒ¼ãƒ é–‹å§‹ (${players.length}äºº) â†’`;
    btnStart.disabled = players.length < 2;
    waitMsg.style.display = 'none';
  } else {
    btnStart.style.display = 'none';
    waitMsg.style.display = '';
  }
}

// ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ é–‹å§‹
function hostStartGame(){
  if(!amIHost || !ws) return;

  // å¾…åˆå®¤ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰åå‰ã‚’å–å¾—ã—ã¦Gç”Ÿæˆï¼ˆé †ç•ªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
  const items = document.getElementById('lobbyPlayerList').querySelectorAll('.lp-name');
  const names = shuffle([...items].map(el => el.textContent.trim()));
  const count = names.length;

  const nums = shuffle([...Array(100)].map((_,i)=>i+1));
  let idx = 0;
  const HAND_BLIND = getHandBlind(count);
  const HAND_REVEAL = getHandReveal(count);
  const players = [];
  for(let p = 0; p < count; p++){
    const hand = nums.slice(idx, idx+HAND_BLIND).map(n=>({tile:makeTile(n),revealed:false}));
    idx += HAND_BLIND;
    const revealTiles = nums.slice(idx, idx+HAND_REVEAL).map(makeTile);
    idx += HAND_REVEAL;
    revealTiles.sort((a,b)=>a.num-b.num);
    players.push({name:names[p],hand,revealTiles,revealTilesTotal:revealTiles.length,turns:0,progressHistory:[[0,0]]});
  }
  // playerSetups: å…¨å“¡åŒæ™‚ã«æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€²ã‚ã‚‹
  const playerSetups = players.map(()=>({
    currentRevealIdx:0, selectedInHand:false, useRev:false, done:false
  }));
  act = null;
  G = {
    players, currentPlayer:0,
    pool:nums.slice(idx).map(makeTile),
    discard:[], round:1, gameOver:false,
    handSize:HAND_BLIND+HAND_REVEAL,
    playerSetups,
    direction:1, // 1=æ­£å›è»¢, -1=é€†å›è»¢
  };
  act = null;

  ws.send(JSON.stringify({ type: 'start', G }));
}

function syncToServer(type='action'){
  if(ws && ws.readyState === WebSocket.OPEN){
    // actã‚’Gã«åŸ‹ã‚è¾¼ã‚“ã§ã‹ã‚‰é€ä¿¡
    G.act = act || null;
    ws.send(JSON.stringify({type, G}));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND ENGINE (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC = null; // åˆå›æ“ä½œæ™‚ã«åˆæœŸåŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®Autoplay Policyå¯¾ç­–ï¼‰
let masterVolume = 0.7;
function ensureAC(){
  if(!AC){try{AC=new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  if(AC&&AC.state==='suspended') AC.resume();
}

function setVolume(v){
  masterVolume = parseFloat(v);
  const icon = document.getElementById('volIcon');
  if(icon) icon.textContent = masterVolume === 0 ? 'ğŸ”‡' : masterVolume < 0.4 ? 'ğŸ”‰' : 'ğŸ”Š';
}

function playSound(type){
  ensureAC();
  if(!AC) return;
  const t = AC.currentTime;

  const sounds = {
    draw: ()=>{
      // ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹éŸ³: æ¥µã‚ã¦ã‚½ãƒ•ãƒˆãªã‚¿ãƒƒãƒéŸ³
      // è¶…ä½ã‚²ã‚¤ãƒ³ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºï¼ˆç´™ã®è³ªæ„Ÿã€å‰²ã‚Œãªã—ï¼‰
      const buf = AC.createBuffer(1, AC.sampleRate*0.15, AC.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<d.length;i++){
        const env = Math.pow(1 - i/d.length, 4);
        d[i] = (Math.random()*2-1) * env * 0.3;
      }
      const src = AC.createBufferSource(); src.buffer=buf;
      const lp = AC.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=800; lp.Q.value=0.5;
      const g = AC.createGain(); g.gain.setValueAtTime(0.07*masterVolume, t);
      src.connect(lp); lp.connect(g); g.connect(AC.destination); src.start(t);
      // æŸ”ã‚‰ã‹ã„ã‚µã‚¤ãƒ³æ³¢ã®å°ã•ãªã½ã‚“éŸ³ï¼ˆ220Hzã€è¶…çŸ­ã‚ï¼‰
      const osc = AC.createOscillator(); const og = AC.createGain();
      osc.type='sine'; osc.frequency.value=260;
      og.gain.setValueAtTime(0,t);
      og.gain.linearRampToValueAtTime(0.06*masterVolume, t+0.015);
      og.gain.exponentialRampToValueAtTime(0.001, t+0.12);
      osc.connect(og); og.connect(AC.destination); osc.start(t); osc.stop(t+0.13);
    },
    place: ()=>{
      // ã‚¿ã‚¤ãƒ«ã‚’ç½®ãéŸ³: ã‚³ãƒ„ãƒƒã¨ã„ã†æ‰“æ’ƒéŸ³
      const osc = AC.createOscillator();
      const g = AC.createGain();
      osc.type='triangle'; osc.frequency.setValueAtTime(300,t); osc.frequency.exponentialRampToValueAtTime(80,t+0.12);
      g.gain.setValueAtTime(0.25*masterVolume,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
      osc.connect(g); g.connect(AC.destination); osc.start(t); osc.stop(t+0.13);
    },
    bonus: ()=>{
      // é€£ç•ªãƒœãƒ¼ãƒŠã‚¹: ä¸Šæ˜‡ã‚¢ãƒ«ãƒšã‚¸ã‚ª
      [523,659,784,1047].forEach((freq,i)=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sine'; osc.frequency.value=freq;
        const st=t+i*0.08;
        g.gain.setValueAtTime(0,st); g.gain.linearRampToValueAtTime(0.18*masterVolume,st+0.02);
        g.gain.linearRampToValueAtTime(0,st+0.1);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.12);
      });
    },
    discard: ()=>{
      // æ¨ã¦ã‚‹: ä½ã‚ã®ã‚·ãƒ¥ãƒƒã¨ã„ã†éŸ³
      const buf = AC.createBuffer(1, AC.sampleRate*0.1, AC.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5)*0.5;
      const src=AC.createBufferSource(); src.buffer=buf;
      const g=AC.createGain(); g.gain.setValueAtTime(0.12*masterVolume,t);
      const filt=AC.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=600;
      src.connect(filt); filt.connect(g); g.connect(AC.destination); src.start(t);
    },
    error: ()=>{
      // ã‚¨ãƒ©ãƒ¼: ä½ã„ãƒ–ã‚¶ãƒ¼2å›
      [0,0.12].forEach(delay=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sawtooth'; osc.frequency.value=120;
        const st=t+delay;
        g.gain.setValueAtTime(0.15*masterVolume,st); g.gain.linearRampToValueAtTime(0,st+0.08);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.09);
      });
    },
    effectcard: ()=>{
      // åŠ¹æœã‚«ãƒ¼ãƒ‰å‡ºç¾SE: ã‚­ãƒ©ã‚­ãƒ©ä¸Šæ˜‡éŸ³
      [0,0.07,0.14,0.21].forEach((delay,i)=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sine';
        osc.frequency.value=[523,659,784,1047][i];
        g.gain.setValueAtTime(0,t+delay);
        g.gain.linearRampToValueAtTime(0.12*masterVolume,t+delay+0.03);
        g.gain.exponentialRampToValueAtTime(0.001,t+delay+0.25);
        osc.connect(g); g.connect(AC.destination);
        osc.start(t+delay); osc.stop(t+delay+0.26);
      });
    },
    coin: ()=>{
      // ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—SE: ãƒãƒ£ãƒªãƒ³å›è»¢éŸ³
      [0,0.05,0.1,0.15,0.2,0.25].forEach((d,i)=>{
        const o=AC.createOscillator(); const g=AC.createGain();
        o.type='sine';
        o.frequency.value=1200-i*80;
        g.gain.setValueAtTime(0,t+d);
        g.gain.linearRampToValueAtTime(0.09*masterVolume,t+d+0.01);
        g.gain.exponentialRampToValueAtTime(0.001,t+d+0.12);
        o.connect(g); g.connect(AC.destination);
        o.start(t+d); o.stop(t+d+0.13);
      });
    },
    omaeno: ()=>{
      // ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©SE: æ§ãˆã‚ãªãƒãƒƒãƒ—éŸ³
      const o=AC.createOscillator(); const g=AC.createGain();
      o.type='sine'; o.frequency.setValueAtTime(440,t);
      o.frequency.linearRampToValueAtTime(660,t+0.08);
      g.gain.setValueAtTime(0.07*masterVolume,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+0.18);
      o.connect(g); g.connect(AC.destination);
      o.start(t); o.stop(t+0.19);
    },
    rouletteClick: ()=>{
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆSE: è»½ã„ã‚«ãƒãƒƒéŸ³
      const buf=AC.createBuffer(1,AC.sampleRate*0.03,AC.sampleRate);
      const d=buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,3)*0.3;
      const src=AC.createBufferSource(); src.buffer=buf;
      const g=AC.createGain(); g.gain.value=0.04*masterVolume;
      const hp=AC.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=2000;
      src.connect(hp); hp.connect(g); g.connect(AC.destination); src.start(t);
    },
    kousoku: ()=>{
      // é«˜é€Ÿå›è»¢SE: æ€¥ä¸Šæ˜‡â†’æ€¥é™ä¸‹ã®ãƒ”ãƒƒãƒï¼‹ã‚¦ã‚£ãƒ¼ãƒ³éŸ³
      const osc=AC.createOscillator(); const g=AC.createGain();
      osc.type='sawtooth';
      osc.frequency.setValueAtTime(80,t);
      osc.frequency.linearRampToValueAtTime(1600,t+0.18);
      osc.frequency.linearRampToValueAtTime(80,t+0.36);
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(0.18*masterVolume,t+0.05);
      g.gain.linearRampToValueAtTime(0,t+0.4);
      const lp=AC.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=2000;
      osc.connect(lp); lp.connect(g); g.connect(AC.destination);
      osc.start(t); osc.stop(t+0.42);
      // é€†å›è»¢ã‚’ç¤ºã™ãƒ”ãƒƒãƒé™ä¸‹éŸ³
      const osc2=AC.createOscillator(); const g2=AC.createGain();
      osc2.type='sine';
      osc2.frequency.setValueAtTime(800,t+0.3);
      osc2.frequency.linearRampToValueAtTime(200,t+0.7);
      g2.gain.setValueAtTime(0,t+0.3);
      g2.gain.linearRampToValueAtTime(0.12*masterVolume,t+0.35);
      g2.gain.linearRampToValueAtTime(0,t+0.75);
      osc2.connect(g2); g2.connect(AC.destination);
      osc2.start(t+0.3); osc2.stop(t+0.76);
    },
    donguri: ()=>{
      // ã©ã‚“ãã‚Šã“ã‚ã“ã‚SE: é‡ã„ãƒ‰ã‚¹ãƒ³ï¼‹ã²ã£ãã‚Šè¿”ã‚‹æ„Ÿè§¦
      // ãƒ‰ã‚¹ãƒ³ä½éŸ³
      const o1=AC.createOscillator(); const g1=AC.createGain();
      o1.type='sine'; o1.frequency.setValueAtTime(180,t);
      o1.frequency.exponentialRampToValueAtTime(40,t+0.3);
      g1.gain.setValueAtTime(0.2*masterVolume,t);
      g1.gain.exponentialRampToValueAtTime(0.001,t+0.35);
      o1.connect(g1); g1.connect(AC.destination); o1.start(t); o1.stop(t+0.36);
      // å›è»¢æ„Ÿã®ã‚ã‚‹ãƒ”ãƒƒãƒå¤‰å‹•
      [0.08,0.18,0.28].forEach((delay,i)=>{
        const o=AC.createOscillator(); const g=AC.createGain();
        o.type='triangle';
        o.frequency.setValueAtTime(300+i*80,t+delay);
        o.frequency.linearRampToValueAtTime(100+i*40,t+delay+0.12);
        g.gain.setValueAtTime(0,t+delay);
        g.gain.linearRampToValueAtTime(0.08*masterVolume,t+delay+0.02);
        g.gain.exponentialRampToValueAtTime(0.001,t+delay+0.14);
        o.connect(g); g.connect(AC.destination);
        o.start(t+delay); o.stop(t+delay+0.15);
      });
    },
    win: ()=>{
      // å‹åˆ©: ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
      const melody=[523,523,523,659,523,659,784];
      const times=[0,0.18,0.36,0.54,0.72,0.82,0.92];
      melody.forEach((freq,i)=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='square'; osc.frequency.value=freq;
        const st=t+times[i];
        g.gain.setValueAtTime(0,st); g.gain.linearRampToValueAtTime(0.15*masterVolume,st+0.02);
        g.gain.linearRampToValueAtTime(0,st+0.15);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.16);
      });
    },
    myturn: ()=>{
      // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹: çŸ­ã„ä¸Šæ˜‡2éŸ³
      [[523,0],[784,0.1]].forEach(([freq,delay])=>{
        const osc=AC.createOscillator(); const g=AC.createGain();
        osc.type='sine'; osc.frequency.value=freq;
        const st=t+delay;
        g.gain.setValueAtTime(0,st); g.gain.linearRampToValueAtTime(0.2*masterVolume,st+0.015);
        g.gain.linearRampToValueAtTime(0,st+0.1);
        osc.connect(g); g.connect(AC.destination); osc.start(st); osc.stop(st+0.11);
      });
    },
  };
  if(sounds[type]) sounds[type]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äººæ•°åˆ¥é…å¸ƒæšæ•°
function getHandBlind(count)  { return count <= 4 ? 17 : count === 5 ? 14 : 11; }
function getHandReveal(count) { return count <= 4 ? 5 : 4; }
function getHandSize(count)   { return getHandBlind(count) + getHandReveal(count); }

let G          = null;
let setupPhase = null;
let act        = null;
let insertAnim  = null; // {pi, hi} å·®ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡å¯¾è±¡
let swapAnim    = null; // {pi, hi} ã‚¹ãƒ¯ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡å¯¾è±¡
let donguriAnim = null; // {pi, hi} ã©ã‚“ãã‚Šã“ã‚ã“ã‚ã‚¢ãƒ‹ãƒ¡å¯¾è±¡

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRev(n) {
  // 1ã®ä½ãŒ0 â†’ é€†ã•ã«ã™ã‚‹ã¨å…ˆé ­0ã«ãªã‚‹ãŸã‚ç„¡åŠ¹
  if(n % 10 === 0) return null;
  const map={'0':'0','1':'1','6':'9','8':'8','9':'6'};
  const s=String(n);
  for(const c of s) if(!(c in map)) return null;
  const r=parseInt(s.split('').reverse().map(c=>map[c]).join(''));
  return r!==n?r:null;
}
function makeTile(n){return{num:n,rev:calcRev(n)};}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function ts(){const n=new Date();return`${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;}
function log(msg,cls=''){
  const lw=document.getElementById('logWrap');if(!lw)return;
  const d=document.createElement('div');d.className=`log-entry ${cls}`;
  d.innerHTML=`<span class="ts">${ts()}</span>${msg}`;
  // prepend so newest is at top
  lw.insertBefore(d,lw.firstChild);
  while(lw.children.length>4)lw.removeChild(lw.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME START (ãƒ›ã‚¹ãƒˆã®ã¿ hostStartGame() ã§å®Ÿè¡Œ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MASTER RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const inSetup=G&&G.playerSetups&&G.playerSetups.some(s=>!s.done);
  if(inSetup){setupPhase=true;renderSetup();}else{setupPhase=null;renderGame();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSetup(){
  document.getElementById('centerZone').style.display='none';
  document.getElementById('actionPanel').style.display='none';
  document.getElementById('phaseHint').style.display='';
  clearPlayerZones();

  // è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
  const myPi = myName ? G.players.findIndex(p=>p.name===myName) : 0;

  G.players.forEach((player,pi)=>{
    const sp = G.playerSetups[pi];
    const isMe = pi===myPi;
    const isDone = sp.done;
    const div=document.createElement('div');
    div.className=`player-zone${isMe?' active-player':''}`;

    let badge;
    if(isDone) badge=`<span class="badge badge-yellow">é…ç½®å®Œäº† âœ“</span>`;
    else if(isMe) badge=`<span class="badge badge-red">é…ç½®ä¸­ â€” ${sp.currentRevealIdx+1}æšç›® / ${player.revealTilesTotal}æš</span>`;
    else badge=`<span class="badge badge-muted">é…ç½®ä¸­â€¦</span>`;

    div.innerHTML=`
      <div class="player-header"><span class="player-name">${player.name}</span>${badge}</div>
      <div class="tile-row" id="tileRow${pi}"></div>
      ${isMe&&!isDone?`<div class="setup-panel">
        <div class="setup-panel-label">ä»Šé…ç½®ã™ã‚‹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ â†’ â†“ã‚¹ãƒ­ãƒƒãƒˆã«å·®ã—è¾¼ã‚€ï¼‰ï¼š</div>
        <div class="reveal-hand" id="revealHand${pi}"></div>
      </div>`:''}`;
    insertPlayerZone(div);

    // æ‰‹æœ­è¡¨ç¤ºï¼ˆgap slotã¤ãï¼‰
    const tileRow=div.querySelector(`#tileRow${pi}`);
    const showG=isMe&&!isDone&&sp.selectedInHand;
    for(let i=0;i<=player.hand.length;i++){
      const g=document.createElement('div');
      g.className=`gap-slot${showG?' droppable':''}`;
      g.textContent=showG?'â†“':'';
      if(showG){const gi=i;g.onclick=()=>insertRevealTile(pi,gi);}
      tileRow.appendChild(g);
      if(i<player.hand.length){
        const h=player.hand[i];
        const el=document.createElement('div');
        el.className=`tile ${h.revealed?'face-up':'face-down'}${h.tile&&h.tile.wild?' wild-tile':''}`;
        el.textContent=h.revealed?h.tile.num:'';
        if(insertAnim && insertAnim.pi===pi && insertAnim.hi===i){
          el.classList.add('just-inserted');
          insertAnim=null;
        }
        tileRow.appendChild(el);
      }
    }

    // è‡ªåˆ†ã®æ“ä½œãƒ‘ãƒãƒ«
    if(isMe&&!isDone){
      const curTile=player.revealTiles[sp.currentRevealIdx];
      const rh=div.querySelector(`#revealHand${pi}`);
      const useRev=sp.useRev===true;
      const displayNum=useRev&&curTile.rev?curTile.rev:curTile.num;
      const el=document.createElement('div');
      el.className=`tile face-up to-place${sp.selectedInHand?' src-selected':''}`;
      el.textContent=displayNum;
      el.title=curTile.rev?`é€†ã•ã§ä½¿ç”¨: ${curTile.rev}`:'';
      el.onclick=()=>{ ensureAC(); sp.selectedInHand=!sp.selectedInHand; syncToServer(); render(); };
      rh.appendChild(el);
      if(curTile.rev){
        const fb=document.createElement('button');
        fb.className='flip-btn';fb.style.marginLeft='8px';
        fb.textContent=useRev?`âŸ³ æ­£å‘ã (${curTile.num})`:`âŸ³ ã²ã£ãã‚Šè¿”ã™ (â†’${curTile.rev})`;
        fb.onclick=(e)=>{e.stopPropagation();ensureAC();sp.useRev=!sp.useRev;syncToServer();render();};
        rh.appendChild(fb);
      }
    }
  });

  const myPl=G.players[myPi];
  const mySp=G.playerSetups[myPi];
  const ph=document.getElementById('phaseHint');
  if(mySp.done){
    ph.textContent='âœ… ã‚ãªãŸã®é…ç½®ã¯å®Œäº†ã€‚ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦';
  }else{
    const cur=myPl.revealTiles[mySp.currentRevealIdx];
    ph.textContent=mySp.selectedInHand
      ?`ğŸ“Œ [${mySp.useRev&&cur.rev?cur.rev:cur.num}] ã‚’é¸æŠä¸­ã€‚â†“ ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å·®ã—è¾¼ã‚“ã§ãã ã•ã„ã€‚`
      :`ğŸ“Œ ã‚ªãƒ¬ãƒ³ã‚¸ã®ã‚¿ã‚¤ãƒ« [${cur.num}] ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚`;
  }
  const doneCount=G.playerSetups.filter(s=>s.done).length;
  document.getElementById('hdrTurn').textContent='SETUP';
  document.getElementById('hdrRound').textContent=`æº–å‚™å®Œäº† ${doneCount}/${G.players.length}äºº`;
  document.getElementById('hdrPool').textContent=`POOL: ${G.pool.length}`;
}

function insertRevealTile(pi, gapIdx){
  if(!G||!G.playerSetups)return;
  const sp=G.playerSetups[pi];
  if(!sp||!sp.selectedInHand||sp.done)return;
  if(myName && G.players[pi].name !== myName)return;

  const player=G.players[pi];
  const rawTile=player.revealTiles[sp.currentRevealIdx];
  const useRev=sp.useRev===true&&rawTile.rev!=null;
  const tile=useRev?{num:rawTile.rev,rev:rawTile.num}:rawTile;

  // â”€â”€ æ˜‡é †ãƒã‚§ãƒƒã‚¯: gapã®å·¦å³ã®è¡¨ã‚¿ã‚¤ãƒ«ã¨å¤§å°æ¯”è¼ƒ â”€â”€
  const hand=player.hand;
  let L=-Infinity, R=Infinity;
  for(let i=gapIdx-1;i>=0;i--){if(hand[i].revealed){L=hand[i].tile.num;break;}}
  for(let i=gapIdx;i<hand.length;i++){if(hand[i].revealed){R=hand[i].tile.num;break;}}
  if(tile.num<=L||tile.num>=R){
    playSound('error');
    log(`[${tile.num}] ã¯ã“ã“ã«ç½®ã‘ã¾ã›ã‚“ï¼ˆæ˜‡é †: ${L===- Infinity?'â€”':L} < ? < ${R===Infinity?'â€”':R}ï¼‰`,'error');
    return;
  }

  player.hand.splice(gapIdx,0,{tile,revealed:true});
  sp.selectedInHand=false;
  sp.useRev=false;
  insertAnim={pi, hi:gapIdx};
  playSound('place');
  log(`${player.name}: [${tile.num}] ã‚’ä½ç½® ${gapIdx+1} ã«æŒ¿å…¥ã€‚`);
  sp.currentRevealIdx++;
  if(sp.currentRevealIdx>=player.revealTilesTotal){
    delete player.revealTiles;
    sp.done=true;
    log(`${player.name} ã®é…ç½®å®Œäº†ï¼`,'highlight');
  }

  // å…¨å“¡å®Œäº†ãƒã‚§ãƒƒã‚¯
  if(G.playerSetups.every(s=>s.done)){
    delete G.playerSetups;
    setupPhase=null;
    G.currentPlayer=0;G.round=1;
    document.getElementById('actionPanel').style.display='';
    document.getElementById('centerZone').style.display='';
    log('å…¨å“¡ã®é…ç½®å®Œäº†ï¼ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼','highlight');
    syncToServer();
    render();return;
  }
  syncToServer();
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN GAME RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(){
  const cp=G.currentPlayer;
  document.getElementById('centerZone').style.display='';
  clearPlayerZones();

  // Player zones
  G.players.forEach((player,pi)=>{
    const isActive=pi===cp&&!G.gameOver;
    const div=document.createElement('div');
    div.className=`player-zone${isActive?' active-player':''}`;
    const revealed=player.hand.filter(h=>h.revealed).length;
    const blindCount=player.hand.filter(h=>!h.revealed).length;
    const pct=(revealed/G.handSize*100).toFixed(0);
    // è£ã‚¿ã‚¤ãƒ«ç§»å‹•å¯èƒ½æ¡ä»¶: è£ã‚¿ã‚¤ãƒ«>=1æš ã‹ã¤ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¾…æ©Ÿä¸­ã§ãªã„
    const isMyTurn=isActive&&(!myName||G.players[pi].name===myName);
    const canMoveBlind=isMyTurn&&!act&&!G.gameOver&&blindCount>=1;
    const canPass=isMyTurn&&!act&&!G.gameOver;
    const dir=G.direction||1;
    // turn-arrowã®æ–¹å‘: æ­£å›è»¢(1)=â†“(ä¸‹ã‹ã‚‰æ¬¡)ã€é€†å›è»¢(-1)=â†‘
    const arrowChar = dir===1 ? 'â†“' : 'â†‘';
    div.innerHTML=`
      <div class="turn-arrow${isActive?' active':''}"> ${arrowChar} </div>
      <div class="player-zone-inner">
      <div class="player-header">
        <span class="player-name">${player.name}</span>
        ${isActive?`<span class="badge badge-yellow">YOUR TURN</span>`:''}
        <span class="player-progress">${revealed}/${G.handSize}</span>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="tile-row" id="tileRow${pi}"></div>
      ${isActive?(()=>{
        const isMovePhase=act&&(act.phase==='awaitMoveBlind'||act.phase==='awaitMoveInsert');
        if(isMovePhase){
          return `<div class="player-action-bar">
            <button class="btn-sm accent" onclick="cancelAction()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>`;
        }
        const inEffect=isMyTurn&&act&&(
          act.phase==='awaitEffectCard'||
          act.phase==='awaitDonguri'||
          act.phase==='awaitLadyFirst'
        );
        if(act&&act.phase==='awaitEffectCard'&&isMyTurn){
          return `<div class="player-action-bar">
            <span style="font-size:0.6rem;color:var(--accent);letter-spacing:1px;animation:blink 1s ease infinite;">âœ¦ åŠ¹æœã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­â€¦</span>
          </div>`;
        }
        if(act&&act.phase==='awaitDonguri'&&isMyTurn){
          return `<div class="player-action-bar">
            <button class="btn-sm accent" onclick="cancelEffect()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <span style="font-size:0.6rem;color:#f0a030;letter-spacing:1px;">è¡¨ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ</span>
          </div>`;
        }
        if(act&&act.phase==='awaitDiscardBlind'&&isMyTurn){
          return `<div class="player-action-bar">
            <span style="font-size:0.6rem;color:#ffd700;letter-spacing:1px;">æ¨ã¦ã‚‹è£å‘ãã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
          </div>`;
        }
        if(act&&act.phase==='awaitIkkaPool'&&isMyTurn){
          return `<div class="player-action-bar">
            <button class="btn-sm accent" onclick="cancelEffect()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <span style="font-size:0.6rem;color:#ffd700;letter-spacing:1px;">å±±æœ­ã‹æ¨ã¦å ´ã®è£ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ</span>
          </div>`;
        }
        if(act&&act.phase==='awaitLadyFirst'&&isMyTurn){
          const others=G.players.filter((_,i)=>i!==G.currentPlayer);
          const btns=others.map(p=>`<button class="btn-sm" style="border-color:#e070f0;color:#e070f0;" onclick="executeLadyFirst('${p.name}')">${p.name}</button>`).join('');
          return `<div class="player-action-bar">${btns}<button class="btn-sm accent" onclick="cancelEffect()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>`;
        }
        return `<div class="player-action-bar">
          <button class="btn-sm" onclick="startMoveBlind()" ${canMoveBlind?'':'disabled'}>è£ã‚¿ã‚¤ãƒ«ç§»å‹•</button>
          <button class="btn-sm" onclick="passAction()" ${canPass?'':'disabled'}>ãƒ‘ã‚¹</button>
        </div>`;
      })():''}`;
    insertPlayerZone(div);

    const tileRow=div.querySelector(`#tileRow${pi}`);
    const showInsertGaps=isActive&&act&&act.phase==='awaitMoveInsert';
    const showWildGaps=isMyTurn&&isActive&&act&&act.phase==='awaitWildPlace';
    const movingIdx=act&&act.selectedHandIdx;

    // Build hand display â€” with gap slots interleaved when in insert mode
    if(showWildGaps){
      // ãƒ¯ã‚¤ãƒ«ãƒ‰é…ç½®ãƒ¢ãƒ¼ãƒ‰: å…¨ã‚¹ãƒ­ãƒƒãƒˆã«é…ç½®ãƒœã‚¿ãƒ³
      for(let gi=0;gi<=player.hand.length;gi++){
        const g=document.createElement('div');
        g.className='gap-slot wild-drop';
        g.textContent='â˜†';
        const _gi=gi;
        g.onclick=()=>placeWild(_gi);
        tileRow.appendChild(g);
        if(gi<player.hand.length){
          const h=player.hand[gi];
          const el=document.createElement('div');
          el.className=`tile ${h.revealed?'face-up':'face-down'}${h.tile&&h.tile.wild?' wild-tile':''}`;
          el.textContent=h.revealed?h.tile.num:'';
          tileRow.appendChild(el);
        }
      }
    } else if(showInsertGaps){
      // Render hand WITHOUT the moving tile (it's been logically lifted out)
      const handWithout=player.hand.filter((_,i)=>i!==movingIdx);
      for(let gi=0;gi<=handWithout.length;gi++){
        // Gap slot
        const gapBlocked=isGapBlockedForInsert(handWithout,gi);
        const g=document.createElement('div');
        g.className=`gap-slot${gapBlocked?' blocked':' droppable'}`;
        g.textContent=gapBlocked?'':'â†“';
        g.title=gapBlocked?'é€£ç•ªã®é–“ã«ã¯å·®ã—è¾¼ã‚ã¾ã›ã‚“':'ã“ã“ã«å·®ã—è¾¼ã‚€';
        if(!gapBlocked){const gi2=gi;g.onclick=()=>doMoveInsert(gi2);}
        tileRow.appendChild(g);
        // Tile
        if(gi<handWithout.length){
          const h=handWithout[gi];
          const el=document.createElement('div');
          el.className=`tile ${h.revealed?'face-up':'face-down'}`;
          el.textContent=h.revealed?h.tile.num:'';
          if(h.revealed&&h.tile.rev)el.title=`é€†ã•:${h.tile.rev}`;
          tileRow.appendChild(el);
        }
      }
    } else {
      player.hand.forEach((h,hi)=>{
        const canSelect=isActive&&!h.revealed&&act&&
          (act.phase==='awaitSwap'||act.phase==='awaitMoveBlind');
        const isSel=act&&act.selectedHandIdx===hi&&act.playerIdx===pi;
        const el=document.createElement('div');
        el.className=`tile ${h.revealed?'face-up':'face-down'}`;
        if(canSelect&&!h.revealed)el.classList.add('selectable');
        if(isSel)el.classList.add('selected');
        // ç½®ã‘ã‚‹ä½ç½®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆawaitSwapæ™‚ãƒ»è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ï¼‰
        if(isActive&&act&&act.phase==='awaitSwap'&&!h.revealed){
          const drawn=act.drawnTile;
          const fits=canFit(player.hand,hi,drawn.num)||(drawn.rev&&canFit(player.hand,hi,drawn.rev));
          if(fits) el.classList.add('can-place');
          else el.classList.add('cannot-place');
        }
        el.textContent=h.revealed?h.tile.num:'';
        if(h.revealed&&h.tile.rev)el.title=`é€†ã•:${h.tile.rev}`;
        if(canSelect&&!h.revealed)el.onclick=()=>clickHandTile(pi,hi);
        // ã‚¹ãƒ¯ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ï¼ˆè£ã‚¿ã‚¤ãƒ«äº¤æ›ã§è¡¨ã«ãªã£ãŸã‚¿ã‚¤ãƒ«ï¼‰
        if(swapAnim && swapAnim.pi===pi && swapAnim.hi===hi){
          el.classList.add('just-swapped-in');
          swapAnim=null;
        }
        // ã©ã‚“ãã‚Šã“ã‚ã“ã‚ã‚¢ãƒ‹ãƒ¡ï¼ˆè¡¨â†’è£è¿”ã—ã‚¢ãƒ‹ãƒ¡ï¼‰
        if(donguriAnim && donguriAnim.pi===pi && donguriAnim.hi===hi){
          el.classList.add('donguri-flipping');
          donguriAnim=null;
        }
        // å·®ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡ï¼ˆè£ã‚¿ã‚¤ãƒ«ç§»å‹•ï¼‰
        if(insertAnim && insertAnim.pi===pi && insertAnim.hi===hi){
          el.classList.add('just-inserted');
          insertAnim=null;
        }
        // ã©ã‚“ãã‚Šã“ã‚ã“ã‚: å…¨å“¡ã®è¡¨ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè‡ªåˆ†å«ã‚€ï¼‰
        if(act&&act.phase==='awaitDonguri'&&h.revealed){
          el.classList.add('donguri-target');
          const _pi=pi,_hi=hi;
          el.onclick=()=>executeDonguri(_pi,_hi);
        }
        tileRow.appendChild(el);
      });
    }
  });

  // â”€â”€ å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ â”€â”€
  const banner=document.getElementById('drawnBanner');
  const flipBtn=document.getElementById('btnFlipDrawn');
  const discardBtn=document.getElementById('btnCannotPlace');
  if(act&&act.drawnTile&&act.tileFlipped){
    const t=act.drawnTile;
    const isFlipped=act.useRev===true;
    banner.classList.remove('hidden');
    const disp=document.getElementById('drawnCardDisplay');
    // ã²ã£ãã‚Šè¿”ã— = revå€¤ã‚’æ•°å­—ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆCSSå›è»¢ãªã—ï¼‰
    disp.textContent=isFlipped&&t.rev?t.rev:t.num;
    disp.style.transform='';
    document.getElementById('drawnBannerSub').textContent=
      `${G.players[G.currentPlayer].name} ãŒå¼•ã„ãŸ â€” è£ã‚¿ã‚¤ãƒ«ã¨äº¤æ›ã—ã¦ãã ã•ã„`;
    document.getElementById('drawnBannerRev').textContent=
      t.rev?`é€†ã•ã§ä½¿ç”¨: ${t.rev}ï¼ˆç¾åœ¨: ${isFlipped?'é€†ã•':'æ­£å‘ã'}ï¼‰`:'';
    if(t.rev){flipBtn.style.display='';flipBtn.textContent=isFlipped?`âŸ³ æ­£å‘ã (${t.num})`:`âŸ³ ã²ã£ãã‚Šè¿”ã™ (â†’${t.rev})`;}
    else{flipBtn.style.display='none';}
    discardBtn.style.display='';
  }else{
    banner.classList.add('hidden');
    if(flipBtn)flipBtn.style.display='none';
    if(discardBtn)discardBtn.style.display='none';
  }

  // â”€â”€ å±±æœ­ã‚°ãƒªãƒƒãƒ‰ â”€â”€
  const poolGrid=document.getElementById('poolGrid');
  const poolCountBadge=document.getElementById('poolCountBadge');
  poolGrid.innerHTML='';
  poolCountBadge.textContent=`${G.pool.length} æš`;
  const isMyTurnNow=!myName||G.players[G.currentPlayer].name===myName;
  const canDraw=isMyTurnNow&&!act&&!G.gameOver;
  const canIkka=isMyTurnNow&&act&&act.phase==='awaitIkkaPool';
  G.pool.forEach((tile,pi2)=>{
    const el=document.createElement('div');
    el.className=`tile face-down${canDraw?' pool-tile':''}${canIkka?' ikka-target':''}`;
    if(canDraw)el.onclick=()=>flipPoolTile(pi2,el);
    if(canIkka){const _i=pi2;el.onclick=()=>ikkaSelectPool(_i);}
    poolGrid.appendChild(el);
  });

  // â”€â”€ æ¨ã¦å ´ â”€â”€ è£å‘ãï¼ˆfaceUpã®ã¿è¡¨å‘ãï¼‰ã€ã‚¯ãƒªãƒƒã‚¯ã§å–å¾—
  const discardScroll=document.getElementById('discardScroll');
  discardScroll.innerHTML='';
  // Show newest first (reverse)
  [...G.discard].reverse().forEach((entry,di)=>{
    const realIdx=G.discard.length-1-di;
    const wrapper=document.createElement('div');
    wrapper.className='discard-entry';
    const canTake=isMyTurnNow&&!act&&!G.gameOver;
    const canIkkaDiscard=isMyTurnNow&&act&&act.phase==='awaitIkkaPool'&&!entry.faceUp;
    const tileEl=document.createElement('div');
    const showFace=entry.faceUp===true;
    // è¡¨å‘ãã‚¿ã‚¤ãƒ«ãŒæ‰‹æœ­ã«ç½®ã‘ã‚‹ã‹ç¢ºèª
    let placeable=true;
    if(showFace&&canTake){
      const hand=G.players[G.currentPlayer].hand;
      const blindIdxList=hand.map((h,i)=>h.revealed?-1:i).filter(i=>i>=0);
      placeable=blindIdxList.some(hi=>{
        const t=entry.tile;
        return canFit(hand,hi,t.num)||(t.rev&&canFit(hand,hi,t.rev));
      });
    }
    const unplaceable=showFace&&canTake&&!placeable;
    tileEl.className=`tile ${showFace?'face-up':'face-down'}${canTake&&!unplaceable?' pool-tile':''}${unplaceable?' unplaceable':''}${canIkkaDiscard?' ikka-target':''}`;
    tileEl.textContent=showFace?entry.tile.num:'';
    if(showFace&&entry.tile.rev)tileEl.title=`é€†ã•:${entry.tile.rev}`;
    if(entry.isNew){
      const dot=document.createElement('div');dot.className='new-dot';
      tileEl.appendChild(dot);
    }
    if(canTake&&!unplaceable)tileEl.onclick=()=>takeDiscard(realIdx);
    if(canIkkaDiscard)tileEl.onclick=()=>ikkaSelectDiscard(realIdx);
    const who=document.createElement('div');who.className='discard-who';
    // è£å‘ãã¯èª°ãŒæ¨ã¦ãŸã‹è¡¨ç¤ºï¼ˆæ•°å­—ã¯ä¼ã›ã‚‹ï¼‰
    who.textContent=entry.discardedBy||'ï¼Ÿ';
    wrapper.appendChild(tileEl);
    wrapper.appendChild(who);
    discardScroll.appendChild(wrapper);
  });

  // â”€â”€ Action panel â”€â”€
  document.getElementById('actionPanel').style.display='';
  const hint=document.getElementById('actionHint');
  const ph=document.getElementById('phaseHint');
  ph.style.display='';

  if(!G.gameOver){
    const name=G.players[cp].name;
    if(!act){
      hint.textContent=`${name} ã®ã‚¿ãƒ¼ãƒ³ï¼šå±±æœ­ã‹ã‚‰å¼•ã / æ¨ã¦å ´ã‹ã‚‰å–ã‚‹ / æ‰‹æœ­ã®è£ã‚¿ã‚¤ãƒ«ç§»å‹• / ãƒ‘ã‚¹`;
      ph.textContent='';
    }else if(act.phase==='awaitPoolSelect'){
      hint.textContent='å±±æœ­ã®ã‚¿ã‚¤ãƒ«ã‚’1æšã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ãã£ã¦ãã ã•ã„';
      ph.textContent='ğŸ’¡ ã©ã®ã‚¿ã‚¤ãƒ«ã‚‚ä¸­èº«ã¯åŒã˜ç¢ºç‡ã€‚ç›´æ„Ÿã§é¸ã¼ã†ï¼';
    }else if(act.phase==='awaitSwap'){
      const useNum=act.useRev&&act.drawnTile.rev?act.drawnTile.rev:act.drawnTile.num;
      hint.textContent=`[${useNum}] ã¨ã—ã¦ä½¿ç”¨ â€” ç½®ãè£ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯`;
      ph.textContent=act.drawnTile.rev
        ?`ğŸ’¡ ã²ã£ãã‚Šè¿”ã™ãƒœã‚¿ãƒ³ã§å‘ãã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚ç½®ã‘ãªã‘ã‚Œã°ã€Œæ¨ã¦ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„`
        :`ğŸ’¡ ç½®ã‘ãªã„å ´åˆã¯å¼•ã„ãŸã‚¿ã‚¤ãƒ«æ¨ªã®ã€Œæ¨ã¦ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„`;
    }else if(act.phase==='awaitMoveBlind'){
      hint.textContent='ç§»å‹•ã™ã‚‹è£ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯';
      ph.textContent='ğŸ’¡ è£ã‚¿ã‚¤ãƒ«ã‚’åˆ¥ã®ä½ç½®ã«å·®ã—è¾¼ã¿ã¾ã™ã€‚é€£ç•ªã®é–“ã«ã¯å…¥ã‚Œã‚‰ã‚Œã¾ã›ã‚“ã€‚';
    }else if(act.phase==='awaitMoveInsert'){
      hint.textContent='å·®ã—è¾¼ã‚€ä½ç½®ã® â†“ ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆèµ¤ãƒãƒƒãƒã¯é€£ç•ªéš£æ¥ã®ãŸã‚NGï¼‰';
      ph.textContent='';
    }else if(act.phase==='awaitEffectCard'){
      hint.textContent=`${G.players[cp].name}: åŠ¹æœã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸï¼`;
      ph.textContent='ğŸ’¡ åŠ¹æœã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ä½¿ç”¨ã™ã‚‹ã‹é¸ã‚“ã§ãã ã•ã„';
    }else if(act.phase==='awaitDiscardBlind'){
      hint.textContent='ğŸ‘‘ ä¸€ã‹å…«ã‹è¡¨ â€” æ¨ã¦ã‚‹è£å‘ãã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯';
      ph.textContent='ğŸ’¡ å…‰ã£ã¦ã„ã‚‹è£å‘ãã‚¿ã‚¤ãƒ«ã‚’1æšé¸ã‚“ã§æ¨ã¦ã¾ã™ã€‚';
    }else if(act.phase==='awaitDonguri'){
      hint.textContent='ğŸŒ° ã©ã‚“ãã‚Šã“ã‚ã“ã‚ â€” å…‰ã‚‹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ';
      ph.textContent='ğŸ’¡ é¸ã‚“ã è¡¨ã‚¿ã‚¤ãƒ«ãŒè£è¿”ã•ã‚Œã¾ã™ï¼ˆè‡ªåˆ†ã®ã‚¿ã‚¤ãƒ«ã‚‚é¸ã¹ã¾ã™ï¼‰';
    }else if(act.phase==='awaitIkkaPool'){
      hint.textContent='ğŸ‘‘ ä¸€ã‹å…«ã‹ â€” é‡‘è‰²ã«å…‰ã‚‹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ';
      ph.textContent='ğŸ’¡ å±±æœ­ã¾ãŸã¯æ¨ã¦å ´ã®è£ã‚¿ã‚¤ãƒ«ã‚’1æšé¸ã‚“ã§æ‰‹æœ­ã«è¡¨å‘ãã§é…ç½®ã§ãã¾ã™';
    }else if(act.phase==='awaitLadyFirst'){
      hint.textContent='ğŸ’ƒ ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ â€” ã‚¿ãƒ¼ãƒ³ã‚’æ¸¡ã™ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ';
      ph.textContent='ğŸ’¡ é¸ã‚“ã ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚Šã¾ã™';
    }
  }else{
    hint.textContent='ã‚²ãƒ¼ãƒ çµ‚äº†';ph.textContent='';
  }

  document.getElementById('hdrTurn').textContent=G.gameOver?'GAME OVER':G.players[cp].name;
  document.getElementById('hdrRound').textContent=`ROUND ${G.round}`;
  const dirEl=document.getElementById('hdrDir');
  if(dirEl)dirEl.textContent=G.direction===-1?'â†º é€†å›è»¢':'â†»';
  document.getElementById('hdrPool').textContent=`POOL: ${G.pool.length+G.discard.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IN-GAME ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â“ª å¼•ã„ãŸã‚¿ã‚¤ãƒ«ã‚’ã²ã£ãã‚Šè¿”ã™ï¼ˆé€†ã•/æ­£å‘ãåˆ‡ã‚Šæ›¿ãˆï¼‰
function flipDrawnTile(){
  if(!act||act.phase!=='awaitSwap'||!act.drawnTile.rev)return;
  act.useRev=!act.useRev;
  render();
}

// â“ª ãƒ‘ã‚¹ï¼ˆã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
function passAction(){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  const cp=G.currentPlayer;
  // ã‚°ãƒ©ãƒ•ç”¨é€²æ—è¨˜éŒ²ï¼ˆãƒ‘ã‚¹æ™‚ã‚‚ç‚¹ã‚’æ‰“ã¤ï¼‰
  const _plPass=G.players[cp];
  if(_plPass&&_plPass.progressHistory){
    const _rv=_plPass.hand.filter(h=>h.revealed).length;
    _plPass.progressHistory.push([G.round,_rv]);
  }
  playSound('discard');
  log(`${G.players[cp].name}: ãƒ‘ã‚¹ã—ãŸã€‚`);
  nextTurn();syncToServer();render();
}

// â‘  å±±æœ­ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚ãã‚Šã‚¢ãƒ‹ãƒ¡ â†’ awaitSwap
function flipPoolTile(poolIdx, el){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  el.classList.add('flipping');
  act={phase:'awaitPoolSelect',drawnTile:null,playerIdx:G.currentPlayer,fromDiscard:false,tileFlipped:false};
  // ã‚¢ãƒ‹ãƒ¡å®Œäº†å¾Œã«ã‚¿ã‚¤ãƒ«ã‚’ã‚ãã£ã¦awaitSwapã¸
  setTimeout(()=>{
    const tile=G.pool.splice(poolIdx,1)[0];
    act={phase:'awaitSwap',drawnTile:tile,playerIdx:G.currentPlayer,fromDiscard:false,tileFlipped:true};
    G.discard.forEach(e=>e.isNew=false);
    playSound('draw');
    log(`${G.players[G.currentPlayer].name} ãŒå±±æœ­ã‹ã‚‰ [${tile.num}${tile.rev?'/'+tile.rev:''}] ã‚’ã‚ãã£ãŸï¼`,'highlight');
    syncToServer(); // G.act=awaitSwap ã‚’å…¨å“¡ã«é…ä¿¡
    render();
  },380);
}

// â‘¡ æ¨ã¦å ´ã‹ã‚‰å–å¾—ï¼ˆè£å‘ãã‚¿ã‚¤ãƒ«ã‚’ã‚ãã£ã¦æ‰‹ã«å…¥ã‚Œã‚‹ï¼‰
function takeDiscard(di){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  const entry=G.discard.splice(di,1)[0];
  G.discard.forEach(e=>e.isNew=false);
  // tile is now revealed to current player
  act={phase:'awaitSwap',drawnTile:entry.tile,playerIdx:G.currentPlayer,fromDiscard:true,tileFlipped:true};
  playSound('draw');
  log(`${G.players[G.currentPlayer].name} ãŒæ¨ã¦å ´ã‹ã‚‰ï¼ˆ${entry.discardedBy} ã®æ¨ã¦ãŸã‚¿ã‚¤ãƒ«ï¼‰[${entry.tile.num}] ã‚’å–ã£ãŸï¼`,'highlight');
  syncToServer();
  render();
}

// â‘¢ æ‰‹æœ­ã®è£ã‚¿ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯
function clickHandTile(pi,hi){
  if(!G||!act||setupPhase||pi!==G.currentPlayer)return;
  if(myName && G.players[pi].name !== myName)return;
  const player=G.players[G.currentPlayer];

  if(act.phase==='awaitSwap'){
    if(player.hand[hi].revealed){log('è¡¨å‘ãã®ã‚¿ã‚¤ãƒ«ã¨ã¯äº¤æ›ã§ãã¾ã›ã‚“ï¼','error');flashTile(pi,hi);return;}
    const drawn=act.drawnTile.num,rev=act.drawnTile.rev;
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸ã‚“ã å‘ãï¼ˆuseRevãƒ•ãƒ©ã‚°ï¼‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°è‡ªå‹•é¸æŠ
    let useNum;
    if(act.useRev&&rev){
      useNum=rev;
    } else {
      useNum=drawn;
      if(rev&&!canFit(player.hand,hi,drawn)&&canFit(player.hand,hi,rev))useNum=rev;
    }
    if(!canFit(player.hand,hi,useNum)){
      // é€†ã•å‘ãã‚‚è©¦ã™
      const altNum=act.useRev?drawn:rev;
      if(altNum&&canFit(player.hand,hi,altNum)){useNum=altNum;}
      else{playSound('error');log(`[${useNum}] ã¯ ${neighborStr(player.hand,hi)} ã®é–“ã«ç½®ã‘ã¾ã›ã‚“ï¼`,'error');flashTile(pi,hi);return;}
    }
    const removed=player.hand.splice(hi,1,{tile:{num:useNum,rev:null},revealed:true})[0];
    swapAnim={pi, hi};
    // äº¤æ›ã§å‡ºãŸè£ã‚¿ã‚¤ãƒ«ã¯è£å‘ãã§æ¨ã¦å ´ã¸
    G.discard.forEach(e=>e.isNew=false);
    playSound('discard');
    G.discard.push({tile:removed.tile,discardedBy:player.name,faceUp:false,isNew:true});
    const bonus=isConsecutive(player.hand,hi);
    const bonusLabel=bonus===2?'ğŸ‰ğŸ‰ ãƒ€ãƒ–ãƒ«é€£ç•ªï¼':'ğŸ‰ é€£ç•ªï¼';
    log(`${player.name}: [${useNum}] ã‚’é…ç½®ã€‚`,bonus?'highlight':'');
    act=null;G.act=null;player.turns++;
    // é”æˆé€²æ—ã‚’è¨˜éŒ²ï¼ˆ[ãƒ©ã‚¦ãƒ³ãƒ‰æ•°, é”æˆæšæ•°]ï¼‰Xè»¸=å…¨å“¡å…±é€šã®ãƒ©ã‚¦ãƒ³ãƒ‰
    const revealedNow=player.hand.filter(h=>h.revealed).length;
    if(!player.progressHistory) player.progressHistory=[[0,0]];
    player.progressHistory.push([G.round, revealedNow]);
    checkWin(G.currentPlayer);
    if(!G.gameOver){
      if(bonus>0){
        playSound('bonus');
        log(`${bonusLabel}${player.name} ãŒåŠ¹æœã‚«ãƒ¼ãƒ‰ã‚’å¼•ãï¼${bonus===2?'ï¼ˆä½¿ç”¨å¾Œã‚‚ã†1æšï¼ï¼‰':''}`, 'highlight');
        bonusEffect(pi,hi);
        act={phase:'awaitEffectCard',playerIdx:G.currentPlayer,doubleBonus:bonus===2,usedFirst:false};
        G.act=act;
        drawEffectCard(); // drawEffectCardå†…ã§effectCardsã‚»ãƒƒãƒˆå¾Œã«syncToServer
        return;
      } else {
        playSound('place');
        nextTurn();
      }
    }
    syncToServer();
    render();

  }else if(act.phase==='awaitMoveBlind'){
    if(player.hand[hi].revealed){log('è¡¨å‘ãã‚¿ã‚¤ãƒ«ã¯ç§»å‹•ã§ãã¾ã›ã‚“ï¼','error');return;}
    act.phase='awaitMoveInsert';act.selectedHandIdx=hi;
    log(`ä½ç½® ${hi+1} ã®è£ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã€‚å·®ã—è¾¼ã‚€å ´æ‰€ã® â†“ ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚`);render();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  åŠ¹æœã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EFFECT_CARDS = [
  {
    id:'donguri',
    name:'ã©ã‚“ãã‚Šã“ã‚ã“ã‚',
    desc:'ä»»æ„ã®è¡¨å‘ãã‚¿ã‚¤ãƒ«ã‚’1æšè£è¿”ã™ã€‚\nè‡ªåˆ†ã®æ‰‹æœ­ã‚‚å¯¾è±¡ã«ã§ãã‚‹ã€‚',
    color:'#f0a030',
  },
  {
    id:'mouikkai',
    name:'ã‚‚ã†ä¸€å›ï¼',
    desc:'ã‚‚ã†ä¸€åº¦è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚‹ã€‚',
    color:'#5ab4e0',
  },
  {
    id:'mouikkai', // 2æšç›®
    name:'ã‚‚ã†ä¸€å›ï¼',
    desc:'ã‚‚ã†ä¸€åº¦è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚‹ã€‚',
    color:'#5ab4e0',
  },
  {
    id:'tobashi',
    name:'ã²ã¨ã¤é£›ã°ã—ã¦ã¹ã£ã´ã‚“ã•ã‚“',
    desc:'æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç•ªã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã€‚',
    color:'#7de87a',
  },
  {
    id:'ladyfirst',
    name:'ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ',
    desc:'è‡ªåˆ†ä»¥å¤–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’1äººé¸æŠã€‚\nãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚‹ã€‚',
    color:'#e070f0',
  },
  {
    id:'kousokukaiten',
    name:'é«˜é€Ÿå›è»¢',
    desc:'å›è»¢é€Ÿåº¦ãŒé€Ÿã™ãã¦é€†å›è»¢ã«è¦‹ãˆã‚‹ï¼ˆé€†å›è»¢ã«ãªã‚‹ï¼‰',
    color:'#ff6060',
  },
  {
    id:'ichikabachika',
    name:'ä¸€ã‹å…«ã‹',
    desc:'ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ã€‚è¡¨ãŒå‡ºãŸã‚‰æ‰‹æœ­ã®è£å‘ãã‚¿ã‚¤ãƒ«ã‚’1æšæ¨ã¦ã‚‰ã‚Œã‚‹ã€‚\nè£ãŒå‡ºãŸã‚‰è‡ªåˆ†ã®è¡¨ã‚¿ã‚¤ãƒ«ãŒ1æšãƒ©ãƒ³ãƒ€ãƒ ã§è£è¿”ã•ã‚Œã‚‹ã€‚',
    color:'#ffd700',
  },
  {
    id:'omaenomono',
    name:'ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©',
    desc:'ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ‰‹æœ­ã‚’ã™ã¹ã¦äº¤æ›ã™ã‚‹ã€‚',
    color:'#ff8c00',
  },
];

let drawnEffectCard = null; // ç¾åœ¨å¼•ã„ã¦ã„ã‚‹åŠ¹æœã‚«ãƒ¼ãƒ‰

let drawnEffectCards = []; // 2æšå¼•ã„ãŸå€™è£œ

function drawEffectCard(){
  if(!act||act.phase!=='awaitEffectCard')return;
  if(!myName||G.players[G.currentPlayer].name===myName){
    // 2æšãƒ©ãƒ³ãƒ€ãƒ ã«å¼•ãï¼ˆé‡è¤‡ã‚ã‚Šï¼‰
    const idx1=Math.floor(Math.random()*EFFECT_CARDS.length);
    let idx2=Math.floor(Math.random()*EFFECT_CARDS.length);
    // ãªã‚‹ã¹ãé•ã†ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶ï¼ˆåŒã˜ãªã‚‰å†æŠ½é¸1å›ï¼‰
    if(idx2===idx1&&EFFECT_CARDS.length>1){
      idx2=(idx1+1+Math.floor(Math.random()*(EFFECT_CARDS.length-1)))%EFFECT_CARDS.length;
    }
    drawnEffectCards=[EFFECT_CARDS[idx1],EFFECT_CARDS[idx2]];
    drawnEffectCard=null; // é¸æŠå‰ã¯null
    act.effectCards=[drawnEffectCards[0].id,drawnEffectCards[1].id];
    G.act=act;
    syncToServer();
    openEffectCardChoiceModal(drawnEffectCards);
  }
}

function openEffectCardChoiceModal(cards){
  // å˜ä½“ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã—ã¦2æŠUIã‚’è¡¨ç¤º
  document.getElementById('effectCardInner').style.display='none';
  const container=document.getElementById('ecChoiceContainer');
  container.style.display='block';
  const wrap=document.getElementById('ecChoiceWrap');
  wrap.innerHTML=cards.map((card,i)=>`
    <div class="ec-card-choice" onclick="selectEffectCard(${i})"
      style="border-color:${card.color}22;">
      <div class="ec-card-label">âœ¦ EFFECT CARD</div>
      <div class="ec-card-name" style="color:${card.color};">${card.name}</div>
      <div class="ec-card-divider" style="background:${card.color};"></div>
      <div class="ec-card-desc">${card.desc}</div>
      <div class="ec-card-select">â–¶ é¸æŠã™ã‚‹</div>
    </div>
    
  `).join('');
  document.getElementById('effectCardModal').classList.add('show');
  playSound('effectcard');
}

function selectEffectCard(idx){
  drawnEffectCard=drawnEffectCards[idx];
  // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é¸æŠã‚’å…ˆã«sync
  if(act){
    act.selectedCard=drawnEffectCard.id;
    act.selectedCardIdx=idx;
    G.act=act;
    syncToServer();
  }
  drawnEffectCards=[];
  // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡
  const cards=document.querySelectorAll('#ecChoiceWrap .ec-card-choice');
  cards.forEach((el,i)=>{
    el.style.animation='none';
    void el.offsetWidth;
    if(i===idx) el.classList.add('selected');
    else el.classList.add('rejected');
  });
  // ãƒ¢ãƒ¼ãƒ€ãƒ«fadeout â†’ useEffectCard
  const modal=document.getElementById('effectCardModal');
  setTimeout(()=>{
    modal.classList.add('closing');
    setTimeout(()=>{
      modal.classList.remove('closing');
      closeEffectCardModal();
      useEffectCard();
    }, 700);
  }, 500);
}

// ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©: ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
function startRoulette(cp){
  const others=G.players.map((_,i)=>i).filter(i=>i!==cp);
  const finalIdx=others[Math.floor(Math.random()*others.length)];
  // syncã§å…¨å“¡ã«finalIdxã‚’é…ä¿¡
  if(act){
    act.phase='awaitRoulette';
    act.rouletteFinal=finalIdx;
    act.rouletteCP=cp;
    G.act=act;
    syncToServer();
  }
  runRouletteAnim(cp, finalIdx, ()=>{
    // äº¤æ›å®Ÿè¡Œ
    const myHand=G.players[cp].hand;
    G.players[cp].hand=G.players[finalIdx].hand;
    G.players[finalIdx].hand=myHand;
    log(`ğŸ˜ˆ ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©ï¼${G.players[cp].name} ã¨ ${G.players[finalIdx].name} ã®æ‰‹æœ­ãŒå…¥ã‚Œæ›¿ã‚ã£ãŸï¼`,'highlight');
    act=null;G.act=null;
    nextTurn();syncToServer();render();
  });
}

function runRouletteAnim(cp, finalIdx, onDone){
  const others=G.players.map((_,i)=>i).filter(i=>i!==cp);
  const modal=document.getElementById('rouletteModal');
  const track=document.getElementById('rouletteTrack');
  const result=document.getElementById('rouletteResult');
  result.textContent='';
  modal.classList.add('show');

  // ã‚¹ãƒ­ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆï¼ˆãƒ«ãƒ¼ãƒ—ç”¨ã«å¤šã‚ã«ï¼‰
  const items=[...others,...others,...others,...others];
  // finalIdxãŒæœ€å¾Œã®å‘¨å›ä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†èª¿æ•´
  const winnerPosInLast=others.indexOf(finalIdx)+others.length*2;
  track.innerHTML=items.map((pi,i)=>`
    <div class="roulette-item${i===winnerPosInLast?' winner':''}">${G.players[pi].name}</div>
  `).join('');

  // åˆæœŸä½ç½®: å…ˆé ­ã‹ã‚‰é–‹å§‹
  const itemH=72;
  track.style.transition='none';
  track.style.transform='translateY(0)';

  // ç›®æ¨™Y: winnerPosInLastç•ªç›®ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒä¸­å¤®ã«æ¥ã‚‹ä½ç½®
  const targetY=-(winnerPosInLast*itemH);

  // ã‚¢ãƒ‹ãƒ¡é–‹å§‹
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      // ã‚¯ãƒªãƒƒã‚¯éŸ³ã®ã¿ï¼ˆé™ã‹ï¼‰
      playSound('rouletteClick');
      track.style.transition=`transform 2.2s cubic-bezier(0.23,1,0.32,1)`;
      track.style.transform=`translateY(${targetY}px)`;
    });
  });

  setTimeout(()=>{
    result.textContent=`${G.players[finalIdx].name} ã¨äº¤æ›ï¼`;
    setTimeout(()=>{
      modal.classList.remove('show');
      onDone();
    },900);
  }, 2600);
}

// è¦³æˆ¦è€…: é¸æŠã‚¢ãƒ‹ãƒ¡ã‚’å†ç”Ÿã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function playSelectionAnim(idx){
  const cards=document.querySelectorAll('#ecChoiceWrap .ec-card-choice');
  if(!cards.length) return;
  cards.forEach((el,i)=>{
    el.style.animation='none';
    void el.offsetWidth;
    if(i===idx) el.classList.add('selected');
    else el.classList.add('rejected');
  });
  const modal=document.getElementById('effectCardModal');
  setTimeout(()=>{
    modal.classList.add('closing');
    setTimeout(()=>{
      modal.classList.remove('closing');
      closeEffectCardModal();
    }, 700);
  }, 500);
}

function openEffectCardModal(card){
  // 2æŠUIã‚’éš ã—ã¦å˜ä½“è¡¨ç¤º
  document.getElementById('ecChoiceContainer').style.display='none';
  const inner = document.getElementById('effectCardInner');
  inner.style.display='block';
  document.getElementById('ecName').textContent = card.name;
  document.getElementById('ecName').style.color = card.color;
  document.getElementById('ecDesc').textContent = card.desc;
  document.getElementById('ecButtons').innerHTML = `
    <button class="ec-use-btn" style="border-color:${card.color};color:${card.color};background:${card.color}18;"
      onclick="useEffectCard()">âœ¦ ç™ºå‹•ã™ã‚‹</button>
  `;
  inner.classList.remove('reveal');
  void inner.offsetWidth;
  inner.classList.add('reveal');
  document.getElementById('effectCardModal').classList.add('show');
  playSound('effectcard');
}

function closeEffectCardModal(){
  document.getElementById('effectCardModal').classList.remove('show');
  document.getElementById('effectCardInner').style.display='none';
  document.getElementById('ecChoiceContainer').style.display='none';
}

// åŠ¹æœã‚«ãƒ¼ãƒ‰ä½¿ç”¨å¾Œã®å‡¦ç†
function afterEffectCardUsed(){
  if(act&&act.doubleBonus&&!act.usedFirst){
    // ãƒ€ãƒ–ãƒ«é€£ç•ª: ã‚‚ã†1æšå¼•ã
    act.usedFirst=true;
    act.phase='awaitEffectCard';
    G.act=act;
    log(`âœ¨ ãƒ€ãƒ–ãƒ«é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ï¼ã‚‚ã†1æšå¼•ãï¼`,'highlight');
    drawEffectCard();
  } else {
    act=null;G.act=null;
    nextTurn();syncToServer();render();
  }
}

function useEffectCard(){
  closeEffectCardModal();
  if(!drawnEffectCard)return;
  const id = drawnEffectCard.id;
  const cp = G.currentPlayer;
  log(`âœ¦ ${G.players[cp].name} ãŒã€Œ${drawnEffectCard.name}ã€ã‚’ç™ºå‹•ï¼`,'highlight');
  const card = drawnEffectCard;
  drawnEffectCard=null;
  if(id==='mouikkai'){
    log(`ğŸ” ${G.players[cp].name} ã®ã‚¿ãƒ¼ãƒ³ãŒç¶šãï¼`,'highlight');
    if(act&&act.doubleBonus&&!act.usedFirst){
      // ãƒ€ãƒ–ãƒ«ãƒœãƒ¼ãƒŠã‚¹ä¸­â†’2æšç›®ã‚’å¼•ã
      afterEffectCardUsed();
    } else {
      // é€šå¸¸â†’ã‚¿ãƒ¼ãƒ³ç¶™ç¶šï¼ˆnextTurnã—ãªã„ï¼‰
      act=null;G.act=null;
      syncToServer();render();
    }
    return;
  } else if(id==='tobashi'){
    const dir=G.direction||1;
    const n=G.players.length;
    const skippedIdx=(cp+dir+n)%n;
    const skipped=G.players[skippedIdx].name;
    const nextIdx=(cp + dir*2 + n*2) % n;
    log(`â­ ${skipped} ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼`,'highlight');
    act=null;G.act=null;
    G.currentPlayer=nextIdx;
    syncToServer();render();
    return; // afterEffectCardUsedã‚’å‘¼ã°ãªã„
  } else if(id==='kousokukaiten'){
    G.direction=(G.direction||1)*-1;
    const dir=G.direction===1?'æ­£å›è»¢':'é€†å›è»¢';
    log(`ğŸŒ€ é«˜é€Ÿå›è»¢ï¼ã‚¿ãƒ¼ãƒ³é †ãŒ${dir}ã«ï¼`,'highlight');
    playSound('kousoku');
  } else if(id==='donguri'){
    act.phase='awaitDonguri';
    G.act=act;
    log(`ğŸŒ° ã©ã‚“ãã‚Šã“ã‚ã“ã‚ â€” è£è¿”ã™è¡¨ã‚¿ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„`,'highlight');
    syncToServer();render();
    return; // afterEffectCardUsedã¯executeDonguriå†…ã§å‘¼ã¶
  } else if(id==='ladyfirst'){
    act.phase='awaitLadyFirst';
    G.act=act;
    log(`ğŸ’ƒ ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ â€” ã‚¿ãƒ¼ãƒ³ã‚’æ¸¡ã™ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„`,'highlight');
    syncToServer();render();
    return;
  } else if(id==='ichikabachika'){
    const heads = Math.random()<0.5;
    act.coinResult = heads ? 'heads' : 'tails';
    act.phase = 'awaitCoinFlip';
    G.act=act;
    playSound('coin');
    syncToServer(); // å…¨å“¡ã«heads/tailsã‚’é…ä¿¡
    showCoinFlip(heads);
    return;
  } else if(id==='omaenomono'){
    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§ç›¸æ‰‹ã‚’æ±ºã‚ã‚‹
    startRoulette(cp);
    return;
  }
  // å³æ™‚å®Œäº†ã™ã‚‹åŠ¹æœã¯ã“ã“ã§ãƒ€ãƒ–ãƒ«ãƒœãƒ¼ãƒŠã‚¹åˆ¤å®š
  afterEffectCardUsed();
}

function cancelEffect(){
  if(!act)return;
  if(act.phase==='awaitDonguri'||act.phase==='awaitLadyFirst'||act.phase==='awaitIkkaPool'){
    act=null;G.act=null;
    nextTurn();syncToServer();render();
  }
}

// ä¸€ã‹å…«ã‹: ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—è¡¨ç¤º
function showCoinFlip(heads){
  const card = EFFECT_CARDS.find(c=>c.id==='ichikabachika');
  // 2æŠUIã‚’éš ã—ã¦å˜ä½“è¡¨ç¤º
  document.getElementById('ecChoiceContainer').style.display='none';
  const inner = document.getElementById('effectCardInner');
  inner.style.display='block';
  document.getElementById('ecName').textContent = card.name;
  document.getElementById('ecName').style.color = card.color;
  // ã‚³ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å·®ã—è¾¼ã‚€
  document.getElementById('ecDesc').innerHTML =
    `<div id="coinFlipDisplay" class="spinning">${heads?'ğŸ‘‘':'ğŸ’€'}</div>` +
    `<div style="font-size:1.1rem;font-weight:bold;color:${heads?'#ffd700':'#ff6060'};letter-spacing:2px;margin-bottom:8px;">${heads?'è¡¨ï¼HEADS':'è£ï¼TAILS'}</div>` +
    (heads
      ? 'å±±æœ­ã¾ãŸã¯æ¨ã¦å ´ã®è£ã‚¿ã‚¤ãƒ«ã‚’1æšé¸ã‚“ã§è¡¨ã«ã§ãã‚‹ã€‚'
      : 'è‡ªåˆ†ã®è¡¨ã‚¿ã‚¤ãƒ«ãŒãƒ©ãƒ³ãƒ€ãƒ ã§1æšè£è¿”ã•ã‚Œã‚‹â€¦');
  const isMyTurnNow=!myName||G.players[G.currentPlayer].name===myName;
  document.getElementById('ecButtons').innerHTML = isMyTurnNow
    ? (heads
        ? `<button class="ec-use-btn" style="border-color:#ffd700;color:#ffd700;background:#ffd70018;" onclick="executeIkkaHeads()">âœ¦ è£å‘ãã‚¿ã‚¤ãƒ«ã‚’æ¨ã¦ã‚‹</button>`
        : `<button class="ec-use-btn" style="border-color:#ff6060;color:#ff6060;background:#ff606018;" onclick="executeIkkaTails()">âœ¦ é‹å‘½ã‚’å—ã‘å…¥ã‚Œã‚‹</button>`)
    : `<div style="font-size:0.65rem;color:#555;letter-spacing:1px;text-align:center;">çµæœã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</div>`;
  inner.classList.remove('reveal');
  void inner.offsetWidth;
  inner.classList.add('reveal');
  document.getElementById('effectCardModal').classList.add('show');
}

// è¡¨: 2ã‚¿ãƒ¼ãƒ³è¿½åŠ ï¼ˆé€£ç•ªå«ã‚ã‚‹ã¨è¨ˆ3å›è¡Œå‹•ï¼‰
function executeIkkaHeads(){
  closeEffectCardModal();
  const cp=G.currentPlayer;
  const player=G.players[cp];
  const blindIdxs=player.hand.map((h,i)=>!h.revealed?i:-1).filter(i=>i>=0);
  if(blindIdxs.length===0){
    log(`ğŸ‘‘ è¡¨ï¼ã§ã‚‚è£å‘ãã‚¿ã‚¤ãƒ«ãŒãªã„ã®ã§ç„¡åŠ¹ã€‚`,'highlight');
    act=null;G.act=null;nextTurn();syncToServer();render();
    return;
  }
  log(`ğŸ‘‘ è¡¨ï¼${player.name} ãŒè£å‘ãã‚¿ã‚¤ãƒ«ã‚’1æšæ¨ã¦ã‚‰ã‚Œã‚‹ï¼`,'highlight');
  act.phase='awaitDiscardBlind';
  G.act=act;
  syncToServer();
  render();
}

// è¡¨: è£å‘ãã‚¿ã‚¤ãƒ«ã‚’1æšæ¨ã¦ã‚‹
function discardBlindTile(hi){
  if(!act||act.phase!=='awaitDiscardBlind')return;
  if(myName&&G.players[G.currentPlayer].name!==myName)return;
  const cp=G.currentPlayer;
  const player=G.players[cp];
  if(player.hand[hi]&&!player.hand[hi].revealed){
    const discarded=player.hand.splice(hi,1)[0];
    log(`ğŸ‘‘ ${player.name} ãŒè£å‘ãã‚¿ã‚¤ãƒ«[?]ã‚’æ¨ã¦ãŸï¼`,'highlight');
    act=null;G.act=null;
    nextTurn();syncToServer();render();
  }
}

// è£: è‡ªåˆ†ã®è¡¨ã‚¿ã‚¤ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§1æšè£è¿”ã™
function executeIkkaTails(){
  closeEffectCardModal();
  const cp=G.currentPlayer;
  const player=G.players[cp];
  const revealedIdxs=player.hand.map((h,i)=>h.revealed?i:-1).filter(i=>i>=0);
  if(revealedIdxs.length>0){
    const hi=revealedIdxs[Math.floor(Math.random()*revealedIdxs.length)];
    const flipped=player.hand[hi].tile;
    player.hand[hi]={tile:flipped,revealed:false};
    donguriAnim={pi:cp,hi};
    playSound('donguri');
    log(`ğŸ’€ è£ï¼${player.name} ã® [${flipped.num}] ãŒè£è¿”ã•ã‚ŒãŸï¼`,'highlight');
  } else {
    log(`ğŸ’€ è£ï¼ã§ã‚‚è¡¨ã‚¿ã‚¤ãƒ«ãŒãªã‹ã£ãŸã®ã§ç„¡åŠ¹ã€‚`,'highlight');
  }
  // è£â†’ã‚¿ãƒ¼ãƒ³çµ‚äº†
  act=null;G.act=null;
  nextTurn();syncToServer();render();
}

// ä¸€ã‹å…«ã‹: å±±æœ­ã‚¿ã‚¤ãƒ«ã‚’é¸ã‚“ã§è¡¨ã«ã™ã‚‹
function ikkaSelectPool(poolIdx){
  if(!act||act.phase!=='awaitIkkaPool')return;
  if(myName&&G.players[G.currentPlayer].name!==myName)return;
  const cp=G.currentPlayer;
  const player=G.players[cp];
  const tile=G.pool.splice(poolIdx,1)[0];
  // è‡ªåˆ†ã®è£ã‚¿ã‚¤ãƒ«ã®1æšã¨äº¤æ›ï¼ˆæœ€åˆã®è£ã‚¿ã‚¤ãƒ«ä½ç½®ã‚’è¡¨ã«ï¼‰
  const blindIdx=player.hand.findIndex(h=>!h.revealed);
  if(blindIdx>=0){
    // å…ƒã®è£ã‚¿ã‚¤ãƒ«ã‚’å±±æœ­ã«æˆ»ã—ã¦tileã‚’è¡¨ã«ã‚»ãƒƒãƒˆ
    G.pool.push(player.hand[blindIdx].tile);
    player.hand[blindIdx]={tile,revealed:true};
    swapAnim={pi:cp,hi:blindIdx};
    log(`ğŸ‘‘ ä¸€ã‹å…«ã‹æˆåŠŸï¼[${tile.num}] ã‚’æ‰‹æœ­ã«é…ç½®ï¼`,'highlight');
  } else {
    G.pool.push(tile); // è£ã‚¿ã‚¤ãƒ«ãªã‘ã‚Œã°æˆ»ã™
    log(`ğŸ‘‘ è£ã‚¿ã‚¤ãƒ«ãŒãªã„ã®ã§ç„¡åŠ¹ã€‚`,'highlight');
  }
  act=null;G.act=null;
  syncToServer();render();
}

// ä¸€ã‹å…«ã‹: æ¨ã¦å ´ã®è£ã‚¿ã‚¤ãƒ«ã‚’é¸ã‚“ã§è¡¨ã«ã™ã‚‹
function ikkaSelectDiscard(di){
  if(!act||act.phase!=='awaitIkkaPool')return;
  if(myName&&G.players[G.currentPlayer].name!==myName)return;
  const cp=G.currentPlayer;
  const player=G.players[cp];
  const entry=G.discard[di];
  if(!entry||entry.faceUp){playSound('error');return;} // è¡¨å‘ãã¯é¸ã¹ãªã„
  G.discard.splice(di,1);
  const blindIdx=player.hand.findIndex(h=>!h.revealed);
  if(blindIdx>=0){
    G.pool.push(player.hand[blindIdx].tile);
    player.hand[blindIdx]={tile:entry.tile,revealed:true};
    swapAnim={pi:cp,hi:blindIdx};
    log(`ğŸ‘‘ ä¸€ã‹å…«ã‹æˆåŠŸï¼æ¨ã¦å ´ã‹ã‚‰ [${entry.tile.num}] ã‚’æ‰‹æœ­ã«é…ç½®ï¼`,'highlight');
  } else {
    G.discard.push(entry);
    log(`ğŸ‘‘ è£ã‚¿ã‚¤ãƒ«ãŒãªã„ã®ã§ç„¡åŠ¹ã€‚`,'highlight');
  }
  act=null;G.act=null;
  syncToServer();render();
}

// ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰é…ç½®
function placeWild(gapIdx){
  if(!act||act.phase!=='awaitWildPlace')return;
  if(myName&&G.players[G.currentPlayer].name!==myName)return;
  const cp=G.currentPlayer;
  const player=G.players[cp];
  const wildTile={tile:{num:'â˜†',wild:true},revealed:true};
  player.hand.splice(gapIdx,0,wildTile);
  insertAnim={pi:cp,hi:gapIdx};
  playSound('bonus');
  log(`â­ ${player.name} ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆâ˜†ï¼‰ã‚’ä½ç½®${gapIdx+1}ã«é…ç½®ï¼`,'highlight');
  // é€£ç•ªãƒã‚§ãƒƒã‚¯
  const bonus=isConsecutive(player.hand,gapIdx);
  if(bonus>0){
    const bonusLabel=bonus===2?'ğŸ‰ğŸ‰ ãƒ€ãƒ–ãƒ«é€£ç•ªï¼ ':'ğŸ‰ é€£ç•ªï¼ ';
    log(`${bonusLabel}${player.name} ãŒåŠ¹æœã‚«ãƒ¼ãƒ‰ã‚’å¼•ãï¼`,'highlight');
    act={phase:'awaitEffectCard',playerIdx:cp,doubleBonus:bonus===2,usedFirst:false};
    G.act=act;
    syncToServer();render();
    drawEffectCard();
    return;
  }
  act=null;G.act=null;
  nextTurn();syncToServer();render();
}

// ã©ã‚“ãã‚Šã“ã‚ã“ã‚: è¡¨ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ è£è¿”ã™
function executeDonguri(targetPi, targetHi){
  if(!act||act.phase!=='awaitDonguri')return;
  if(myName&&G.players[G.currentPlayer].name!==myName)return;
  const defender=G.players[targetPi];
  if(!defender.hand[targetHi]||!defender.hand[targetHi].revealed){
    playSound('error');return;
  }
  const flipped=defender.hand[targetHi].tile;
  // ãƒ•ã‚§ãƒ¼ã‚º1: ãƒã‚¤ãƒ©ã‚¤ãƒˆ+æ‹¡å¤§ (350ms)
  act.donguriTarget={pi:targetPi,hi:targetHi,num:flipped.num};
  act.donguriPhase='highlight';
  G.act=act;
  syncToServer();
  render(); // donguri-selectedãŒä»˜ã
  playSound('effectcard');
  setTimeout(()=>{
    // ãƒ•ã‚§ãƒ¼ã‚º2: è£è¿”ã—ã‚¢ãƒ‹ãƒ¡
    defender.hand[targetHi]={tile:flipped,revealed:false};
    act.donguriPhase='flip';
    G.act=act;
    syncToServer();
    donguriAnim={pi:targetPi,hi:targetHi};
    playSound('donguri');
    log(`ğŸŒ° ã©ã‚“ãã‚Šã“ã‚ã“ã‚ï¼${G.players[G.currentPlayer].name} ãŒ ${defender.name} ã® [${flipped.num}] ã‚’è£è¿”ã—ãŸï¼`,'highlight');
    render();
    setTimeout(()=>{
      act=null;G.act=null;
      afterEffectCardUsed();syncToServer();render();
    }, 950);
  }, 400);
}

// ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã§æŒ‡å
function executeLadyFirst(targetName){
  if(!act||act.phase!=='awaitLadyFirst')return;
  if(myName&&G.players[G.currentPlayer].name!==myName)return;
  const targetIdx=G.players.findIndex(p=>p.name===targetName);
  if(targetIdx<0){playSound('error');return;}
  act=null;G.act=null;
  G.currentPlayer=targetIdx;
  log(`ğŸ’ƒ ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼${targetName} ã®ã‚¿ãƒ¼ãƒ³ã¸ï¼`,'highlight');
  // ãƒ€ãƒ–ãƒ«ãƒœãƒ¼ãƒŠã‚¹åˆ¤å®šï¼ˆãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã¯ã‚¿ãƒ¼ãƒ³ç§»å‹•æ¸ˆã¿ãªã®ã§nextTurnã—ãªã„ï¼‰
  const _wasDouble=act&&act.doubleBonus&&!act.usedFirst;
  if(_wasDouble){
    act.usedFirst=true;
    act.phase='awaitEffectCard';
    G.act=act;
    log(`âœ¨ ãƒ€ãƒ–ãƒ«é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ï¼ã‚‚ã†1æšå¼•ãï¼`,'highlight');
    syncToServer();
    drawEffectCard();
  } else {
    act=null;G.act=null;
    syncToServer();render();
  }
}

// syncå—ä¿¡æ™‚: åŠ¹æœã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å…¨å“¡ã«è¡¨ç¤º
function checkEffectCardSync(){
  if(!G||!G.act)return;
  const effectPhases=['awaitEffectCard','awaitDonguri','awaitLadyFirst','awaitIkkaPool','awaitCoinFlip','awaitRoulette','awaitDiscardBlind'];
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé¸æŠã‚¢ãƒ‹ãƒ¡ä¸­(closing)ãªã‚‰ä½•ã‚‚ã—ãªã„
  if(document.getElementById('effectCardModal').classList.contains('closing')) return;
  // awaitDonguri: å¯¾è±¡ç¢ºå®šå¾Œã€è¦³æˆ¦è€…ã‚‚ã‚¢ãƒ‹ãƒ¡
  if(G.act.phase==='awaitDonguri'&&G.act.donguriTarget){
    const isMe = !myName||G.players[G.currentPlayer].name===myName;
    if(!isMe){
      const {pi,hi}=G.act.donguriTarget;
      if(!donguriAnim){
        donguriAnim={pi,hi};
        playSound('donguri');
        render();
      }
    }
    return;
  }
  if(G.act.phase==='awaitEffectCard'){
    if(!(G.act.effectCards||G.act.effectCard)) return; // ã¾ã ã‚«ãƒ¼ãƒ‰æœªæ±ºå®š
    const isMe = !myName||G.players[G.currentPlayer].name===myName;
    if(isMe){
      // æœ¬äºº: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã¾ã é–‹ã„ã¦ã„ãªã‘ã‚Œã°é–‹ãï¼ˆãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
      const modal=document.getElementById('effectCardModal');
      if(!modal.classList.contains('show')){
        if(G.act.effectCards){
          const cards=G.act.effectCards.map(id=>EFFECT_CARDS.find(c=>c.id===id)).filter(Boolean);
          if(cards.length>=2) openEffectCardChoiceModal(cards);
        }
      }
      return;
    }
    // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    if(G.act.effectCards){
      const cards=G.act.effectCards.map(id=>EFFECT_CARDS.find(c=>c.id===id)).filter(Boolean);
      if(cards.length>0){
        const modal=document.getElementById('effectCardModal');
        // é¸æŠæ¸ˆã¿ã§ã‚¢ãƒ‹ãƒ¡æœªå†ç”Ÿãªã‚‰é¸æŠã‚¢ãƒ‹ãƒ¡ã‚’å®Ÿè¡Œ
        if(G.act.selectedCardIdx!=null){
          // é¸æŠæ¸ˆã¿: ã‚¢ãƒ‹ãƒ¡ä¸­ã§ãªã‘ã‚Œã°ã‚¢ãƒ‹ãƒ¡ã‚’å†ç”Ÿ
          if(!modal.classList.contains('show')){
            openEffectCardForSpectator(cards[0],cards[1]);
            setTimeout(()=>playSelectionAnim(G.act.selectedCardIdx), 300);
          } else if(!document.querySelector('.ec-card-choice.selected')){
            playSelectionAnim(G.act.selectedCardIdx);
          }
        } else if(!modal.classList.contains('show')){
          openEffectCardForSpectator(cards[0],cards[1]);
        }
      }
    } else {
      const card=EFFECT_CARDS.find(c=>c.id===G.act.effectCard);
      if(card){
        const modal=document.getElementById('effectCardModal');
        if(!modal.classList.contains('show')) openEffectCardForSpectator(card);
      }
    }
  } else if(G.act.phase==='awaitRoulette'&&G.act.rouletteFinal!=null){
    const isMe = !myName||G.players[G.currentPlayer].name===myName;
    if(!isMe){
      const rModal=document.getElementById('rouletteModal');
      if(!rModal.classList.contains('show')){
        runRouletteAnim(G.act.rouletteCP, G.act.rouletteFinal, ()=>{});
      }
    }
  } else if(!effectPhases.includes(G.act.phase)){
    const _modal=document.getElementById('effectCardModal');
    if(!_modal.classList.contains('closing')) closeEffectCardModal();
  }
}

function openEffectCardForSpectator(card1, card2){
  if(card2){
    // è¦³æˆ¦è€…ã«ã‚‚2æŠUIã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼‰
    document.getElementById('effectCardInner').style.display='none';
    const container=document.getElementById('ecChoiceContainer');
    container.style.display='block';
    document.getElementById('ecChoiceLabel').textContent='âœ¦ é¸æŠä¸­... âœ¦';
    const wrap=document.getElementById('ecChoiceWrap');
    wrap.innerHTML=[card1,card2].map((card,i)=>`
      <div class="ec-card-choice" style="border-color:${card.color}22;cursor:default;">
        <div class="ec-card-label">âœ¦ EFFECT CARD</div>
        <div class="ec-card-name" style="color:${card.color};">${card.name}</div>
        <div class="ec-card-divider" style="background:${card.color};"></div>
        <div class="ec-card-desc">${card.desc}</div>
      </div>
      
    `).join('');
  } else {
    document.getElementById('ecChoiceContainer').style.display='none';
    const inner=document.getElementById('effectCardInner');
    inner.style.display='block';
    document.getElementById('ecName').textContent=card1.name;
    document.getElementById('ecName').style.color=card1.color;
    document.getElementById('ecDesc').textContent=card1.desc;
    document.getElementById('ecButtons').innerHTML=
      `<div style="font-size:0.65rem;color:#555;text-align:center;letter-spacing:1px;">ç™ºå‹•ä¸­...</div>`;
    inner.classList.remove('reveal');
    void inner.offsetWidth;
    inner.classList.add('reveal');
  }
  document.getElementById('effectCardModal').classList.add('show');
  playSound('effectcard');
}

function cannotPlace(){
  if(!act||act.phase!=='awaitSwap')return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  G.discard.forEach(e=>e.isNew=false);
  // ç½®ã‘ãªã‹ã£ãŸã‚¿ã‚¤ãƒ«ã¯è¡¨å‘ãã§æ¨ã¦å ´ã¸ï¼ˆå…¨å“¡ã«æ•°å­—ãŒåˆ†ã‹ã‚‹ï¼‰
  G.discard.push({tile:act.drawnTile,discardedBy:G.players[G.currentPlayer].name,faceUp:true,isNew:true});
  playSound('discard');
  log(`${G.players[G.currentPlayer].name}: [${act.drawnTile.num}] ã¯ç½®ã‘ãš â†’ è¡¨å‘ãã§æ¨ã¦å ´ã¸ã€‚`,'error');
  // ã‚°ãƒ©ãƒ•ç”¨é€²æ—è¨˜éŒ²ï¼ˆç½®ã‘ãªã‹ã£ãŸæ™‚ã‚‚ç‚¹ã‚’æ‰“ã¤ï¼‰
  const _plCnt=G.players[G.currentPlayer];
  if(_plCnt&&_plCnt.progressHistory){
    const _rv=_plCnt.hand.filter(h=>h.revealed).length;
    _plCnt.progressHistory.push([G.round,_rv]);
  }
  act=null;G.act=null;nextTurn();syncToServer();render();
}

function startMoveBlind(){
  if(!G||setupPhase||act||G.gameOver)return;
  if(myName && G.players[G.currentPlayer].name !== myName)return;
  const cp=G.currentPlayer;
  const blindCount=G.players[cp].hand.filter(h=>!h.revealed).length;
  if(blindCount<1){log('ç§»å‹•ã§ãã‚‹è£ã‚¿ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚','error');return;}
  act={phase:'awaitMoveBlind',playerIdx:cp};
  log(`${G.players[cp].name}: è£ã‚¿ã‚¤ãƒ«ç§»å‹•ã‚’é¸æŠã€‚`);render();
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã‚¿ã‚¤ãƒ«æœªã‚ãã‚Šæ“ä½œ(ç§»å‹•ç³»)ã®ã¿
function cancelAction(){
  if(!act)return;
  if(act.phase==='awaitMoveBlind'||act.phase==='awaitMoveInsert'){
    log('è£ã‚¿ã‚¤ãƒ«ç§»å‹•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã€‚ã‚¿ãƒ¼ãƒ³ç¶™ç¶šã€‚');
    act=null;G.act=null;syncToServer();render();
  }
  // awaitSwap(ã‚ãã‚Šæ¸ˆã¿)ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸å¯
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVE-INSERT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// handWithout = hand array with the moving tile removed
// gi = gap index (0 = before first tile, N = after last tile)
// Blocked if the two revealed tiles immediately flanking this gap are consecutive
function isGapBlockedForInsert(handWithout, gi){
  // Blocked ONLY when the two PHYSICALLY ADJACENT tiles on each side are
  // both revealed AND consecutive (a blind tile in between breaks adjacency)
  const left  = gi > 0                    ? handWithout[gi-1] : null;
  const right = gi < handWithout.length   ? handWithout[gi]   : null;
  if(left && right && left.revealed && right.revealed){
    if(Math.abs(right.tile.num - left.tile.num) === 1) return true;
  }
  return false;
}

// Perform the actual insert: remove tile from originalIdx, splice into new gap position
function doMoveInsert(gapIdx){
  if(!act||act.phase!=='awaitMoveInsert')return;
  const player=G.players[G.currentPlayer];
  const from=act.selectedHandIdx;
  const movedTile=player.hand.splice(from,1)[0]; // remove tile
  // gapIdx was computed on handWithout (hand without the moving tile)
  // after removal, direct splice at gapIdx is correct
  player.hand.splice(gapIdx,0,movedTile);
  const newPos=gapIdx+1;
  insertAnim={pi:G.currentPlayer, hi:gapIdx};
  log(`${player.name}: è£ã‚¿ã‚¤ãƒ«ã‚’ä½ç½®${from+1}ã‹ã‚‰ä½ç½®${newPos}ã¸å·®ã—è¾¼ã‚“ã ã€‚`);
  // ã‚°ãƒ©ãƒ•ç”¨é€²æ—è¨˜éŒ²ï¼ˆè£ã‚¿ã‚¤ãƒ«ç§»å‹•æ™‚ã‚‚ç‚¹ã‚’æ‰“ã¤ï¼‰
  if(player.progressHistory){
    const _rv=player.hand.filter(h=>h.revealed).length;
    player.progressHistory.push([G.round,_rv]);
  }
  act=null;G.act=null;nextTurn();syncToServer();render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIC HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function canFit(hand,hi,num){
  let L=-Infinity,R=Infinity;
  for(let i=hi-1;i>=0;i--)if(hand[i].revealed){L=hand[i].tile.num;break;}
  for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){R=hand[i].tile.num;break;}
  return num>L&&num<R;
}
function neighborStr(hand,hi){
  let L='â€”',R='â€”';
  for(let i=hi-1;i>=0;i--)if(hand[i].revealed){L=hand[i].tile.num;break;}
  for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){R=hand[i].tile.num;break;}
  return`${L} ã¨ ${R}`;
}
function isConsecutive(hand,hi){
  // 0=ãªã—, 1=ç‰‡å´é€£ç•ª, 2=ä¸¡ã‚µã‚¤ãƒ‰é€£ç•ªï¼ˆãƒ€ãƒ–ãƒ«ï¼‰
  const cur=hand[hi].tile;
  // ç½®ã„ãŸã‚¿ã‚¤ãƒ«è‡ªä½“ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ â†’ è¡¨å‘ãã®éš£ãŒã‚ã‚Œã°é€£ç•ª
  if(cur.wild){
    let left=false,right=false;
    for(let i=hi-1;i>=0;i--)if(hand[i].revealed){left=true;break;}
    for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){right=true;break;}
    if(left&&right)return 2;
    if(left||right)return 1;
    return 0;
  }
  const curNum=cur.num;
  let left=false,right=false;
  for(let i=hi-1;i>=0;i--)if(hand[i].revealed){
    const t=hand[i].tile;
    if(t.wild||Math.abs(t.num-curNum)===1)left=true;
    break;
  }
  for(let i=hi+1;i<hand.length;i++)if(hand[i].revealed){
    const t=hand[i].tile;
    if(t.wild||Math.abs(t.num-curNum)===1)right=true;
    break;
  }
  if(left&&right)return 2;
  if(left||right)return 1;
  return 0;
}
function nextTurn(){
  const dir = G.direction||1; // 1=æ­£å›è»¢, -1=é€†å›è»¢
  const n = G.players.length;
  G.currentPlayer = (G.currentPlayer + dir + n) % n;
  if(G.currentPlayer===0) G.round++;
}
function checkWin(pi){
  const pl=G.players[pi];
  if(!pl.hand.every(h=>h.revealed))return;
  // ãƒ¯ã‚¤ãƒ«ãƒ‰è¾¼ã¿ã®æ˜‡é †ãƒã‚§ãƒƒã‚¯: ãƒ¯ã‚¤ãƒ«ãƒ‰ã¯å‰å¾Œã®æ•°å­—ã®é–“ã«åã¾ã‚Œã°OK
  const nums=pl.hand.map(h=>h.tile.wild?null:h.tile.num);
  for(let i=1;i<nums.length;i++){
    const prev=nums[i-1], cur=nums[i];
    if(prev===null||cur===null) continue; // ãƒ¯ã‚¤ãƒ«ãƒ‰éš£æ¥ã¯ã‚¹ã‚­ãƒƒãƒ—
    if(cur<=prev) return;
  }
  // ãƒ¯ã‚¤ãƒ«ãƒ‰ãŒæŒŸã¾ã‚Œã‚‹å ´åˆ: ä¸¡éš£ã®æ•°å­—ãŒæ˜‡é †ã‹ç¢ºèª
  for(let i=0;i<nums.length;i++){
    if(nums[i]!==null) continue;
    const lv=nums.slice(0,i).filter(v=>v!==null).at(-1);
    const rv=nums.slice(i+1).filter(v=>v!==null)[0];
    if(lv!=null&&rv!=null&&lv>=rv) return;
  }
  G.gameOver=true;G.winner=pi;
  playSound('win');
  log(`ğŸ† ${pl.name} ãŒå…¨ã‚¿ã‚¤ãƒ«ã‚’æ˜‡é †ã«ï¼COMPLETEï¼`,'highlight');
  showWin(pi);
}
function showWin(pi){
  // G.result ã‚’ç”Ÿæˆï¼ˆå…¨å“¡ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
  G.result = {
    winnerIdx: pi,
    players: G.players.map(p=>({
      name: p.name,
      turns: p.turns,
      revealed: p.hand.filter(h=>h.revealed).length,
      handSize: G.handSize,
      progressHistory: p.progressHistory || [[0,0]],
    })),
    votes: {}, // {playerName: 'rematch'|'leave'}
  };
  syncToServer();
  openResult();
}

function openResult(){
  if(!G||!G.result) return;
  const r = G.result;
  const winner = r.players[r.winnerIdx];
  const myVote = r.votes[myName] || null;

  // â”€â”€ ã‚°ãƒ©ãƒ•æç”» â”€â”€
  const W=460, H=220, PAD={top:20,right:24,bottom:38,left:40};
  const gw=W-PAD.left-PAD.right, gh=H-PAD.top-PAD.bottom;
  const handSize = r.players[0].handSize;
  // Xè»¸: å…¨å“¡ã®historyã‹ã‚‰æœ€å¤§ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å–å¾—
  const maxRound = Math.max(...r.players.flatMap(p=>p.progressHistory.map(pt=>pt[0])), 1);
  const colors = ['#e8d44d','#e05c4b','#5ab4e0','#7de87a','#e0a05c','#c05ae0'];

  const toX = round => PAD.left + (round/maxRound)*gw;
  const toY = v => PAD.top + gh - (v/handSize)*gh;

  // è»¸ç·š
  let svgLines = '';
  svgLines += `<line x1="${PAD.left}" y1="${PAD.top}" x2="${PAD.left}" y2="${PAD.top+gh}" stroke="#2a2a2a" stroke-width="1"/>`;
  svgLines += `<line x1="${PAD.left}" y1="${PAD.top+gh}" x2="${PAD.left+gw}" y2="${PAD.top+gh}" stroke="#2a2a2a" stroke-width="1"/>`;

  // Yè»¸ã‚°ãƒªãƒƒãƒ‰ï¼ˆ25%åˆ»ã¿ï¼‰
  [0,0.25,0.5,0.75,1].forEach(f=>{
    const yv = Math.round(f*handSize);
    const y = toY(yv);
    svgLines += `<line x1="${PAD.left}" y1="${y}" x2="${PAD.left+gw}" y2="${y}" stroke="#1e1e1e" stroke-width="1" stroke-dasharray="4,4"/>`;
    svgLines += `<text x="${PAD.left-6}" y="${y+4}" text-anchor="end" fill="#3a3a3a" font-size="9">${yv}</text>`;
  });

  // Xè»¸ã‚°ãƒªãƒƒãƒ‰ï¼ˆãƒ©ãƒ™ãƒ«æœ€å¤§5æœ¬ï¼‰
  const xStep = Math.ceil(maxRound/5);
  for(let r2=0; r2<=maxRound; r2+=xStep){
    const x=toX(r2);
    svgLines += `<line x1="${x}" y1="${PAD.top}" x2="${x}" y2="${PAD.top+gh}" stroke="#1a1a1a" stroke-width="1" stroke-dasharray="4,4"/>`;
    svgLines += `<text x="${x}" y="${PAD.top+gh+13}" text-anchor="middle" fill="#3a3a3a" font-size="9">${r2}</text>`;
  }

  // è»¸ãƒ©ãƒ™ãƒ«
  svgLines += `<text x="${W/2}" y="${H-2}" text-anchor="middle" fill="#444" font-size="9" letter-spacing="1">ROUND</text>`;
  svgLines += `<text x="10" y="${H/2}" text-anchor="middle" fill="#444" font-size="9" transform="rotate(-90,10,${H/2})">REVEALED</text>`;

  // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ˜ã‚Œç·š
  // historyã‚’ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã‚½ãƒ¼ãƒˆã—ã€åŒãƒ©ã‚¦ãƒ³ãƒ‰ã¯æœ€å¤§å€¤ã‚’ä½¿ã†
  let svgPaths = '';
  r.players.forEach((p,i)=>{
    const col = colors[i%colors.length];
    // progressHistoryã‚’ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚½ãƒ¼ãƒˆã€[0,0]ã¯ç¢ºå®Ÿã«å«ã‚€
    const hist = [...p.progressHistory].sort((a,b)=>a[0]-b[0]);
    // æŠ˜ã‚Œç·š: å„ç‚¹ã‚’é †ç•ªã«çµã¶ï¼ˆæ®µå·®ãŒè¦‹ãˆã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹•ããŒã‚ã‹ã‚‹ï¼‰
    const pts = hist.map(([rn,v])=>`${toX(rn).toFixed(1)},${toY(v).toFixed(1)}`).join(' ');
    svgPaths += `<polyline points="${pts}" fill="none" stroke="${col}" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round" opacity="0.9"/>`;
    // å„è¨˜éŒ²ç‚¹ã«å°ãƒ‰ãƒƒãƒˆ
    hist.forEach(([rn,v],di)=>{
      const cx=toX(rn), cy=toY(v);
      const isLast = di===hist.length-1;
      svgPaths += `<circle cx="${cx.toFixed(1)}" cy="${cy.toFixed(1)}" r="${isLast?5:2.5}" fill="${col}" opacity="${isLast?1:0.6}"/>`;
    });
    // å‹è€…ã«â˜…
    if(i===r.winnerIdx){
      const last=hist[hist.length-1];
      svgPaths += `<text x="${(toX(last[0])+7).toFixed(1)}" y="${(toY(last[1])-4).toFixed(1)}" fill="${col}" font-size="11" font-weight="bold">â˜…</text>`;
    }
  });

  // å‡¡ä¾‹
  let legend = r.players.map((p,i)=>`
    <div style="display:flex;align-items:center;gap:6px;font-size:0.62rem;color:#aaa;">
      <span style="width:14px;height:3px;background:${colors[i%colors.length]};border-radius:2px;display:inline-block;flex-shrink:0;"></span>
      <span style="${i===r.winnerIdx?'color:#e8d44d;font-weight:700;':''}">${p.name}${i===r.winnerIdx?' â˜…':''}</span>
      <span style="color:#555;margin-left:auto;">${p.turns}æ‰‹ Â· ${p.revealed}/${p.handSize}æš</span>
    </div>`).join('');

  // æŠ•ç¥¨çŠ¶æ³
  const totalPlayers = r.players.length;
  const voteCount = Object.keys(r.votes).length;
  const rematchCount = Object.values(r.votes).filter(v=>v==='rematch').length;
  let voteStatus = r.players.map(p=>{
    const v = r.votes[p.name];
    const icon = v==='rematch'?'ğŸ”':v==='leave'?'ğŸšª':'â€¦';
    return `<span style="font-size:0.65rem;color:${v?'#aaa':'#444'};margin-right:10px;">${icon} ${p.name}</span>`;
  }).join('');

  document.getElementById('resultContent').innerHTML = `
    <div style="font-family:'Bebas Neue',cursive;font-size:2.2rem;letter-spacing:5px;color:#e8d44d;margin-bottom:4px;">COMPLETE!</div>
    <div style="font-size:0.8rem;color:#aaa;margin-bottom:20px;letter-spacing:2px;">â€” ${winner.name} WINS â€”</div>

    <svg viewBox="0 0 ${W} ${H}" style="width:100%;border:1px solid #1e1e1e;border-radius:4px;background:#0a0a0a;display:block;margin-bottom:10px;">
      ${svgLines}${svgPaths}
    </svg>
    <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:20px;">${legend}</div>

    <div style="border-top:1px solid #1e1e1e;padding-top:16px;">
      ${myVote ? `
        <div style="font-size:0.65rem;color:#555;text-align:center;margin-bottom:12px;">æŠ•ç¥¨æ¸ˆã¿: ${myVote==='rematch'?'ğŸ” å†æˆ¦':'ğŸšª é€€å‡º'}</div>
      ` : `
        <div style="font-size:0.62rem;color:#555;text-align:center;margin-bottom:10px;letter-spacing:1px;">VOTE</div>
        <div style="display:flex;gap:8px;">
          <button class="btn primary" onclick="voteResult('rematch')" style="flex:1;padding:11px;font-size:0.75rem;letter-spacing:2px;">ğŸ” å†æˆ¦</button>
          <button class="btn" onclick="voteResult('leave')" style="flex:1;padding:11px;font-size:0.72rem;border-color:#444;color:#666;">ğŸšª é€€å‡º</button>
        </div>
      `}
      <div style="margin-top:10px;font-size:0.6rem;color:#444;text-align:center;">${voteCount}/${totalPlayers} æŠ•ç¥¨æ¸ˆã¿${rematchCount>0?' Â· å†æˆ¦ '+rematchCount+'ç¥¨':''}</div>
      <div style="margin-top:4px;">${voteStatus}</div>
    </div>
  `;

  const wasHidden = document.getElementById('resultOverlay').classList.contains('hidden');
  document.getElementById('resultOverlay').classList.remove('hidden');
  // å‹åˆ©ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã¯åˆå›è¡¨ç¤ºæ™‚ã®ã¿
  if(wasHidden){
    setTimeout(()=>spawnParticles(window.innerWidth/2, window.innerHeight/3, 40),300);
    setTimeout(()=>spawnParticles(window.innerWidth/3, window.innerHeight/2, 25),600);
    setTimeout(()=>spawnParticles(window.innerWidth*2/3, window.innerHeight/2, 25),800);
  }
  // å…¨å“¡æŠ•ç¥¨æ¸ˆã¿ã‹ç¢ºèªï¼ˆsyncå—ä¿¡æ™‚ã«ã‚‚åˆ¤å®šã•ã›ã‚‹ï¼‰
  checkVotes();
}

function voteResult(vote){
  if(!G||!G.result) return;
  G.result.votes[myName] = vote;
  syncToServer();
  openResult();
}

// æŠ•ç¥¨é›†è¨ˆï¼šopenResultæœ«å°¾ï¼†syncå—ä¿¡æ™‚ã«å‘¼ã°ã‚Œã‚‹
function checkVotes(){
  if(!G||!G.result) return;
  const r = G.result;
  const allVoted = r.players.every(p=>r.votes[p.name]);
  if(!allVoted) return;
  const allRematch = r.players.every(p=>r.votes[p.name]==='rematch');
  if(allRematch){
    if(amIHost) setTimeout(()=>rematch(), 500);
  } else {
    // é€€å‡ºç¥¨ã‚ã‚Š â†’ è‡ªåˆ†ãŒé€€å‡ºã‚’é¸ã‚“ã§ã„ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
    if(r.votes[myName]==='leave') setTimeout(()=>location.reload(), 600);
  }
}

// ãƒªãƒãƒƒãƒï¼šåŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ›ã‚¹ãƒˆãŒå³å†æˆ¦
function rematch(){
  if(!amIHost||!ws)return;
  // åå‰ãƒªã‚¹ãƒˆã‚’ä¿æŒã—ãŸã¾ã¾hostStartGameã‚’å†å®Ÿè¡Œ
  const names=shuffle(G.players.map(p=>p.name)); // ãƒªãƒãƒƒãƒã‚‚é †ç•ªã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const count=names.length;
  const nums=shuffle([...Array(100)].map((_,i)=>i+1));
  let idx=0;
  const HAND_BLIND=getHandBlind(count);
  const HAND_REVEAL=getHandReveal(count);
  const players=[];
  for(let p=0;p<count;p++){
    const hand=nums.slice(idx,idx+HAND_BLIND).map(n=>({tile:makeTile(n),revealed:false}));
    idx+=HAND_BLIND;
    const revealTiles=nums.slice(idx,idx+HAND_REVEAL).map(makeTile);
    idx+=HAND_REVEAL;
    revealTiles.sort((a,b)=>a.num-b.num);
    players.push({name:names[p],hand,revealTiles,revealTilesTotal:revealTiles.length,turns:0,progressHistory:[[0,0]]});
  }
  const playerSetups=players.map(()=>({currentRevealIdx:0,selectedInHand:false,useRev:false,done:false}));
  act=null;
  G={players,currentPlayer:0,pool:nums.slice(idx).map(makeTile),discard:[],round:1,gameOver:false,handSize:HAND_BLIND+HAND_REVEAL,playerSetups,direction:1};
  document.getElementById('resultOverlay').classList.add('hidden');
  ws.send(JSON.stringify({type:'start',G}));
}
function flashTile(pi,hi){
  const row=document.getElementById(`tileRow${pi}`);if(!row)return;
  const el=row.children[hi];if(!el)return;
  el.classList.add('invalid-flash');
  setTimeout(()=>el.classList.remove('invalid-flash'),400);
}

// é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚¿ã‚¤ãƒ«ç™ºå…‰ + ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
function bonusEffect(pi, hi){
  const row=document.getElementById(`tileRow${pi}`);
  if(!row)return;
  // æ‰‹æœ­ã«gapSlotãŒæ··ã˜ã‚‹ã®ã§realIndexã‚’ç®—å‡º
  const tiles=[...row.children].filter(el=>el.classList.contains('tile'));
  const el=tiles[hi];
  if(!el)return;
  el.classList.add('bonus-flash');
  setTimeout(()=>el.classList.remove('bonus-flash'),800);
  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  const rect=el.getBoundingClientRect();
  spawnParticles(rect.left+rect.width/2, rect.top+rect.height/2, 18);
}

function spawnParticles(x, y, count){
  const container=document.getElementById('particles');
  const colors=['#e8d44d','#f0e060','#fff8a0','#e8b040','#ffffff'];
  for(let i=0;i<count;i++){
    const p=document.createElement('div');
    p.className='particle';
    const angle=Math.random()*Math.PI*2;
    const dist=60+Math.random()*80;
    const dx=Math.cos(angle)*dist;
    const dy=Math.sin(angle)*dist - 40;
    const dur=0.4+Math.random()*0.5;
    p.style.cssText=`left:${x}px;top:${y}px;background:${colors[i%colors.length]};
      --dx:${dx}px;--dy:${dy}px;animation-duration:${dur}s;
      width:${4+Math.random()*5}px;height:${4+Math.random()*5}px;`;
    container.appendChild(p);
    setTimeout(()=>p.remove(), dur*1000+100);
  }
}

// ã‚¿ãƒ¼ãƒ³ç§»è¡ŒãƒãƒŠãƒ¼è¡¨ç¤º
let turnBannerTimer=null;
function showTurnBanner(name){
  const banner=document.getElementById('turnBanner');
  const nameEl=document.getElementById('turnBannerName');
  if(!banner||!nameEl)return;
  nameEl.textContent=name;
  banner.classList.add('show');
  if(turnBannerTimer)clearTimeout(turnBannerTimer);
  turnBannerTimer=setTimeout(()=>banner.classList.remove('show'),1400);
}

// â”€â”€ DOM HELPERS â”€â”€
function clearPlayerZones(){
  [...document.getElementById('gameWrap').querySelectorAll('.player-zone')].forEach(el=>el.remove());
}
function insertPlayerZone(div){
  const gw=document.getElementById('gameWrap');
  gw.insertBefore(div,document.getElementById('centerZone'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VERSION & CHANGELOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CURRENT_VERSION = 'beta 2.0.8';

const CHANGELOG = [
  {
    version: 'beta 2.0.8',
    date: '2026-02-28',
    items: [
      { text: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å·¦å´ã«å›è»¢æ–¹å‘çŸ¢å°ã‚’è¿½åŠ ', highlight: true },
      { text: 'ä¸€ã‹å…«ã‹ãƒ»è¡¨: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å‰Šé™¤â†’è£å‘ãã‚¿ã‚¤ãƒ«ã‚’1æšæ¨ã¦ã‚‹åŠ¹æœã«å¤‰æ›´', highlight: true },
      { text: 'ä¸€ã‹å…«ã‹: è¦³æˆ¦è€…ã®ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒæ¶ˆãˆãªã„ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
      { text: 'ã©ã‚“ãã‚Šã“ã‚ã“ã‚: é¸æŠæ™‚ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆæ‹¡å¤§â†’è£è¿”ã—ã®2æ®µéšã‚¢ãƒ‹ãƒ¡ã«å¤‰æ›´', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.7',
    date: '2026-02-28',
    items: [
      { text: 'ä¸€ã‹å…«ã‹ãƒ»è¡¨: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆâ˜†ï¼‰ç²å¾—ã«åŠ¹æœå¤‰æ›´', highlight: true },
      { text: 'ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰: æ‰‹æœ­ã®å¥½ããªä½ç½®ã«é…ç½®ã€é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ç™ºå‹•', highlight: true },
      { text: 'ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰: COMPLETEã®æ˜‡é †ãƒã‚§ãƒƒã‚¯ã«å¯¾å¿œ', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.6',
    date: '2026-02-27',
    items: [
      { text: 'ä¸€ã‹å…«ã‹: ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ãŒå…¨å“¡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ä¿®æ­£', highlight: true },
      { text: 'ä¸€ã‹å…«ã‹: è¦³æˆ¦è€…ãŒãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ãƒã‚°ä¿®æ­£', highlight: true },
      { text: 'ä¸€ã‹å…«ã‹: è¡¨ã§2å›è¡Œå‹•ã§ãã‚‹ã‚ˆã†ä¿®æ­£', highlight: true },
      { text: 'ã©ã‚“ãã‚Šã“ã‚ã“ã‚: ã‚«ãƒ¼ãƒ‰ãŒè£è¿”ã‚‰ãªã„ãƒã‚°ä¿®æ­£', highlight: true },
      { text: 'ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©: ã‚¹ãƒ­ãƒƒãƒˆå¼ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã«å¤‰æ›´ãƒ»å…¨å“¡è¡¨ç¤ºãƒ»SEé™ã‹ã«', highlight: true },
      { text: 'é«˜é€Ÿå›è»¢: ä½™è¨ˆãªã‚¿ãƒ¼ãƒ³çµ‚äº†ãŒå…¥ã‚‹ãƒã‚°ä¿®æ­£', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.5',
    date: '2026-02-27',
    items: [
      { text: 'ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—ãŒå…¨å“¡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£', highlight: true },
      { text: 'è£ãŒå‡ºãŸå¾Œã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹ã‚ˆã†ä¿®æ­£ï¼ˆç¶™ç¶šã—ã¦ã„ãŸãƒã‚°ä¿®æ­£ï¼‰', highlight: true },
      { text: 'é€†å›è»¢æ™‚ã®ã‚¹ã‚­ãƒƒãƒ—æ–¹å‘ã‚’ä¿®æ­£', highlight: true },
      { text: 'ã©ã‚“ãã‚Šã“ã‚ã“ã‚ã«ã‚¢ãƒ‹ãƒ¡å¼·åŒ–ãƒ»å¾…æ©Ÿè¿½åŠ ', highlight: true },
      { text: 'è¦³æˆ¦è€…ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§æ¶ˆãˆã‚‹ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
      { text: 'ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©ã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡ºã‚’è¿½åŠ ', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.4',
    date: '2026-02-27',
    items: [
      { text: 'é¸æŠå‰ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒæ¶ˆãˆã‚‹ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
      { text: 'ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—å¾Œã«é€²è¡Œä¸èƒ½ã«ãªã‚‹ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
      { text: 'ã‚‚ã†ä¸€å›ï¼ã§æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚‹ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.3',
    date: '2026-02-27',
    items: [
      { text: 'ã‚‚ã†ä¸€å›ï¼é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
      { text: 'åŠ¹æœã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.2',
    date: '2026-02-27',
    items: [
      { text: 'ä¸€ã‹å…«ã‹: ã‚³ã‚¤ãƒ³ãƒ•ãƒªãƒƒãƒ—åŠ¹æœã‚«ãƒ¼ãƒ‰è¿½åŠ ï¼ˆè¡¨â†’å±±æœ­/æ¨ã¦å ´å–å¾—ã€è£â†’è¡¨ã‚¿ã‚¤ãƒ«è£è¿”ã—ï¼‰', highlight: true },
      { text: 'ãŠå‰ã®ã‚‚ã®ã¯ä¿ºã®ç‰©: ãƒ©ãƒ³ãƒ€ãƒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ‰‹æœ­å…¨äº¤æ›ã‚«ãƒ¼ãƒ‰è¿½åŠ ', highlight: true },
    ]
  },
  {
    version: 'beta 2.0.1',
    date: '2026-02-27',
    items: [
      { text: 'åŠ¹æœã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå…¨å“¡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«', highlight: true },
      { text: 'ã‚¹ã‚­ãƒƒãƒ—å»ƒæ­¢: åŠ¹æœã‚«ãƒ¼ãƒ‰ã¯å¿…ãšç™ºå‹•', highlight: true },
      { text: 'ä¸¡ã‚µã‚¤ãƒ‰é€£ç•ªï¼ˆãƒ€ãƒ–ãƒ«ï¼‰ã§åŠ¹æœã‚«ãƒ¼ãƒ‰ã‚’2æšå¼•ã‘ã‚‹', highlight: true },
      { text: 'é«˜é€Ÿå›è»¢: ã‚¿ãƒ¼ãƒ³é †ãŒé€†å›è»¢ã«ãªã‚‹åŠ¹æœã‚«ãƒ¼ãƒ‰è¿½åŠ ', highlight: true },
      { text: 'ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚¿ãƒ¼ãƒ³æ–¹å‘ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆâ†» / â†ºï¼‰è¿½åŠ ' },
      { text: 'é«˜é€Ÿå›è»¢æ™‚ã®nextTurnãŒæ–¹å‘ã«å¯¾å¿œ' },
    ]
  },
  {
    version: 'beta 2.0.0',
    date: '2026-02-27',
    items: [
      { text: 'åŠ¹æœã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ï¼ˆé€£ç•ªé”æˆã§ãƒ©ãƒ³ãƒ€ãƒ ã«1æšå¼•ãï¼‰', highlight: true },
      { text: 'ã©ã‚“ãã‚Šã“ã‚ã“ã‚: ä»»æ„ã®è¡¨ã‚¿ã‚¤ãƒ«ã‚’è£è¿”ã™ï¼ˆæ´¾æ‰‹ã‚¢ãƒ‹ãƒ¡+SEï¼‰', highlight: true },
      { text: 'ã‚‚ã†ä¸€å›ï¼Ã—2: ã‚‚ã†ä¸€åº¦è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³', highlight: true },
      { text: 'ã²ã¨ã¤é£›ã°ã—ã¦ã¹ã£ã´ã‚“ã•ã‚“: æ¬¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—', highlight: true },
      { text: 'ãƒ¬ãƒ‡ã‚£ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ: ä»»æ„ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¿ãƒ¼ãƒ³ã‚’æ¸¡ã™', highlight: true },
      { text: 'æ—§ãƒ»è¬åœ‹é©šå¤©æŒãƒ»awaitBonusãƒ•ãƒ­ãƒ¼å»ƒæ­¢', },
    ]
  },
  {
    version: 'beta 1.8.2',
    date: '2026-02-27',
    items: [
      { text: 'è¬åœ‹é©šå¤©æŒï¼šé€£ç•ªé”æˆæ™‚ã«ç›¸æ‰‹ã®è¡¨ã‚¿ã‚¤ãƒ«ã‚’å±±æœ­ã«æˆ»ã™å¦¨å®³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä½¿ç”¨å¾Œã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰', highlight: true },
      { text: 'ã‚°ãƒ©ãƒ•æ”¹å–„ï¼šãƒ‘ã‚¹ãƒ»ç½®ã‘ãªã„ãƒ»è£ã‚¿ã‚¤ãƒ«ç§»å‹•æ™‚ã‚‚é€²æ—ç‚¹ã‚’è¨˜éŒ²', highlight: true },
      { text: 'ãƒ‰ãƒ­ãƒ¼éŸ³ã‚’æ¥µã‚ã¦ã‚½ãƒ•ãƒˆãªéŸ³ã«å†èª¿æ•´', highlight: true },
    ]
  },
  {
    version: 'beta 1.8.1',
    date: '2026-02-27',
    items: [
      { text: 'ãƒ‰ãƒ­ãƒ¼SEã‚’æŸ”ã‚‰ã‹ã„éŸ³ã«å¤‰æ›´', highlight: true },
      { text: 'ãƒªã‚¶ãƒ«ãƒˆã‚°ãƒ©ãƒ•ä¿®æ­£: Xè»¸ã‚’ãƒ©ã‚¦ãƒ³ãƒ‰å…±é€šè»¸ã«ã€å„ç‚¹ã‚’è¨˜éŒ²', highlight: true },
      { text: 'å…¨å“¡å†æˆ¦æŠ•ç¥¨ã—ã¦ã‚‚æ¬¡ã‚²ãƒ¼ãƒ ã«é€²ã¾ãªã„ãƒã‚°ã‚’ä¿®æ­£', highlight: true },
      { text: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨è¨˜ã‚’ beta X.X.X å½¢å¼ã«å¤‰æ›´' },
    ]
  },
  {
    version: 'beta 1.8.0',
    date: '2026-02-27',
    items: [
      { text: 'ãƒªã‚¶ãƒ«ãƒˆç”»é¢ï¼šé€²æ—ã‚°ãƒ©ãƒ•ãƒ»å…¨å“¡æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ ', highlight: true },
      { text: 'å†æˆ¦/é€€å‡ºã®æŠ•ç¥¨ãŒå…¨å“¡ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ' },
      { text: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ—¥ä»˜ã‚’ YYYY-MM-DD å½¢å¼ã«å¤‰æ›´' },
    ]
  },
  {
    version: 'beta 1.7.0',
    date: '2026-02-27',
    items: [
      { text: 'ã‚¿ã‚¤ãƒ«å·®ã—è¾¼ã¿ãƒ»äº¤æ›ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ', highlight: true },
      { text: 'ãƒ­ã‚´é…è‰²å¤‰æ›´ï¼ˆNUMé»„ / LETTOèµ¤ï¼‰', highlight: true },
      { text: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é †ã‚’ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«', highlight: true },
      { text: 'é”æˆç‡ï¼ˆ%ï¼‰è¡¨ç¤ºã‚’å‰Šé™¤ã€æšæ•°ã®ã¿ã«æ•´ç†' },
    ]
  },
  {
    version: 'beta 1.6.0',
    date: '2026-02-26',
    items: [
      { text: 'ç½®ã‘ã‚‹ä½ç½®ã‚’ã‚°ãƒªãƒ¼ãƒ³ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º', highlight: true },
      { text: 'é€£ç•ªé”æˆæ™‚ã«ç™ºå…‰ï¼‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ', highlight: true },
      { text: 'ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ãƒãƒŠãƒ¼æ¼”å‡ºè¿½åŠ ', highlight: true },
      { text: 'ãƒªãƒãƒƒãƒæ©Ÿèƒ½ï¼ˆåŒãƒ¡ãƒ³ãƒãƒ¼ã§å³å†æˆ¦ï¼‰', highlight: true },
      { text: 'å‹åˆ©æ™‚ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ¼”å‡º' },
    ]
  },
  {
    version: 'beta 1.5.0',
    date: '2026-02-26',
    items: [
      { text: 'ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œSEã‚’å…¨å“¡ã«é…ä¿¡', highlight: true },
      { text: 'è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å°‚ç”¨SEè¿½åŠ ', highlight: true },
      { text: 'WebSocketè‡ªå‹•å†æ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãï¼‰', highlight: true },
      { text: 'Heartbeat pingã§ã‚¢ã‚¤ãƒ‰ãƒ«åˆ‡æ–­é˜²æ­¢' },
      { text: 'å†æ¥ç¶šå¾Œã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹è‡ªå‹•å¾©å…ƒï¼ˆresyncï¼‰' },
    ]
  },
  {
    version: 'beta 1.4.0',
    date: '2026-02-25',
    items: [
      { text: 'æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã‚’å…¨å“¡åŒæ™‚é€²è¡Œã«å¤‰æ›´', highlight: true },
      { text: 'æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã®æ˜‡é †ãƒã‚§ãƒƒã‚¯ä¿®æ­£' },
      { text: 'SEå…¨èˆ¬: masterVolumeã§éŸ³é‡èª¿æ•´å¯¾å¿œ' },
      { text: 'ä»–äººã®ã‚¿ãƒ¼ãƒ³ã§ã®æ“ä½œã‚’è¡¨ç¤ºãƒ¬ãƒ™ãƒ«ã§ç„¡åŠ¹åŒ–' },
    ]
  },
  {
    version: 'beta 1.3.0',
    date: '2026-02-25',
    items: [
      { text: 'WebAudio SEã‚¨ãƒ³ã‚¸ãƒ³è¿½åŠ ï¼ˆå¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰', highlight: true },
      { text: 'ã‚ãã‚‹ãƒ»é…ç½®ãƒ»é€£ç•ªãƒ»æ¨ã¦ã‚‹ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»å‹åˆ©ã®SE' },
      { text: 'ä»–äººã®ã‚¿ã‚¤ãƒ«æ“ä½œé˜²æ­¢ã‚¬ãƒ¼ãƒ‰' },
    ]
  },
  {
    version: 'beta 1.2.0',
    date: '2026-02-24',
    items: [
      { text: 'G.actã‚’ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§åŒæœŸï¼ˆã‚ãã‚ŠçŠ¶æ…‹ãŒå…¨å“¡ã«è¦‹ãˆã‚‹ï¼‰', highlight: true },
      { text: 'WebSocketã‚¨ãƒ©ãƒ¼/ã‚¯ãƒ­ãƒ¼ã‚ºãƒãƒ³ãƒ‰ãƒ©æ•´ç†' },
    ]
  },
  {
    version: 'beta 1.1.0',
    date: '2026-02-24',
    items: [
      { text: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å°‚ç”¨ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒ–ï¼ˆPartyKitï¼‰', highlight: true },
      { text: 'ãƒ­ãƒ“ãƒ¼/å¾…åˆå®¤ã‚·ã‚¹ãƒ†ãƒ ', highlight: true },
      { text: 'ãƒ›ã‚¹ãƒˆåˆ¶å¾¡ã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ é–‹å§‹' },
      { text: 'NUMERETTO â†’ NUMLETTO ã«æ”¹å' },
    ]
  },
  {
    version: 'beta 1.0.0',
    date: '2026-02-23',
    items: [
      { text: 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ãƒƒãƒˆã‚·ãƒ¼ãƒˆç‰ˆãƒªãƒªãƒ¼ã‚¹', highlight: true },
      { text: '2ã€œ6äººå¯¾å¿œã€è£ã‚¿ã‚¤ãƒ«ãƒ»é€£ç•ªãƒœãƒ¼ãƒŠã‚¹ãƒ»æ‰‹ç•ªäº¤ä»£' },
      { text: 'åè»¢ã‚¿ã‚¤ãƒ«(1/6/8/9)ã€ç›²ç›®ã‚¹ãƒ¯ãƒƒãƒ—ã€æ¨ã¦å ´ã‚·ã‚¹ãƒ†ãƒ ' },
    ]
  },
];

function openChangelog(){
  const content = document.getElementById('changelogContent');
  content.innerHTML = CHANGELOG.map((v,i) => `
    <div class="cl-version">
      <div class="cl-version-head">
        <span class="cl-ver-num">${v.version}</span>
        <span class="cl-ver-date">${v.date}</span>
        ${i===0 ? '<span class="cl-ver-current">CURRENT</span>' : ''}
      </div>
      <ul class="cl-items">
        ${v.items.map(item =>
          `<li class="${item.highlight?'highlight':''}">${item.text}</li>`
        ).join('')}
      </ul>
    </div>
  `).join('');
  document.getElementById('changelogOverlay').classList.add('show');
}

function closeChangelog(){
  document.getElementById('changelogOverlay').classList.remove('show');
}

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æ›´æ–°
function initVersion(){
  document.querySelectorAll('.version-badge, #hdrVersion').forEach(el => {
    el.textContent = CURRENT_VERSION;
  });
}

document.addEventListener("DOMContentLoaded", initVersion);
initVersion();
</script>
</body>
</html>
